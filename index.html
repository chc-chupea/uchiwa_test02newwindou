<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Myã†ã¡ã‚ - ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <!-- æ¨ã—æ´»ã«ã´ã£ãŸã‚Šãªãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
  <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=DotGothic16&family=Kaisei+Tokumin&family=Train+One&display=swap" rel="stylesheet">
  <style>
    /* å…¨ä½“çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      font-family: 'Arial', sans-serif; /* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
      text-align: center;
      background: linear-gradient(135deg, #f0f7ff, #eaf6ff); /* èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      margin: 0;
      padding: 10px;
      color: #333;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #1565c0;
    }
    .area {
      background: #fff; /* ç™½ã„èƒŒæ™¯ã®ã‚«ãƒ¼ãƒ‰ */
      border-radius: 20px; /* è§’ä¸¸ */
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* å½± */
    }
    .area h2 {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 12px;
      color: #1565c0;
    }

    /* ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
    #editorWrapper {
      position: relative;
      width: 100%;
      max-width: 900px; /* æœ€å¤§å¹… */
      aspect-ratio: 4 / 3; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š */
      margin: 0 auto;
      background-color: #f9f9f9;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    /* ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚­ãƒ£ãƒ³ãƒã‚¹ */
    #mainCanvas, #overlayCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      touch-action: none; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’ç„¡åŠ¹åŒ– */
    }
    /* ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒï¼ˆä½è§£åƒåº¦ç‰ˆï¼‰ */
    #templateOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€é */
      object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ã¤ã¤è¦ç´ å†…ã«åã‚ã‚‹ */
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    select, input[type="text"], input[type="color"], button, label {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      background: #fff;
      box-sizing: border-box;
    }
    /* ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    button {
      background: #4cafef;
      color: white;
      font-size: 16px;
      padding: 12px 24px;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s, background 0.3s; /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    }
    button:hover {
      background: #2196f3;
      transform: translateY(-2px);
    }
    /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    #customFileLabel {
      background: linear-gradient(135deg, #4cafef, #2196f3);
      color: #fff;
      border-radius: 30px;
      padding: 14px 26px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
      display: inline-block; /* ãƒœã‚¿ãƒ³ã®ã‚ˆã†ã«è¡¨ç¤º */
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
    }
    #customFileLabel:hover {
      background: linear-gradient(135deg, #42a5f5, #1e88e5);
      transform: scale(1.05);
    }
    /* ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .form-button {
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
      padding: 12px 24px;
      margin-top: 20px;
      text-decoration: none;
      font-weight: bold;
      font-size: 18px;
      border-radius: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      display: block;
      width: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ã¦å¹…ã‚’èª¿æ•´ */
      margin-left: auto;
      margin-right: auto;
    }
    .form-button:hover {
      background: linear-gradient(135deg, #1976d2, #0d47a1);
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #previewWrapper img {
      max-width: 100%;
      border: 6px solid #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin-top: 12px;
    }
    /* é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ ç·š */
    .active-object-outline {
      outline: 2px dashed #42a5f5; /* ç‚¹ç·šã§è¡¨ç¤º */
      outline-offset: 5px; /* è¦ç´ ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ */
    }
    /* ã‚¨ãƒ‡ã‚£ã‚¿ã®åˆæœŸèƒŒæ™¯ï¼ˆã†ã¡ã‚ã®å½¢çŠ¶ï¼‰*/
    #editorWrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url(fan1-lowres.png) no-repeat center center / contain; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã†ã¡ã‚ã®å½¢ */
      pointer-events: none;
      opacity: 0.5; /* åŠé€æ˜ */
    }
  </style>
</head>
<body>

  <h1 id="title">Myã†ã¡ã‚</h1>

  <div class="area" id="area-select">
    <h2 id="section1-title">1) ãƒ‡ã‚¶ã‚¤ãƒ³ï¼†å†™çœŸã‚’é¸ã¶</h2>
    <label id="templateLabel">ã†ã¡ã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã‚“ã§ã­ğŸ‘‰</label>
    <select id="templateSelector">
      <option value="fan1-highres.png" data-lowres="fan1-lowres.png">ç„¡åœ°</option>
      <option value="fan2-highres.png" data-lowres="fan2-highres.png">å¤ç¥­ã‚Šâ‘ </option>
      <option value="fan3-highres.png" data-lowres="fan3-highres.png">å¤ç¥­ã‚Šâ‘¡</option>
    </select>
    <label for="imageLoader" id="customFileLabel">å†™çœŸã‚’æ’®ã‚‹ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶</label>
    <input type="file" id="imageLoader" accept="image/*" style="display:none;" />
    <p id="reuploadNotice" style="font-size: 12px; color: #666;">â€» ç”»åƒã¯ä½•åº¦ã§ã‚‚é¸ã³ç›´ã›ã¾ã™ã€‚</p>
  </div>

  <div class="area" id="area-canvas">
    <h2 id="section2-title">2) ãƒ‡ã‚¶ã‚¤ãƒ³ç·¨é›†ã‚¹ãƒšãƒ¼ã‚¹</h2>
    <div id="editorWrapper">
      <canvas id="mainCanvas" width="3508" height="2480"></canvas>
      <img id="templateOverlay" src="fan1-lowres.png" alt="ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ">
    </div>
    <p id="editNotice" style="font-size: 12px; color: #666; margin-top: 10px;">
      â€» ç”»åƒã¯1æœ¬ã®æŒ‡ã§ä½ç½®ã‚’å‹•ã‹ã›ã¾ã™ã€‚2æœ¬ã®æŒ‡ã§å¤§ãã•ã‚„å‘ãã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
    </p>
    <button id="confirmPhotoBtn" style="margin-top: 10px;">å†™çœŸã®é…ç½®ã‚’ç¢ºå®š</button>
    <button id="reEditPhotoBtn" style="margin-top: 10px; display: none;">å†™çœŸã®å†ç·¨é›†</button>
  </div>

  <div class="area" id="area-decorations" style="display: none;">
    <h2 id="section3-title">3) ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
    <p id="decorationNotice" style="font-size: 12px; color: #666;">
      â€» ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨é¸æŠã•ã‚Œã€ç§»å‹•ãƒ»ã‚µã‚¤ã‚ºå¤‰æ›´ãƒ»å›è»¢ã§ãã¾ã™ã€‚
    </p>

    <!-- è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <h3>è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆ</h3>
    <input type="text" id="customText" placeholder="æ¨ã—ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â™¡" />
    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
      <input type="color" id="colorPicker" value="#ff69b4" title="æ–‡å­—è‰²é¸æŠ" style="width: 50px;" />
      <select id="fontPicker" style="flex: 1;">
        <option value="Arial, sans-serif">Arial</option>
        <option value="'DotGothic16', sans-serif">ãƒ‰ãƒƒãƒˆã‚´ã‚·ãƒƒã‚¯</option>
        <option value="'Train One', cursive">Train One</option>
        <option value="'Cherry Bomb One', cursive">æ‰‹æ›¸ãé¢¨</option>
        <option value="'Kaisei Tokumin', serif">ä¸¸æ–‡å­—</option>
      </select>
    </div>
    <button onclick="addTextToOverlay()">ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>

    <!-- ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆçµµæ–‡å­—ãƒ»PNGï¼‰ã‚¨ãƒªã‚¢ -->
    <h3>ã‚¹ã‚¿ãƒ³ãƒ—</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;">
      <button onclick="addStamp('â¤ï¸')">â¤ï¸</button>
      <button onclick="addStamp('â­')">â­</button>
      <button onclick="addStamp('ğŸ¶')">ğŸ¶</button>
      <button onclick="addStamp('01loveu.png')">
        <img src="01loveu.png" alt="Love You" style="height: 24px; vertical-align: middle;">
      </button>
      <button onclick="addStamp('02ntwithFace.png')">
        <img src="02ntwithFace.png" alt="NT with Face" style="height: 24px; vertical-align: middle;">
      </button>
      <button onclick="addStamp('03eyestome.png')">
        <img src="03eyestome.png" alt="Eyes to me" style="height: 24px; vertical-align: middle;">
      </button>
      <button onclick="addStamp('04getmyheart.png')">
        <img src="04getmyheart.png" alt="Get my heart" style="height: 24px; vertical-align: middle;">
      </button>
    </div>
    
    <!-- ç·¨é›†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
    <h3>ç·¨é›†ãƒ„ãƒ¼ãƒ«</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;">
      <button id="selectBtn" style="flex: 1;">é¸æŠåˆ‡æ›¿</button>
      <button id="undoBtn" style="flex: 1;">æˆ»ã‚‹</button>
      <button id="redoBtn" style="flex: 1;">ã‚„ã‚Šç›´ã—</button>
      <button id="duplicateBtn" style="flex: 1;">è¤‡è£½</button>
      <button id="deleteBtn" style="flex: 1; background: #f44336;">å‰Šé™¤</button>
      <button id="sendBackwardBtn" style="flex: 1;">èƒŒé¢ã¸</button>
      <button id="bringForwardBtn" style="flex: 1;">å‰é¢ã¸</button>
    </div>

    <!-- ã€Œæ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢å†…ã«ç§»å‹• -->
    <button id="generateBtn" class="form-button" style="margin-top: 20px;">æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
  </div>

  <div class="area" id="area-result" style="display: none;">
    <h2 id="section4-title">4) å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸</h2>
    <div id="previewWrapper">
      <img id="previewImage" alt="åˆæˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />
    </div>
    <div id="previewNotice" style="font-size:14px; color:black; margin-top:10px;"></div>
    <!-- ã€Œæ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ã¯ã“ã“ã«æ®‹ã—ã€JavaScriptã§è¡¨ç¤ºåˆ¶å¾¡ -->
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform?usp=dialog"
       target="_blank"
       class="form-button"
       id="goToOrderFormBtn"
       style="display: none;">ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€</a>
  </div>

  <footer style="font-size: 6px; color: #888; margin-top: 20px;">
    Â© 2025 Chugoku Shimbun Hanbai Center. Web application developed by Hitomi Sasaki. All rights reserved.<br />
    ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ ªå¼ä¼šç¤¾ä¸­å›½æ–°èè²©å£²ã‚»ãƒ³ã‚¿ãƒ¼ã®å¾“æ¥­å“¡ã«ã‚ˆã‚‹åœ°åŸŸã‚¤ãƒ™ãƒ³ãƒˆå‘ã‘ã®è‡ªä¸»é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚<br />
    â€»æœ¬ã‚¢ãƒ—ãƒªã¯å…¬å¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¥­å‹™ã¨ã®è¦ªå’Œæ€§ã‚’è€ƒæ…®ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
  </footer>

  <!-- Hammer.jsã‚’èª­ã¿è¾¼ã¿ï¼šã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚’ã‚ˆã‚Šã‚¹ãƒ ãƒ¼ã‚ºã«ã™ã‚‹ãŸã‚ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <script>
    // DOMè¦ç´ ã®å–å¾—
    const mainCanvas = document.getElementById('mainCanvas');
    const ctx = mainCanvas.getContext('2d');
    const templateOverlay = document.getElementById('templateOverlay');
    const imageLoader = document.getElementById('imageLoader');
    const templateSelector = document.getElementById('templateSelector');
    const confirmPhotoBtn = document.getElementById('confirmPhotoBtn');
    const reEditPhotoBtn = document.getElementById('reEditPhotoBtn');
    const generateBtn = document.getElementById('generateBtn');
    const goToOrderFormBtn = document.getElementById('goToOrderFormBtn');
    const customText = document.getElementById('customText');
    const colorPicker = document.getElementById('colorPicker');
    const fontPicker = document.getElementById('fontPicker');
    const previewWrapper = document.getElementById('previewWrapper');
    const previewImage = document.getElementById('previewImage');
    const previewNotice = document.getElementById('previewNotice');
    const areaDecorations = document.getElementById('area-decorations');
    const areaResult = document.getElementById('area-result'); // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¨ãƒªã‚¢

    // çŠ¶æ…‹å¤‰æ•°
    let uploadedImg = null; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸãƒ‡ãƒ¼ã‚¿
    let photoObject = null; // å†™çœŸã®ç¾åœ¨ã®ä½ç½®ã€ã‚¹ã‚±ãƒ¼ãƒ«ã€å›è»¢
    let isPhotoLocked = false; // å†™çœŸã®ç·¨é›†ãŒç¢ºå®šã•ã‚Œã¦ã„ã‚‹ã‹
    let decorationObjects = []; // ãƒ†ã‚­ã‚¹ãƒˆã€çµµæ–‡å­—ã€ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ãªã©ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
    let selectedObject = null; // ç¾åœ¨é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    let history = []; // ç·¨é›†å±¥æ­´ï¼ˆã‚¢ãƒ³ãƒ‰ã‚¥/ãƒªãƒ‰ã‚¥ç”¨ï¼‰
    let historyIndex = -1; // ç¾åœ¨ã®å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

    // ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é–‹å§‹æ™‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹ã¨ã‚¿ãƒƒãƒä¸­å¿ƒ
    var initialObjX, initialObjY, initialObjScale, initialObjRotation; // letã‹ã‚‰varã«å¤‰æ›´
    var initialTouchCenterX, initialTouchCenterY; // letã‹ã‚‰varã«å¤‰æ›´
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‹ã‚‰ã‚¿ãƒƒãƒä¸­å¿ƒã¸ã®åˆæœŸãƒ™ã‚¯ãƒˆãƒ«ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»ï¼‰
    var initialVecOffsetX, initialVecOffsetY; // letã‹ã‚‰varã«å¤‰æ›´

    // --- å±¥æ­´ç®¡ç†æ©Ÿèƒ½ ---
    /**
     * ç¾åœ¨ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¾ã™ã€‚
     */
    function saveState() {
      // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»¥é™ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã€æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ 
      if (historyIndex < history.length - 1) {
        history = history.slice(0, historyIndex + 1);
      }
      history.push(JSON.stringify(decorationObjects)); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã‚’ä¿å­˜
      historyIndex++;
    }

    /**
     * ä¸€ã¤å‰ã®ç·¨é›†çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ï¼ˆã‚¢ãƒ³ãƒ‰ã‚¥ï¼‰ã€‚
     */
    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        decorationObjects = JSON.parse(history[historyIndex]); // å±¥æ­´ã‹ã‚‰çŠ¶æ…‹ã‚’å¾©å…ƒ
        selectedObject = null; // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
        drawAll(); // å…¨ä½“ã‚’å†æç”»
      }
    }

    /**
     * ä¸€ã¤å¾Œã®ç·¨é›†çŠ¶æ…‹ã«é€²ã¿ã¾ã™ï¼ˆãƒªãƒ‰ã‚¥ï¼‰ã€‚
     */
    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        decorationObjects = JSON.parse(history[historyIndex]); // å±¥æ­´ã‹ã‚‰çŠ¶æ…‹ã‚’å¾©å…ƒ
        selectedObject = null; // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
        drawAll(); // å…¨ä½“ã‚’å†æç”»
      }
    }

    // --- æç”»æ©Ÿèƒ½ ---
    /**
     * å†™çœŸã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã—ã¾ã™ã€‚
     */
    function drawImage() {
      if (!photoObject || !uploadedImg) return;

      ctx.save(); // ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã®çŠ¶æ…‹ã‚’ä¿å­˜
      // å†™çœŸã®ä¸­å¿ƒã‚’åŸºæº–ã«ç§»å‹•ã€å›è»¢ã€æ‹¡å¤§ç¸®å°
      ctx.translate(photoObject.x, photoObject.y);
      ctx.rotate(photoObject.rotation);
      ctx.scale(photoObject.scale, photoObject.scale);
      // ç”»åƒã‚’æç”»ï¼ˆä¸­å¿ƒåº§æ¨™ãŒ0,0ã«ãªã‚‹ã‚ˆã†ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
      ctx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
      ctx.restore(); // ä¿å­˜ã—ãŸçŠ¶æ…‹ã«æˆ»ã™
    }

    /**
     * ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã€ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã—ã¾ã™ã€‚
     */
    function drawDecorations() {
      decorationObjects.forEach(obj => {
        ctx.save();
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‚’åŸºæº–ã«ç§»å‹•ã€å›è»¢ã€æ‹¡å¤§ç¸®å°
        ctx.translate(obj.x, obj.y);
        ctx.rotate(obj.rotation);
        ctx.scale(obj.scale, obj.scale);

        if (obj.type === 'text') {
          ctx.fillStyle = obj.color;
          // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¯ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‰ã«è¨­å®š (pxå˜ä½)
          ctx.font = `${obj.fontSize / obj.scale}px ${obj.fontFamily}`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(obj.content, 0, 0);
        } else if (obj.type === 'image') {
          // ç”»åƒã‚’æç”»ï¼ˆä¸­å¿ƒåº§æ¨™ãŒ0,0ã«ãªã‚‹ã‚ˆã†ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
          ctx.drawImage(obj.img, -obj.width / 2, -obj.height / 2, obj.width, obj.height);
        }

        // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ ç·šã‚’è¡¨ç¤º
        if (obj === selectedObject) {
          ctx.strokeStyle = '#42a5f5';
          ctx.lineWidth = 10 / obj.scale; // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«åˆã‚ã›ã¦ç·šå¹…ã‚’èª¿æ•´
          ctx.setLineDash([20 / obj.scale, 10 / obj.scale]); // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«åˆã‚ã›ã¦ç‚¹ç·šã®é–“éš”ã‚’èª¿æ•´
          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æç”»ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã€æ ç·šã‚’æç”»
          const rectWidth = obj.type === 'text' ? ctx.measureText(obj.content).width : obj.width;
          const rectHeight = obj.type === 'text' ? obj.fontSize * 1.2 / obj.scale : obj.height; // ãƒ†ã‚­ã‚¹ãƒˆã¯è¡Œé«˜è€ƒæ…®
          ctx.strokeRect(-rectWidth / 2, -rectHeight / 2, rectWidth, rectHeight);
          ctx.setLineDash([]); // ç‚¹ç·šãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        }

        ctx.restore();
      });
    }

    /**
     * ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’ã‚¯ãƒªã‚¢ã—ã€å†™çœŸã¨ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†æç”»ã—ã¾ã™ã€‚
     */
    function drawAll() {
      ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
      drawImage(); // å†™çœŸã‚’æç”»
      drawDecorations(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
    }

    /**
     * ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåº§æ¨™ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã®è«–ç†åº§æ¨™ã«å¤‰æ›ã—ã¾ã™ã€‚
     * @param {number} clientX - ã‚¤ãƒ™ãƒ³ãƒˆã®clientXåº§æ¨™
     * @param {number} clientY - ã‚¤ãƒ™ãƒ³ãƒˆã®clientYåº§æ¨™
     * @returns {{x: number, y: number}} ã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã®åº§æ¨™
     */
    function getCanvasCoords(clientX, clientY) {
      const rect = mainCanvas.getBoundingClientRect(); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç”»é¢ä¸Šã§ã®ä½ç½®ã¨ã‚µã‚¤ã‚º
      const x = (clientX - rect.left) * (mainCanvas.width / rect.width);
      const y = (clientY - rect.top) * (mainCanvas.height / rect.height);
      return { x, y };
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸç‚¹ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¢ƒç•Œå†…ã«ã‚ã‚‹ã‹åˆ¤å®šã—ã¾ã™ã€‚
     * @param {{x: number, y: number}} p - åˆ¤å®šã—ãŸã„ç‚¹ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ï¼‰
     * @param {object} obj - åˆ¤å®šå¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {boolean} ç‚¹ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã«ã‚ã‚‹ã‹
     */
    function isPointInObject(p, obj) {
      // 1. ç‚¹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ã«å¤‰æ›ã™ã‚‹ (é€†å¤‰æ›)
      // ã¾ãšã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‚’åŸç‚¹ã«ç§»å‹•
      const translatedX = p.x - obj.x;
      const translatedY = p.y - obj.y;

      // å›è»¢ã‚’å…ƒã«æˆ»ã™
      const cos = Math.cos(-obj.rotation);
      const sin = Math.sin(-obj.rotation);
      const rotatedX = translatedX * cos - translatedY * sin;
      const rotatedY = translatedX * sin + translatedY * cos;

      // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å…ƒã«æˆ»ã™
      const scaledX = rotatedX / obj.scale;
      const scaledY = rotatedY / obj.scale;

      // 2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ã§ã®å¹…ã¨é«˜ã•ã‚’è¨ˆç®—
      let objWidth, objHeight;
      if (obj.type === 'text') {
        // ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã€ç¾åœ¨ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã§ãƒ†ã‚­ã‚¹ãƒˆã®å®Ÿéš›ã®å¹…ã‚’æ¸¬å®š
        ctx.save();
        ctx.font = `${obj.fontSize}px ${obj.fontFamily}`; // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã§æ¸¬å®š
        objWidth = ctx.measureText(obj.content).width;
        objHeight = obj.fontSize * 1.2; // ãƒ†ã‚­ã‚¹ãƒˆã®é«˜ã•ã¯è¡Œé«˜ã‚’è€ƒæ…®
        ctx.restore();
      } else if (obj.type === 'image') {
        objWidth = obj.width;
        objHeight = obj.height;
      } else {
          return false; // æœªçŸ¥ã®ã‚¿ã‚¤ãƒ—
      }

      const halfObjWidth = objWidth / 2;
      const halfObjHeight = objHeight / 2;

      // 3. å¤‰æ›ã•ã‚ŒãŸç‚¹ãŒã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹å†…ã«ã‚ã‚‹ã‹åˆ¤å®š
      return scaledX >= -halfObjWidth && scaledX <= halfObjWidth &&
             scaledY >= -halfObjHeight && scaledY <= halfObjHeight;
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    /**
     * ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å‡¦ç†
     */
    imageLoader.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        uploadedImg = new Image();
        uploadedImg.onload = () => {
          // å†™çœŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸä½ç½®ã€ã‚¹ã‚±ãƒ¼ãƒ«ã€å›è»¢ã‚’è¨­å®š
          photoObject = {
            x: mainCanvas.width / 2, // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®
            y: mainCanvas.height / 2, // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®
            scale: 1,
            rotation: 0
          };
          isPhotoLocked = false; // å†™çœŸç·¨é›†ã‚’å¯èƒ½ã«ã™ã‚‹
          reEditPhotoBtn.style.display = 'none'; // å†ç·¨é›†ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤º
          confirmPhotoBtn.style.display = 'block'; // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          areaDecorations.style.display = 'none'; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
          areaResult.style.display = 'none'; // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚‚éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
          drawAll(); // å…¨ä½“ã‚’å†æç”»
        };
        uploadedImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    /**
     * ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é¸æŠå¤‰æ›´å‡¦ç†
     */
    templateSelector.addEventListener('change', e => {
      // ä½è§£åƒåº¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦è¡¨ç¤º
      templateOverlay.src = e.target.selectedOptions[0].dataset.lowres;
    });

    /**
     * å†™çœŸã®é…ç½®ç¢ºå®šãƒœã‚¿ãƒ³ã®å‡¦ç†
     */
    confirmPhotoBtn.addEventListener('click', () => {
      if (!uploadedImg) return; // å†™çœŸãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
      isPhotoLocked = true; // å†™çœŸã‚’ãƒ­ãƒƒã‚¯
      confirmPhotoBtn.style.display = 'none'; // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      reEditPhotoBtn.style.display = 'block'; // å†ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      areaDecorations.style.display = 'block'; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
      document.getElementById('area-decorations').scrollIntoView({ behavior: 'smooth' }); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      saveState(); // æœ€åˆã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜
    });

    /**
     * å†™çœŸã®å†ç·¨é›†ãƒœã‚¿ãƒ³ã®å‡¦ç†
     */
    reEditPhotoBtn.addEventListener('click', () => {
      isPhotoLocked = false; // å†™çœŸã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
      reEditPhotoBtn.style.display = 'none'; // å†ç·¨é›†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      confirmPhotoBtn.style.display = 'block'; // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      areaDecorations.style.display = 'none'; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
      selectedObject = null; // é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£é™¤
      areaResult.style.display = 'none'; // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚‚éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
      drawAll(); // å…¨ä½“ã‚’å†æç”»
    });

    /**
     * æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®å‡¦ç†
     */
    generateBtn.addEventListener('click', () => {
      if (!uploadedImg) {
        alert('âš ï¸ ã¾ãšå†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      if (!isPhotoLocked) {
        alert('âš ï¸ å†™çœŸã®é…ç½®ã‚’ç¢ºå®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // é«˜è§£åƒåº¦ã§ã®æœ€çµ‚ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = mainCanvas.width;
      tempCanvas.height = mainCanvas.height;
      const tempCtx = tempCanvas.getContext('2d');

      // 1. å†™çœŸã‚’æç”»
      tempCtx.save();
      tempCtx.translate(photoObject.x, photoObject.y);
      tempCtx.rotate(photoObject.rotation);
      tempCtx.scale(photoObject.scale, photoObject.scale);
      tempCtx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
      tempCtx.restore();

      // 2. ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
      decorationObjects.forEach(obj => {
        tempCtx.save();
        tempCtx.translate(obj.x, obj.y);
        tempCtx.rotate(obj.rotation);
        tempCtx.scale(obj.scale, obj.scale);
        if (obj.type === 'text') {
          tempCtx.fillStyle = obj.color;
          // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¯ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‰ã«è¨­å®š (pxå˜ä½)
          tempCtx.font = `${obj.fontSize / obj.scale}px ${obj.fontFamily}`;
          tempCtx.textAlign = 'center';
          tempCtx.textBaseline = 'middle';
          tempCtx.fillText(obj.content, 0, 0);
        } else if (obj.type === 'image') {
          tempCtx.drawImage(obj.img, -obj.width / 2, -obj.height / 2, obj.width, obj.height);
        }
        tempCtx.restore();
      });

      // 3. é«˜è§£åƒåº¦ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é‡ã­ã‚‹
      const templateHighRes = new Image();
      templateHighRes.onload = () => {
        tempCtx.drawImage(templateHighRes, 0, 0, tempCanvas.width, tempCanvas.height);
        previewImage.src = tempCanvas.toDataURL('image/png'); // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’DataURLã¨ã—ã¦è¨­å®š

        areaResult.style.display = 'block'; // â˜… å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢å…¨ä½“ã‚’è¡¨ç¤º
        previewWrapper.style.display = 'block'; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        goToOrderFormBtn.style.display = 'block'; // æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º

        // ä¿å­˜æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        previewNotice.innerHTML = `iPhoneï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œâ€œå†™çœŸâ€ã«è¿½åŠ ã€ã‚’é¸ã‚“ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br>Androidï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`;
        areaResult.scrollIntoView({ behavior: 'smooth' }); // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      };
      templateHighRes.src = templateSelector.value; // é¸æŠã•ã‚ŒãŸé«˜è§£åƒåº¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€
    });

    // --- ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ æ©Ÿèƒ½ ---
    /**
     * è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚
     */
    function addTextToOverlay() {
      const text = customText.value.trim();
      if (!text) return; // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
      const newText = {
        id: Date.now(), // ä¸€æ„ãªID
        type: 'text',
        content: text,
        x: mainCanvas.width / 2, // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®ã«é…ç½®
        y: mainCanvas.height / 2,
        scale: 1,
        rotation: 0,
        color: colorPicker.value,
        fontFamily: fontPicker.value,
        fontSize: 150 // åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
      };
      decorationObjects.push(newText); // é…åˆ—ã«è¿½åŠ 
      selectedObject = newText; // è¿½åŠ ã—ãŸã‚‚ã®ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      drawAll(); // å…¨ä½“ã‚’å†æç”»
      saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
    }

    // PNGã‚¹ãƒ†ãƒƒã‚«ãƒ¼ç”»åƒã‚’äº‹å‰ã«èª­ã¿è¾¼ã‚€
    const stampImages = {};
    const pngStickers = ['01loveu.png', '02ntwithFace.png', '03eyestome.png', '04getmyheart.png'];
    pngStickers.forEach(src => {
      const img = new Image();
      img.src = src;
      img.onload = () => {
        stampImages[src] = img; // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ ¼ç´
      };
    });

    /**
     * ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆçµµæ–‡å­—ã¾ãŸã¯PNGç”»åƒï¼‰ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚
     * @param {string} content - çµµæ–‡å­—æ–‡å­—åˆ—ã¾ãŸã¯PNGç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å
     */
    function addStamp(content) {
      let newStamp;
      if (content.endsWith('.png')) {
        const img = stampImages[content];
        if (!img) {
          alert('ç”»åƒã‚’ã¾ã èª­ã¿è¾¼ã‚“ã§ã„ã¾ã›ã‚“ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          return; // ç”»åƒãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã‘ã‚Œã°å‡¦ç†ã—ãªã„
        }
        newStamp = {
          id: Date.now(),
          type: 'image',
          img: img,
          x: mainCanvas.width / 2,
          y: mainCanvas.height / 2,
          scale: 1,
          rotation: 0,
          width: img.naturalWidth,
          height: img.naturalHeight
        };
        // ã‚¹ã‚¿ãƒ³ãƒ—ã®åˆæœŸã‚µã‚¤ã‚ºã‚’èª¿æ•´ï¼ˆå¤§ãã™ãã‚‹å ´åˆã‚’è€ƒæ…®ï¼‰
        const maxDim = Math.max(newStamp.width, newStamp.height);
        const targetSize = 400; // PNGã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã®åˆæœŸã‚µã‚¤ã‚ºç›®æ¨™
        if (maxDim > targetSize) {
            const scaleFactor = targetSize / maxDim;
            newStamp.width *= scaleFactor;
            newStamp.height *= scaleFactor;
        }
      } else {
        newStamp = {
          id: Date.now(),
          type: 'text', // çµµæ–‡å­—ã¯ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æ‰±ã†
          content: content,
          x: mainCanvas.width / 2,
          y: mainCanvas.height / 2,
          scale: 1,
          rotation: 0,
          color: 'black', // çµµæ–‡å­—ã¯åŸºæœ¬é»’è‰²
          fontFamily: 'sans-serif', // çµµæ–‡å­—è¡¨ç¤ºã«é©ã—ãŸãƒ•ã‚©ãƒ³ãƒˆ
          fontSize: 300 // çµµæ–‡å­—ã®åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
        };
      }
      decorationObjects.push(newStamp); // é…åˆ—ã«è¿½åŠ 
      selectedObject = newStamp; // è¿½åŠ ã—ãŸã‚‚ã®ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      drawAll(); // å…¨ä½“ã‚’å†æç”»
      saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
    }

    // --- ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç·¨é›†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ---
    /**
     * ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é¸æŠã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
     */
    document.getElementById('selectBtn').addEventListener('click', () => {
      if (decorationObjects.length === 0) return;
      const currentIndex = decorationObjects.indexOf(selectedObject);
      const nextIndex = (currentIndex + 1) % decorationObjects.length;
      selectedObject = decorationObjects[nextIndex]; // æ¬¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
      drawAll(); // å…¨ä½“ã‚’å†æç”»
    });
    document.getElementById('undoBtn').addEventListener('click', undo); // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    document.getElementById('redoBtn').addEventListener('click', redo); // ã‚„ã‚Šç›´ã—ãƒœã‚¿ãƒ³

    /**
     * é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚
     */
    document.getElementById('deleteBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      decorationObjects = decorationObjects.filter(obj => obj !== selectedObject); // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é™¤å¤–
      selectedObject = null; // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
      drawAll(); // å…¨ä½“ã‚’å†æç”»
      saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
    });

    /**
     * é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¤‡è£½ã—ã¾ã™ã€‚
     */
    document.getElementById('duplicateBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const newObj = { ...selectedObject }; // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒ£ãƒ­ãƒ¼ã‚³ãƒ”ãƒ¼
      newObj.id = Date.now(); // æ–°ã—ã„IDã‚’å‰²ã‚Šå½“ã¦ã‚‹
      newObj.x += 20; // å°‘ã—ãšã‚‰ã—ã¦é…ç½®
      newObj.y += 20;
      decorationObjects.push(newObj); // é…åˆ—ã«è¿½åŠ 
      selectedObject = newObj; // è¤‡è£½ã—ãŸã‚‚ã®ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      drawAll(); // å…¨ä½“ã‚’å†æç”»
      saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
    });

    /**
     * é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’èƒŒé¢ã¸ç§»å‹•ã—ã¾ã™ã€‚
     */
    document.getElementById('sendBackwardBtn').addEventListener('click', () => {
      const index = decorationObjects.indexOf(selectedObject);
      if (index > 0) { // æœ€å‰é¢ã§ãªã‘ã‚Œã°
        const obj = decorationObjects.splice(index, 1)[0]; // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã‹ã‚‰å–ã‚Šå‡ºã™
        decorationObjects.splice(index - 1, 0, obj); // ä¸€ã¤å‰ã®ä½ç½®ã«æŒ¿å…¥
        drawAll(); // å…¨ä½“ã‚’å†æç”»
        saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
      }
    });

    /**
     * é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚
     */
    document.getElementById('bringForwardBtn').addEventListener('click', () => {
      const index = decorationObjects.indexOf(selectedObject);
      if (index < decorationObjects.length - 1) { // æœ€èƒŒé¢ã§ãªã‘ã‚Œã°
        const obj = decorationObjects.splice(index, 1)[0]; // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã‹ã‚‰å–ã‚Šå‡ºã™
        decorationObjects.splice(index + 1, 0, obj); // ä¸€ã¤å¾Œã®ä½ç½®ã«æŒ¿å…¥
        drawAll(); // å…¨ä½“ã‚’å†æç”»
        saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
      }
    });

    // --- ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° ---
    customText.addEventListener('input', () => {
      if (selectedObject && selectedObject.type === 'text') {
        selectedObject.content = customText.value; // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’æ›´æ–°
        drawAll(); // å…¨ä½“ã‚’å†æç”»
      }
    });
    colorPicker.addEventListener('input', () => {
      if (selectedObject && selectedObject.type === 'text') {
        selectedObject.color = colorPicker.value; // è‰²ã‚’æ›´æ–°
        drawAll(); // å…¨ä½“ã‚’å†æç”»
      }
    });
    fontPicker.addEventListener('change', () => {
      if (selectedObject && selectedObject.type === 'text') {
        selectedObject.fontFamily = fontPicker.value; // ãƒ•ã‚©ãƒ³ãƒˆã‚’æ›´æ–°
        drawAll(); // å…¨ä½“ã‚’å†æç”»
      }
    });

    // --- Hammer.js ã«ã‚ˆã‚‹ã‚¿ãƒƒãƒ/ãƒã‚¦ã‚¹ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ---
    const hammertime = new Hammer(mainCanvas);
    hammertime.get('pinch').set({ enable: true });
    hammertime.get('rotate').set({ enable: true });

    // æ“ä½œå¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getActiveObject() {
        if (!isPhotoLocked) {
            return photoObject; // å†™çœŸç·¨é›†ä¸­ã¯å†™çœŸãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
        } else if (selectedObject) {
            return selectedObject; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†ä¸­ã¯é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
        }
        return null; // ä½•ã‚‚æ“ä½œå¯¾è±¡ãŒãªã„å ´åˆ
    }

    // ã‚¿ãƒƒãƒ—ã§ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
    hammertime.on('tap', function(e) {
      if (isPhotoLocked) { // å†™çœŸãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
        const p = getCanvasCoords(e.srcEvent.clientX, e.srcEvent.clientY); // ã‚¿ãƒƒãƒä½ç½®ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«å¤‰æ›
        let found = false;
        // Zã‚ªãƒ¼ãƒ€ãƒ¼ã‚’è€ƒæ…®ã—ã€é…åˆ—ã®æœ€å¾Œï¼ˆæœ€ã‚‚æ‰‹å‰ï¼‰ã‹ã‚‰é€†é †ã«åˆ¤å®š
        for (let i = decorationObjects.length - 1; i >= 0; i--) {
          const obj = decorationObjects[i];
          if (isPointInObject(p, obj)) {
            selectedObject = obj; // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            drawAll(); // å…¨ä½“ã‚’å†æç”»
            found = true;
            break;
          }
        }
        if (!found) { // ã©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚é¸æŠã•ã‚Œãªã‹ã£ãŸå ´åˆ
          selectedObject = null; // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
          drawAll(); // å…¨ä½“ã‚’å†æç”»
        }
      }
    });

    // ãƒ‘ãƒ³ï¼ˆç§»å‹•ï¼‰ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
    hammertime.on('panstart', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            initialObjX = activeObj.x;
            initialObjY = activeObj.y;
            // ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é–‹å§‹æ™‚ã®ã‚¿ãƒƒãƒä¸­å¿ƒç‚¹ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã§è¨˜éŒ²
            const touchCenter = getCanvasCoords(e.center.x, e.center.y);
            initialTouchCenterX = touchCenter.x;
            initialTouchCenterY = touchCenter.y;
        }
    });
    hammertime.on('pan', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            // ç¾åœ¨ã®ã‚¿ãƒƒãƒä¸­å¿ƒç‚¹ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã§å–å¾—
            const currentTouchCenter = getCanvasCoords(e.center.x, e.center.y);
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ–°ã—ã„ä½ç½®ã¯ã€é–‹å§‹æ™‚ã®ä½ç½®ã«ã‚¿ãƒƒãƒä¸­å¿ƒç‚¹ã®ç§»å‹•é‡ã‚’åŠ ç®—
            activeObj.x = initialObjX + (currentTouchCenter.x - initialTouchCenterX);
            activeObj.y = initialObjY + (currentTouchCenter.y - initialTouchCenterY);
            drawAll();
        }
    });
    hammertime.on('panend', function() {
        if(isPhotoLocked) saveState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç§»å‹•å¾Œã«å±¥æ­´ä¿å­˜
    });

    // ãƒ”ãƒ³ãƒï¼ˆæ‹¡å¤§ç¸®å°ï¼‰ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
    hammertime.on('pinchstart', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            initialObjX = activeObj.x;
            initialObjY = activeObj.y;
            initialObjScale = activeObj.scale;
            initialObjRotation = activeObj.rotation; // å›è»¢ã‚‚è€ƒæ…®
            const touchCenter = getCanvasCoords(e.center.x, e.center.y);
            initialTouchCenterX = touchCenter.x;
            initialTouchCenterY = touchCenter.y;

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‹ã‚‰ã‚¿ãƒƒãƒä¸­å¿ƒã¸ã®åˆæœŸãƒ™ã‚¯ãƒˆãƒ« (ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»)
            initialVecOffsetX = initialTouchCenterX - initialObjX;
            initialVecOffsetY = initialTouchCenterY - initialObjY;
        }
    });
    hammertime.on('pinch', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            const currentTouchCenter = getCanvasCoords(e.center.x, e.center.y);
            const newScale = initialObjScale * e.scale;
            // newRotationã¯pinchã‚¤ãƒ™ãƒ³ãƒˆã«ã‚‚e.rotationãŒã‚ã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’ä½¿ã†ã‹initialObjRotationã‚’ä½¿ç”¨
            // Hammer.jsã®e.rotationã¯ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é–‹å§‹æ™‚ã‹ã‚‰ã®ç›¸å¯¾å€¤ãªã®ã§ã€ãã®ã¾ã¾åˆ©ç”¨ã™ã‚‹
            const currentRotationDelta = e.rotation * Math.PI / 180; // Hammer.jsã¯åº¦æ•°æ³•ãªã®ã§ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›

            // åˆæœŸãƒ™ã‚¯ãƒˆãƒ«ã‚’ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«å€ç‡ã§ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            const scaledOffsetX = initialVecOffsetX * (newScale / initialObjScale);
            const scaledOffsetY = initialVecOffsetY * (newScale / initialObjScale);

            // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ™ã‚¯ãƒˆãƒ«ã‚’å›è»¢é‡ã®å·®åˆ†ã§å›è»¢
            const cos_rot_delta = Math.cos(currentRotationDelta);
            const sin_rot_delta = Math.sin(currentRotationDelta);

            const transformedOffsetX = scaledOffsetX * cos_rot_delta - scaledOffsetY * sin_rot_delta;
            const transformedOffsetY = scaledOffsetX * sin_rot_delta + scaledOffsetY * cos_rot_delta;

            // æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒ = ç¾åœ¨ã®ã‚¿ãƒƒãƒä¸­å¿ƒ - (ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¿ãƒƒãƒã¸ã®å¤‰æ›æ¸ˆã¿ãƒ™ã‚¯ãƒˆãƒ«)
            activeObj.x = currentTouchCenter.x - transformedOffsetX;
            activeObj.y = currentTouchCenter.y - transformedOffsetY;
            
            activeObj.scale = newScale; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’æ›´æ–°
            activeObj.rotation = initialObjRotation + currentRotationDelta; // å›è»¢ã‚’æ›´æ–° (åˆæœŸå›è»¢ + ãƒ‡ãƒ«ã‚¿)
            drawAll();
        }
    });
    hammertime.on('pinchend', function() {
        if(isPhotoLocked) saveState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‹¡å¤§ç¸®å°å¾Œã«å±¥æ­´ä¿å­˜
    });

    // å›è»¢ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
    hammertime.on('rotatestart', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            initialObjX = activeObj.x;
            initialObjY = activeObj.y;
            initialObjScale = activeObj.scale; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚è€ƒæ…®
            initialObjRotation = activeObj.rotation;
            const touchCenter = getCanvasCoords(e.center.x, e.center.y);
            initialTouchCenterX = touchCenter.x;
            initialTouchCenterY = touchCenter.y;

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‹ã‚‰ã‚¿ãƒƒãƒä¸­å¿ƒã¸ã®åˆæœŸãƒ™ã‚¯ãƒˆãƒ«ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»ï¼‰
            initialVecOffsetX = initialTouchCenterX - initialObjX;
            initialVecOffsetY = initialTouchCenterY - initialObjY;
        }
    });
    hammertime.on('rotate', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            const currentTouchCenter = getCanvasCoords(e.center.x, e.center.y);
            const newRotation = initialObjRotation + e.rotation * Math.PI / 180; // æ–°ã—ã„å›è»¢è§’åº¦ (ãƒ©ã‚¸ã‚¢ãƒ³)
            // scaleã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯rotateã‚¤ãƒ™ãƒ³ãƒˆã«ã‚‚å«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã‹initialObjScaleã‚’ä½¿ç”¨
            const currentScale = initialObjScale * (e.scale || 1); // Hammer.jsã®e.scaleã¯ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é–‹å§‹æ™‚ã‹ã‚‰ã®ç›¸å¯¾å€¤

            // åˆæœŸãƒ™ã‚¯ãƒˆãƒ«ã‚’ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«å€ç‡ã§ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            const scaledOffsetX = initialVecOffsetX * (currentScale / initialObjScale);
            const scaledOffsetY = initialVecOffsetY * (currentScale / initialObjScale);

            // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ™ã‚¯ãƒˆãƒ«ã‚’å›è»¢é‡ã®å·®åˆ†ã§å›è»¢
            const rotationDelta = e.rotation * Math.PI / 180; // Hammer.jsã®e.rotationã¯ãƒ‡ãƒ«ã‚¿
            const cos_rot_delta = Math.cos(rotationDelta);
            const sin_rot_delta = Math.sin(rotationDelta);

            const transformedOffsetX = scaledOffsetX * cos_rot_delta - scaledOffsetY * sin_rot_delta;
            const transformedOffsetY = scaledOffsetX * sin_rot_delta + scaledOffsetY * cos_rot_delta;

            // æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒ = ç¾åœ¨ã®ã‚¿ãƒƒãƒä¸­å¿ƒ - (ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¿ãƒƒãƒã¸ã®å¤‰æ›æ¸ˆã¿ãƒ™ã‚¯ãƒˆãƒ«)
            activeObj.x = currentTouchCenter.x - transformedOffsetX;
            activeObj.y = currentTouchCenter.y - transformedOffsetY;
            
            activeObj.rotation = newRotation; // å›è»¢ã‚’æ›´æ–°
            activeObj.scale = currentScale; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚æ›´æ–°
            drawAll();
        }
    });
    hammertime.on('rotateend', function() {
        if(isPhotoLocked) saveState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›è»¢å¾Œã«å±¥æ­´ä¿å­˜
    });


    // --- PCå‘ã‘ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ---
    let isDragging = false; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
    let lastPos = { x: 0, y: 0 }; // å‰å›ã®ãƒã‚¦ã‚¹ä½ç½® (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåº§æ¨™)
    let dragTarget = null; // 'photo', 'decoration', 'rotate-photo', 'rotate-decoration'

    mainCanvas.addEventListener('mousedown', function(e) {
      const p = getCanvasCoords(e.clientX, e.clientY); // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«å¤‰æ›
      isDragging = true;
      lastPos = { x: e.clientX, y: e.clientY }; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåº§æ¨™ã‚’ä¿å­˜

      if (e.button === 0) { // å·¦ã‚¯ãƒªãƒƒã‚¯ï¼ˆç§»å‹•ï¼‰
        if (!isPhotoLocked) {
          dragTarget = 'photo';
        } else {
          selectedObject = null; // ã¾ãšé¸æŠã‚’è§£é™¤
          // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€†é †ã§æ¢ã—ã€ä¸€ç•ªæ‰‹å‰ã®ã‚‚ã®ã‚’é¸æŠ
          for (let i = decorationObjects.length - 1; i >= 0; i--) {
            const obj = decorationObjects[i];
            if (isPointInObject(p, obj)) {
              selectedObject = obj;
              dragTarget = 'decoration';
              break;
            }
          }
        }
      } else if (e.button === 2) { // å³ã‚¯ãƒªãƒƒã‚¯ï¼ˆå›è»¢ï¼‰
        if (!isPhotoLocked) {
          dragTarget = 'rotate-photo';
        } else if (selectedObject) {
          dragTarget = 'rotate-decoration';
        }
      }
      drawAll();
    });

    mainCanvas.addEventListener('mousemove', function(e) {
      if (!isDragging || !dragTarget) return;

      // ç§»å‹•é‡ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è«–ç†ãƒ”ã‚¯ã‚»ãƒ«ã«å¤‰æ›
      const dx_canvas = (e.clientX - lastPos.x) * (mainCanvas.width / mainCanvas.getBoundingClientRect().width);
      const dy_canvas = (e.clientY - lastPos.y) * (mainCanvas.height / mainCanvas.getBoundingClientRect().height);

      if (dragTarget === 'photo') {
        photoObject.x += dx_canvas;
        photoObject.y += dy_canvas;
      } else if (dragTarget === 'decoration' && selectedObject) {
        selectedObject.x += dx_canvas;
        selectedObject.y += dy_canvas;
      } else if (dragTarget === 'rotate-photo') {
        photoObject.rotation += dx_canvas * 0.0005; // ãƒã‚¦ã‚¹ã®æ¨ªç§»å‹•é‡ã«å¿œã˜ã¦å›è»¢ï¼ˆèª¿æ•´æ¸ˆã¿ï¼‰
      } else if (dragTarget === 'rotate-decoration' && selectedObject) {
        selectedObject.rotation += dx_canvas * 0.0005; // ãƒã‚¦ã‚¹ã®æ¨ªç§»å‹•é‡ã«å¿œã˜ã¦å›è»¢ï¼ˆèª¿æ•´æ¸ˆã¿ï¼‰
      }

      lastPos = { x: e.clientX, y: e.clientY };
      drawAll();
    });

    mainCanvas.addEventListener('mouseup', function(e) {
      isDragging = false;
      dragTarget = null;
      if(isPhotoLocked) saveState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ“ä½œå¾Œã«å±¥æ­´ä¿å­˜
    });

    mainCanvas.addEventListener('mouseleave', function() {
      isDragging = false;
      dragTarget = null;
    });

    // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ–
    mainCanvas.addEventListener('contextmenu', e => e.preventDefault());

    // åˆæœŸæç”»
    drawAll();
  </script>
</body>
</html>