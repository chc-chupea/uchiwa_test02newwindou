captureBtn.addEventListener('click', () => {
  if (video.readyState < 2) {
    alert('ã‚«ãƒ¡ãƒ©ãŒã¾ã æº–å‚™ä¸­ã§ã™ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ã€ã‚‚ã†ä¸€åº¦ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  shutterSound.currentTime = 0;
  shutterSound.play().catch(() => {});

  // iOSå¯¾ç­–ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ç›´å¾Œã«ç©ºã®ã‚¿ãƒ–ã‚’é–‹ã
  const newWindow = window.open('', '_blank');

  const w = 3508, h = 2480;
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');

  const vw = video.videoWidth || video.offsetWidth;
  const vh = video.videoHeight || video.offsetHeight;
  const aspectVideo = vw / vh;
  const aspectCanvas = w / h;
  let sx = 0, sy = 0, sw = vw, sh = vh;

  if (aspectVideo > aspectCanvas) {
    sw = vh * aspectCanvas;
    sx = (vw - sw) / 2;
  } else {
    sh = vw / aspectCanvas;
    sy = (vh - sh) / 2;
  }

  ctx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);

  const highresImg = new Image();
  highresImg.crossOrigin = "anonymous";
  highresImg.onload = () => {
    ctx.drawImage(highresImg, 0, 0, w, h);

    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);

      // iPhoneå¯¾å¿œï¼šç”»åƒã‚’æ–°ã—ã„ã‚¿ãƒ–ã«è¡¨ç¤ºï¼ˆé•·æŠ¼ã—ä¿å­˜ç”¨ï¼‰
      newWindow.document.write(`
        <img src="${url}" style="width:100%; max-width:900px; display:block; margin:20px auto;" />
        <p style="text-align:center;">ğŸ“Œç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œâ€œå†™çœŸâ€ã«è¿½åŠ ã€ã—ã¦ãã ã•ã„ã€‚</p>
        <a href="${formURL}" target="_blank"
           style="display:block; margin: 20px auto; text-align:center; font-size:18px;
                  padding: 10px 20px; background:#0077cc; color:#fff; border-radius:8px;
                  text-decoration:none; max-width:300px;">
           ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€
        </a>
      `);
      newWindow.document.title = "ç”»åƒã‚’ä¿å­˜ã—ã¦ã­";

      // å…ƒãƒšãƒ¼ã‚¸ã«ã‚‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆä¿é™ºï¼‰
      const previewWrapper = document.getElementById('previewWrapper');
      const previewImg = document.getElementById('previewImage');
      previewImg.src = '';
      previewImg.onload = () => { notice.scrollIntoView({ behavior: 'smooth' }); };
      previewImg.src = url;
      previewWrapper.style.display = 'block';

      notice.style.display = 'block';
      notice.innerHTML = `
        ğŸ‘†ç”»åƒã‚’ä¿å­˜ã—ãŸã‚‰ã€ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ã«é€²ã‚“ã§ãã ã•ã„ğŸ‘‡<br>
      `;

      const btn = document.createElement('a');
      btn.href = formURL;
      btn.target = '_blank';
      btn.className = 'form-button';
      btn.textContent = 'ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€';
      notice.appendChild(btn);
      notice.scrollIntoView({ behavior: 'smooth' });
    }, 'image/png');
  };

  highresImg.src = currentHighRes;
});
