<!DOCTYPE html>
<html lang="ja">
<head>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Kosugi+Maru&family=DotGothic16&family=Train+One&family=Cherry+Bomb+One&family=Kaisei+Tokumin&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <title>Myã†ã¡ã‚ - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      background: linear-gradient(135deg, #f0f7ff, #eaf6ff);
      margin: 0;
      padding: 16px;
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 22px;
      margin-bottom: 20px;
      color: #1565c0;
    }
    .area {
      background: #fff;
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .area h2 {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 12px;
      color: #1565c0;
    }
    select, input[type="file"], button, label {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      background: #fff;
      box-sizing: border-box;
    }
    button {
      background: #4cafef;
      color: white;
      font-size: 16px;
      padding: 12px 24px;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, background 0.3s;
    }
    button:hover {
      background: #2196f3;
      transform: translateY(-2px);
    }
    canvas {
      width: 100%;
      height: auto;
      background: #f9f9f9;
      border-radius: 12px;
      border: 1px solid #ddd;
    }
    #mainCanvas { touch-action: none; }
    #templateLabel {
      border: none;
      outline: none;
    }
    #previewWrapper img {
      max-width: 100%;
      border: 6px solid #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-top: 12px;
    }
    #previewNotice {
      font-size: 13px;
      margin-top: 8px;
      color: #555;
    }
    #langButtons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    #langButtons button {
      flex: 1;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      background: #fdfdfd;
      color: #333;
      border-radius: 10px;
      box-shadow: none;
    }
    #langButtons button:hover {
      background: #f0f0f0;
    }
    #customFileLabel {
      background: linear-gradient(135deg, #4cafef, #2196f3);
      color: #fff;
      border-radius: 30px;
      padding: 14px 26px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
      display: inline-block;
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    #customFileLabel:hover {
      background: linear-gradient(135deg, #42a5f5, #1e88e5);
      transform: scale(1.07);
    }
    #decoControls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    #decoControls .control-group {
      display: flex;
      gap: 5px;
      align-items: center;
      margin-bottom: 5px;
    }
    #textInputGroup, #stampGroup, #editTools {
      width: 100%;
      text-align: center;
      margin-top: 10px;
    }
    #customText {
      width: 60%;
      padding: 8px;
      font-size: 16px;
      border-radius: 8px;
    }
    #addTextBtn, #addStampBtn, .stamp-img-btn, #undoBtn, #redoBtn, #duplicateBtn, #deleteBtn, #bringFrontBtn, #sendBackBtn {
      padding: 8px 12px;
      font-size: 14px;
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: none;
      transition: none;
      width: auto;
    }
    #addTextBtn {
      background: #00bcd4;
      color: white;
    }
    .stamp-img-btn img {
      width: 40px;
      height: auto;
    }
    #editTools {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }
    #editTools button {
      flex: 1;
      min-width: 80px;
      max-width: 120px;
    }
    @media print {
      body *:not(.fan-print) {
        display: none !important;
      }
      #mainCanvas {
        width: 100%;
        height: auto;
      }
      canvas {
        page-break-inside: avoid;
        break-inside: avoid;
        -webkit-region-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div id="langButtons">
    <button onclick="setLanguage('ja')">ğŸ‡¯ğŸ‡µJP</button>
    <button onclick="setLanguage('en')">ğŸ‡ºğŸ‡¸EN</button>
    <button onclick="setLanguage('zh')">ğŸ‡¨ğŸ‡³ä¸­æ–‡</button>
    <button onclick="setLanguage('ko')">ğŸ‡°ğŸ‡·KO</button>
    <button onclick="setLanguage('vi')">ğŸ‡»ğŸ‡³VIt</button>
  </div>
  <button id="howToBtn" style="margin:10px; padding:10px 20px; border-radius:20px; background:#2196f3; color:white; border:none; cursor:pointer;" data-ja="â“ ä½¿ã„æ–¹" data-en="â“ How to Use" data-zh="â“ ä½¿ç”¨æ–¹æ³•" data-ko="â“ ì‚¬ìš© ë°©ë²•" data-vi="â“ CÃ¡ch sá»­ dá»¥ng">â“ ä½¿ã„æ–¹</button>
  <div id="howToModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; max-width:600px; width:90%; padding:20px; overflow-y:auto; max-height:90%;">
      <h2 id="howToTitle" style="text-align:center; color:#1565c0;" data-ja="ğŸ“– Myã†ã¡ã‚ LAB ä½¿ã„æ–¹" data-en="ğŸ“– How to Use My Uchiwa LAB" data-zh="ğŸ“– Myå›¢æ‰‡LAB ä½¿ç”¨æ–¹æ³•" data-ko="ğŸ“– Myìš°ì¹˜ì™€ LAB ì‚¬ìš© ë°©ë²•" data-vi="ğŸ“– CÃ¡ch sá»­ dá»¥ng My Uchiwa LAB">ğŸ“– Myã†ã¡ã‚ LAB ä½¿ã„æ–¹</h2>
      <div id="howToBody" style="text-align:left; line-height:1.6; font-size:14px; color:#333;" data-ja="<ol><li><b>ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã¶ï¼š</b> ç„¡åœ°ï¼å¤â‘ ï¼å¤â‘¡ã‹ã‚‰é¸æŠ</li><li><b>å†™çœŸã‚’é¸ã¶ï¼š</b> ã€Œå†™çœŸã‚’æ’®ã‚‹ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶ã€ã§æ’®å½±ã¾ãŸã¯ç”»åƒã‚’é¸æŠ</li><li><b>ç·¨é›†ã™ã‚‹ï¼š</b> 1æœ¬æŒ‡ã§ç§»å‹•ã€ãƒ”ãƒ³ãƒã§æ‹¡å¤§ç¸®å°ã€2æœ¬æŒ‡ã§å›è»¢</li><li><b>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼š</b> ã€Œæ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã‚’æŠ¼ã—ã¦å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèª</li><li><b>ä¿å­˜ï¼š</b><ul><li>iPhone â†’ ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œå†™çœŸã«è¿½åŠ ã€</li><li>Android â†’ ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€</li></ul></li><li><b>æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ï¼š</b> ä¿å­˜ã—ãŸã‚‰ã€Œæ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ã€ã‹ã‚‰ç”³è¾¼</li><li><b>LINEã§ã‚·ã‚§ã‚¢ï¼š</b> ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‹é”ã«URLã‚’é€ä¿¡</li></ol>" data-en="<ol><li><b>Choose a design:</b> Select Plain / Summer â‘  / Summer â‘¡.</li><li><b>Choose a photo:</b> Tap &quot;Take Photo / Choose from Library&quot; to take or pick an image.</li><li><b>Edit:</b> Drag with one finger to move; pinch to zoom; rotate with two fingers.</li><li><b>Preview:</b> Tap &quot;Confirm â†’ Preview&quot; to check the final image.</li><li><b>Save:</b><ul><li>iPhone â†’ Press and hold the image, then select &quot;Add to Photos&quot;.</li><li>Android â†’ Press and hold the image, then select &quot;Save Image&quot;.</li></ul></li><li><b>Order form:</b> After saving, proceed via &quot;Go to Order Form&quot;.</li><li><b>Share on LINE:</b> Use the button at the bottom to send the page URL to friends.</li></ol>" data-zh="<ol><li><b>é€‰æ‹©è®¾è®¡ï¼š</b> ä»ã€Œç´ è‰²ï¼å¤å­£â‘ ï¼å¤å­£â‘¡ã€ä¸­é€‰æ‹©ã€‚</li><li><b>é€‰æ‹©ç…§ç‰‡ï¼š</b> ç‚¹å‡»ã€Œæ‹ç…§ / ä»å›¾åº“é€‰æ‹©ã€ï¼Œæ‹æ‘„æˆ–é€‰æ‹©å›¾ç‰‡ã€‚</li><li><b>ç¼–è¾‘ï¼š</b> å•æŒ‡æ‹–åŠ¨ç§»åŠ¨ï¼›æåˆç¼©æ”¾ï¼›åŒæŒ‡æ—‹è½¬ã€‚</li><li><b>é¢„è§ˆï¼š</b> ç‚¹å‡»ã€Œç¡®è®¤ â†’ é¢„è§ˆã€æŸ¥çœ‹å®Œæˆæ•ˆæœã€‚</li><li><b>ä¿å­˜ï¼š</b><ul><li>iPhone â†’ é•¿æŒ‰å›¾ç‰‡ï¼Œé€‰æ‹©ã€Œæ·»åŠ åˆ°ç…§ç‰‡ã€ã€‚</li><li>Android â†’ é•¿æŒ‰å›¾ç‰‡ï¼Œé€‰æ‹©ã€Œä¿å­˜å›¾ç‰‡ã€ã€‚</li></ul></li><li><b>è®¢å•è¡¨å•ï¼š</b> ä¿å­˜åï¼Œç‚¹å‡»ã€Œå‰å¾€è®¢å•è¡¨å•ã€æäº¤ã€‚</li><li><b>ç”¨ LINE åˆ†äº«ï¼š</b> ä½¿ç”¨é¡µé¢åº•éƒ¨çš„æŒ‰é’®ï¼Œå°†URLå‘é€ç»™æœ‹å‹ã€‚</li></ol>" data-ko="<ol><li><b>ë””ìì¸ ì„ íƒ:</b> ë¬´ì§€ / ì—¬ë¦„â‘  / ì—¬ë¦„â‘¡ ì¤‘ì—ì„œ ì„ íƒí•©ë‹ˆë‹¤.</li><li><b>ì‚¬ì§„ ì„ íƒ:</b> &quot;ì‚¬ì§„ ì°ê¸° / ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì„ íƒ&quot;ì„ ëˆŒëŸ¬ ì´¬ì˜í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li><li><b>í¸ì§‘:</b> í•œ ì†ê°€ë½ìœ¼ë¡œ ì´ë™, í•€ì¹˜ë¡œ í™•ëŒ€/ì¶•ì†Œ, ë‘ ì†ê°€ë½ìœ¼ë¡œ íšŒì „í•©ë‹ˆë‹¤.</li><li><b>ë¯¸ë¦¬ë³´ê¸°:</b> &quot;í™•ì¸ â†’ ë¯¸ë¦¬ë³´ê¸°&quot;ë¥¼ ëˆŒëŸ¬ ì™„ì„± ì´ë¯¸ì§€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</li><li><b>ì €ì¥:</b><ul><li>iPhone â†’ ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ &quot;ì‚¬ì§„ì— ì¶”ê°€&quot;ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li><li>Android â†’ ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ &quot;ì´ë¯¸ì§€ ì €ì¥&quot;ì„ ì„ íƒí•©ë‹ˆë‹¤.</li></ul></li><li><b>ì£¼ë¬¸ ì–‘ì‹:</b> ì €ì¥ í›„ &quot;ì£¼ë¬¸ ì–‘ì‹ìœ¼ë¡œ ì´ë™&quot; ë²„íŠ¼ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.</li><li><b>LINE ê³µìœ :</b> í˜ì´ì§€ í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ì¹œêµ¬ì—ê²Œ URLì„ ì „ì†¡í•©ë‹ˆë‹¤.</li></ol>" data-vi="<ol><li><b>Chá»n thiáº¿t káº¿:</b> Chá»n TrÆ¡n / MÃ¹a hÃ¨ â‘  / MÃ¹a hÃ¨ â‘¡.</li><li><b>Chá»n áº£nh:</b> Nháº¥n &quot;Chá»¥p áº£nh / Chá»n tá»« thÆ° viá»‡n&quot; Ä‘á»ƒ chá»¥p hoáº·c chá»n áº£nh.</li><li><b>Chá»‰nh sá»­a:</b> KÃ©o báº±ng má»™t ngÃ³n tay Ä‘á»ƒ di chuyá»ƒn; chá»¥m Ä‘á»ƒ phÃ³ng to/thu nhá»; xoay báº±ng hai ngÃ³n tay.</li><li><b>Xem trÆ°á»›c:</b> Nháº¥n &quot;XÃ¡c nháº­n â†’ Xem trÆ°á»›c&quot; Ä‘á»ƒ kiá»ƒm tra hÃ¬nh hoÃ n chá»‰nh.</li><li><b>LÆ°u:</b><ul><li>iPhone â†’ Nháº¥n vÃ  giá»¯ áº£nh, chá»n &quot;ThÃªm vÃ o áº¢nh&quot;.</li><li>Android â†’ Nháº¥n vÃ  giá»¯ áº£nh, chá»n &quot;LÆ°u hÃ¬nh áº£nh&quot;.</li></ul></li><li><b>Máº«u Ä‘Æ¡n Ä‘áº·t hÃ ng:</b> Sau khi lÆ°u, báº¥m &quot;Äi tá»›i Form Ä‘áº·t hÃ ng&quot; Ä‘á»ƒ tiáº¿p tá»¥c.</li><li><b>Chia sáº» qua LINE:</b> DÃ¹ng nÃºt á»Ÿ cuá»‘i trang Ä‘á»ƒ gá»­i URL cho báº¡n bÃ¨.</li></ol>"></div>
      <div style="text-align:center; margin-top:20px;">
        <button onclick="document.getElementById('howToModal').style.display='none';" style="padding:10px 20px; border:none; border-radius:20px; background:#f44336; color:white; cursor:pointer;" data-ja="é–‰ã˜ã‚‹" data-en="Close" data-zh="å…³é—­" data-ko="ë‹«ê¸°" data-vi="ÄÃ³ng">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  <h1 id="title" data-ja="Myã†ã¡ã‚ LAB" data-en="Let's Make Our Own Fan!" data-zh="ä¸€èµ·æ¥åˆ¶ä½œæˆ‘ä»¬çš„å›¢æ‰‡ï¼" data-ko="ìš°ë¦¬ë§Œì˜ ë¶€ì±„ë¥¼ ë§Œë“¤ì–´ë³´ì!" data-vi="HÃ£y cÃ¹ng lÃ m quáº¡t giáº¥y cá»§a riÃªng mÃ¬nh!">Myã†ã¡ã‚ LAB</h1>
  <div class="area" id="area-select">
    <h2 data-ja="1)ãƒ‡ã‚¶ã‚¤ãƒ³ï¼†å†™çœŸã‚’é¸ã¶" data-en="1) Selection" data-zh="â‘  é€‰æ‹©è®¾è®¡å’Œç…§ç‰‡" data-ko="â‘  ë””ìì¸ê³¼ ì‚¬ì§„ ì„ íƒ" data-vi="â‘  Chá»n thiáº¿t káº¿ & áº£nh">1)ãƒ‡ã‚¶ã‚¤ãƒ³ï¼†å†™çœŸã‚’é¸ã¶</h2>
    <label id="templateLabel" data-ja="ã†ã¡ã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã‚“ã§ã­ğŸ‘‡" data-en="Choose a fan designğŸ‘‡" data-zh="è¯·é€‰æ‹©ä¸€ä¸ªå›¢æ‰‡è®¾è®¡ğŸ‘‡" data-ko="ë¶€ì±„ ë””ìì¸ì„ ì„ íƒí•˜ì„¸ìš”ğŸ‘‡" data-vi="Chá»n thiáº¿t káº¿ quáº¡tğŸ‘‡">ã†ã¡ã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã‚“ã§ã­ğŸ‘‡</label>
    <select id="templateSelector">
      <option value="fan1-highres.png" data-ja="ç„¡åœ°" data-en="Plain" data-zh="ç´ è‰²" data-ko="ë¬´ì§€" data-vi="TrÆ¡n">ç„¡åœ°</option>
      <option value="fan2-highres.png" data-ja="å¤â‘ " data-en="Summer â‘ " data-zh="å¤å­£â‘ " data-ko="ì—¬ë¦„â‘ " data-vi="MÃ¹a hÃ¨ â‘ ">å¤â‘ </option>
      <option value="fan3-highres.png" data-ja="å¤â‘¡" data-en="Summer â‘¡" data-zh="å¤å­£â‘¡" data-ko="ì—¬ë¦„â‘¡" data-vi="MÃ¹a hÃ¨ â‘¡">å¤â‘¡</option>
    </select>
    <br />
    <label for="imageLoader" id="customFileLabel" data-ja="å†™çœŸã‚’æ’®ã‚‹ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶" data-en="Take Photo / Choose from Library" data-zh="æ‹ç…§ / ä»å›¾åº“é€‰æ‹©" data-ko="ì‚¬ì§„ ì°ê¸° / ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì„ íƒ" data-vi="Chá»¥p áº£nh / Chá»n tá»« thÆ° viá»‡n">å†™çœŸã‚’æ’®ã‚‹ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶</label>
    <input type="file" id="imageLoader" accept="image/*" style="display:none;" />
    <br />
    <p id="reuploadNotice" data-ja="â€» ç”»åƒã¯ä½•åº¦ã§ã‚‚é¸ã³ç›´ã›ã¾ã™ã€‚" data-en="â€» You can re-select the image as many times as you like." data-zh="â€» æ‚¨å¯ä»¥å¤šæ¬¡é‡æ–°é€‰æ‹©å›¾ç‰‡ã€‚" data-ko="â€» ì´ë¯¸ì§€ëŠ” ì–¸ì œë“ ì§€ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-vi="â€» Báº¡n cÃ³ thá»ƒ chá»n láº¡i áº£nh bao nhiÃªu láº§n cÅ©ng Ä‘Æ°á»£c." style="font-size: 12px; color: #666;"></p>
  </div>
  <div class="area" id="area-deco">
    <h2 data-ja="2)ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†" data-en="2) Decorations" data-zh="â‘¡ è£…é¥°ç¼–è¾‘" data-ko="â‘¡ ê¾¸ë¯¸ê¸° í¸ì§‘" data-vi="â‘¡ Chá»‰nh sá»­a trang trÃ­">2)ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†</h2>
    <div id="decoControls">
      <div id="textInputGroup">
        <input type="text" id="customText" placeholder="æ¨ã—ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â™¡" />
        <select id="fontPicker">
          <option value="'M PLUS Rounded 1c', sans-serif" style="font-family: 'M PLUS Rounded 1c', sans-serif">é€šå¸¸</option>
          <option value="'DotGothic16', sans-serif" style="font-family: 'DotGothic16', sans-serif">ãƒ‰ãƒƒãƒˆã‚´ã‚·ãƒƒã‚¯</option>
          <option value="'Train One', cursive" style="font-family: 'Train One', cursive">Train One</option>
          <option value="'Cherry Bomb One', cursive" style="font-family: 'Cherry Bomb One', cursive">æ‰‹æ›¸ãé¢¨</option>
          <option value="'Kaisei Tokumin', serif" style="font-family: 'Kaisei Tokumin', serif">ä¸¸æ–‡å­—</option>
        </select>
        <input type="color" id="colorPicker" value="#ff69b4" title="æ–‡å­—è‰²é¸æŠ" />
        <button id="addTextBtn" data-ja="æ–‡å­—è¿½åŠ " data-en="Add Text" data-zh="æ·»åŠ æ–‡å­—" data-ko="ê¸€ì ì¶”ê°€" data-vi="ThÃªm chá»¯">æ–‡å­—è¿½åŠ </button>
      </div>
      <div id="stampGroup">
        <label>ã‚¹ã‚¿ãƒ³ãƒ—ï¼š</label>
        <button onclick="addStamp('â¤ï¸')">â¤ï¸</button>
        <button onclick="addStamp('â­')">â­</button>
        <button onclick="addStamp('ğŸ¶')">ğŸ¶</button>
        <label>ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ï¼š</label>
        <button class="stamp-img-btn" onclick="addStamp('01loveu.png', true)"><img src="01loveu.png" alt="å¤§å¥½ãã ã‚ˆã‚¹ãƒ†ãƒƒã‚«ãƒ¼" /></button>
        <button class="stamp-img-btn" onclick="addStamp('02ntwithFace.png', true)"><img src="02ntwithFace.png" alt="é¡”ãŒå¤©æ‰ã‚¹ãƒ†ãƒƒã‚«ãƒ¼" /></button>
        <button class="stamp-img-btn" onclick="addStamp('03eyestome.jpg', true)"><img src="03eyestome.jpg" alt="3ç§’è¦‹ã¤ã‚ã¦ã‚¹ãƒ†ãƒƒã‚«ãƒ¼" /></button>
        <button class="stamp-img-btn" onclick="addStamp('04getmyheart.jpg', true)"><img src="04getmyheart.jpg" alt="æ’ƒã¡æŠœã„ã¦ã‚¹ãƒ†ãƒƒã‚«ãƒ¼" /></button>
      </div>
    </div>
    <div id="editTools">
        <button id="undoBtn" data-ja="å…ƒã«æˆ»ã™" data-en="Undo" data-zh="æ’¤æ¶ˆ" data-ko="ì‹¤í–‰ ì·¨ì†Œ" data-vi="HoÃ n tÃ¡c">å…ƒã«æˆ»ã™</button>
        <button id="redoBtn" data-ja="ã‚„ã‚Šç›´ã™" data-en="Redo" data-zh="é‡åš" data-ko="ë‹¤ì‹œ ì‹¤í–‰" data-vi="LÃ m láº¡i">ã‚„ã‚Šç›´ã™</button>
        <button id="duplicateBtn" data-ja="è¤‡è£½" data-en="Duplicate" data-zh="å¤åˆ¶" data-ko="ë³µì œ" data-vi="Sao chÃ©p">è¤‡è£½</button>
        <button id="deleteBtn" data-ja="å‰Šé™¤" data-en="Delete" data-zh="åˆ é™¤" data-ko="ì‚­ì œ" data-vi="XÃ³a">å‰Šé™¤</button>
        <button id="bringFrontBtn" data-ja="å‰é¢ã¸" data-en="Bring Front" data-zh="ç½®äºé¡¶å±‚" data-ko="ì•ìœ¼ë¡œ" data-vi="LÃªn trÆ°á»›c">å‰é¢ã¸</button>
        <button id="sendBackBtn" data-ja="èƒŒé¢ã¸" data-en="Send Back" data-zh="ç½®äºåº•å±‚" data-ko="ë’¤ë¡œ" data-vi="Ra sau">èƒŒé¢ã¸</button>
    </div>
  </div>
  <div class="area" id="area-canvas">
    <h2 data-ja="3) ãƒ‡ã‚¶ã‚¤ãƒ³ç·¨é›†ã‚¹ãƒšãƒ¼ã‚¹" data-en="3) Canvas" data-zh="â‘¢ è®¾è®¡ç¼–è¾‘åŒº" data-ko="â‘¢ ë””ìì¸ í¸ì§‘ ê³µê°„" data-vi="â‘¢ Khu vá»±c chá»‰nh sá»­a thiáº¿t káº¿">3)ãƒ‡ã‚¶ã‚¤ãƒ³ç·¨é›†ã‚¹ãƒšãƒ¼ã‚¹</h2>
    <div id="canvasWrapper">
      <canvas id="mainCanvas" width="3508" height="2480"></canvas>
    </div>
    <p id="editNotice" data-ja="â€» å†™çœŸã¯1æœ¬ã®æŒ‡ã§ä½ç½®ã‚’å‹•ã‹ã›ã¾ã™ã€‚2æœ¬ã®æŒ‡ã§å¤§ãã•ã‚„å‘ãã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚" data-en="â€» Move the photo with one finger. Pinch to zoom, use two fingers to rotate." data-zh="â€» ç”¨ä¸€æ ¹æ‰‹æŒ‡ç§»åŠ¨ç…§ç‰‡ã€‚æåˆç¼©æ”¾ï¼Œç”¨ä¸¤æ ¹æ‰‹æŒ‡æ—‹è½¬ã€‚" data-ko="â€» ì†ê°€ë½ í•œ ê°œë¡œ ì‚¬ì§„ì„ ì´ë™í•©ë‹ˆë‹¤. ë‘ ì†ê°€ë½ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ ë° íšŒì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-vi="â€» DÃ¹ng má»™t ngÃ³n tay Ä‘á»ƒ di chuyá»ƒn áº£nh. Chá»¥m Ä‘á»ƒ phÃ³ng to/thu nhá», hai ngÃ³n tay Ä‘á»ƒ xoay." style="font-size: 12px; color: #666; margin-bottom: 10px;"></p>
    <p id="decoEditNotice" style="font-size: 12px; color: #666;">â€» æ–‡å­—ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ãƒ»ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã¯ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒ—ã§é¸æŠã€ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€é¸æŠæ ã®ãƒãƒ³ãƒ‰ãƒ«ã§ã‚µã‚¤ã‚ºå¤‰æ›´ãƒ»å›è»¢ãŒã§ãã¾ã™ã€‚</p>
    <button id="saveBtn" data-ja="æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" data-en="Confirm â†’ Preview" data-zh="ç¡®è®¤ â†’ é¢„è§ˆ" data-ko="í™•ì¸ â†’ ë¯¸ë¦¬ë³´ê¸°" data-vi="XÃ¡c nháº­n â†’ Xem trÆ°á»›c">æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    <p id="notice" style="font-size:14px; color:red;"></p>
  </div>
  <div class="area" id="area-result">
    <h2 data-ja="4) å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸" data-en="4) Final Image" data-zh="â‘£ æœ€ç»ˆæ•ˆæœå›¾" data-ko="â‘£ ìµœì¢… ì´ë¯¸ì§€" data-vi="â‘£ HÃ¬nh hoÃ n chá»‰nh">4)å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸</h2>
    <div id="previewWrapper" style="display:none; text-align:center; margin-top:16px;">
      <img id="previewImage" alt="åˆæˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width:90%; border:1px solid #ccc; border-radius:10px;" />
    </div>
    <div id="previewNotice" style="font-size:14px; color:black; margin-top:10px;"></div>
    <br>
    <button id="go-to-form" data-ja="ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€" data-en="ğŸ“ Go to Order Form" data-zh="ğŸ“ å‰å¾€è®¢å•è¡¨å•" data-ko="ğŸ“ ì£¼ë¬¸ ì–‘ì‹ìœ¼ë¡œ ì´ë™" data-vi="ğŸ“ Äi tá»›i Form Ä‘áº·t hÃ ng">ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€</button>
    <div id="manual-link" style="display: none; margin-top: 10px;" data-ja='ãƒ•ã‚©ãƒ¼ãƒ ã«é€²ã‚ãªã„å ´åˆã¯ <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">ã“ã¡ã‚‰</a> ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚' data-en='If you cannot access the form, please click <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">here</a>.' data-zh='å¦‚æœæ— æ³•è¿›å…¥è¡¨å•ï¼Œè¯·ç‚¹å‡» <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">è¿™é‡Œ</a>ã€‚' data-ko='í¼ì— ì ‘ì†í•  ìˆ˜ ì—†ëŠ” ê²½ìš° <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">ì—¬ê¸°</a>ë¥¼ í´ë¦­í•˜ì„¸ìš”.' data-vi='Náº¿u khÃ´ng má»Ÿ Ä‘Æ°á»£c form, vui lÃ²ng nháº¥n <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">táº¡i Ä‘Ã¢y</a>.'>ãƒ•ã‚©ãƒ¼ãƒ ã«é€²ã‚ãªã„å ´åˆã¯ <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">ã“ã¡ã‚‰</a> ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>
    <div class="line-it-button" data-lang="ja" data-type="share-a" data-url="https://chc-chupea.github.io/my-uchiwa-studio/" style="display: inline-block; margin-top: 20px;"></div>
  </div>
  <footer id="footer-text" style="font-size: 6px; color: #888; margin-top: 20px;" data-ja="Â© 2025 Chugoku Shimbun Hanbai Center. Web application developed by Hitomi Sasaki. All rights reserved.<br>ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ ªå¼ä¼šç¤¾ä¸­å›½æ–°èè²©å£²ã‚»ãƒ³ã‚¿ãƒ¼ã®å¾“æ¥­å“¡ã«ã‚ˆã‚‹åœ°åŸŸã‚¤ãƒ™ãƒ³ãƒˆå‘ã‘ã®è‡ªä¸»é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚<br>â€»æœ¬ã‚¢ãƒ—ãƒªã¯å…¬å¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¥­å‹™ã¨ã®è¦ªå’Œæ€§ã‚’è€ƒæ…®ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚" data-en="Â© 2025 Chugoku Shimbun Hanbai Center. Web application developed by Hitomi Sasaki. All rights reserved.<br>This web application is an in-house project developed by an employee for local events.<br>*This is not an official service but is used considering compatibility with business activities." data-zh="Â© 2025 ä¸­å›½æ–°é—»é”€å”®ä¸­å¿ƒã€‚ç”±ä½ä½æœ¨ç³å¼€å‘çš„ç½‘ç»œåº”ç”¨ç¨‹åºã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚<br>è¯¥åº”ç”¨ç¨‹åºæ˜¯ä¸­å›½æ–°é—»é”€å”®ä¸­å¿ƒå‘˜å·¥ä¸ºç¤¾åŒºæ´»åŠ¨è‡ªä¸»å¼€å‘çš„é¡¹ç›®ã€‚<br>*æ­¤åº”ç”¨å¹¶éå®˜æ–¹æœåŠ¡ï¼Œä½†è€ƒè™‘åˆ°ä¸šåŠ¡éœ€è¦è€Œä½¿ç”¨ã€‚" data-ko="Â© 2025 ì£¼ê³ ì¿  ì‹ ë¬¸ íŒë§¤ ì„¼í„°. ì‚¬ì‚¬í‚¤ íˆí† ë¯¸ê°€ ê°œë°œí•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜. ëª¨ë“  ê¶Œë¦¬ ë³´ìœ .<br>ì´ ì›¹ì•±ì€ ì§€ì—­ ì´ë²¤íŠ¸ë¥¼ ìœ„í•´ ì§ì›ì´ ìì²´ ê°œë°œí•œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.<br>*ë³¸ ì•±ì€ ê³µì‹ ì„œë¹„ìŠ¤ê°€ ì•„ë‹ˆì§€ë§Œ ì—…ë¬´ì™€ì˜ ì¹œí™”ì„±ì„ ê³ ë ¤í•˜ì—¬ ì‚¬ìš©ë©ë‹ˆë‹¤." data-vi="Â© 2025 Trung tÃ¢m PhÃ¢n phá»‘i BÃ¡o Chugoku. á»¨ng dá»¥ng web do Hitomi Sasaki phÃ¡t triá»ƒn. Giá»¯ toÃ n quyá»n.<br>á»¨ng dá»¥ng nÃ y lÃ  dá»± Ã¡n tá»± phÃ¡t triá»ƒn cá»§a nhÃ¢n viÃªn cho sá»± kiá»‡n Ä‘á»‹a phÆ°Æ¡ng.<br>*ÄÃ¢y khÃ´ng pháº£i dá»‹ch vá»¥ chÃ­nh thá»©c nhÆ°ng Ä‘Æ°á»£c dÃ¹ng do phÃ¹ há»£p vá»›i cÃ´ng viá»‡c.">Â© 2025 Chugoku Shimbun Hanbai Center. Web application developed by Hitomi Sasaki. All rights reserved.<br>ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ ªå¼ä¼šç¤¾ä¸­å›½æ–°èè²©å£²ã‚»ãƒ³ã‚¿ãƒ¼ã®å¾“æ¥­å“¡ã«ã‚ˆã‚‹åœ°åŸŸã‚¤ãƒ™ãƒ³ãƒˆå‘ã‘ã®è‡ªä¸»é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚<br>â€»æœ¬ã‚¢ãƒ—ãƒªã¯å…¬å¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¥­å‹™ã¨ã®è¦ªå’Œæ€§ã‚’è€ƒæ…®ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚</footer>
  <script>
    const saveWarningTexts = {
      ja: 'âš ï¸ ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã†ã¡ã‚ã«ä½¿ã†ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚',
      en: 'âš ï¸ No file selected yet. Please upload an image.',
      zh: 'âš ï¸ å°šæœªé€‰æ‹©æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ å›¾ç‰‡ã€‚',
      ko: 'âš ï¸ ì•„ì§ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.',
      vi: 'âš ï¸ ChÆ°a chá»n tá»‡p. Vui lÃ²ng táº£i áº£nh lÃªn.',
    };
    
    let currentLang = 'ja';
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let history = [];
    let historyIndex = -1;
    let uploadedImg = null;
    let templateImg = new Image();
    let editableObjects = [];
    let selectedObject = null;
    let dragMode = null;
    let startPoint = { x: 0, y: 0 };
    let startObjectState = null;
    const selectionHandleSize = 40; // é¸æŠãƒãƒ³ãƒ‰ãƒ«ã®ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
    const rotationHandleSize = 60; // å›è»¢ãƒãƒ³ãƒ‰ãƒ«ã®ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰

    const templateSelector = document.getElementById('templateSelector');
    templateImg.src = templateSelector.value;
    templateSelector.addEventListener('change', () => {
      templateImg.src = templateSelector.value;
      saveState();
      draw();
    });

    templateImg.onload = () => draw();
    document.getElementById('imageLoader').addEventListener('change', function(e) {
      const reader = new FileReader();
      reader.onload = function(event) {
        uploadedImg = new Image();
        uploadedImg.onload = () => {
          uploadedImg.x = canvas.width / 2;
          uploadedImg.y = canvas.height / 2;
          uploadedImg.scale = 1;
          uploadedImg.rotation = 0;
          saveState();
          draw();
          document.getElementById('area-canvas').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
        uploadedImg.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    function saveState() {
      history = history.slice(0, historyIndex + 1);
      const state = {
        uploadedImg: uploadedImg ? {
          src: uploadedImg.src, x: uploadedImg.x, y: uploadedImg.y, scale: uploadedImg.scale, rotation: uploadedImg.rotation
        } : null,
        editableObjects: JSON.parse(JSON.stringify(editableObjects))
      };
      history.push(state);
      historyIndex++;
      updateButtonStates();
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        restoreState();
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        restoreState();
      }
    }

    function restoreState() {
      const state = history[historyIndex];
      uploadedImg = state.uploadedImg ? Object.assign(new Image(), { src: state.uploadedImg.src, x: state.uploadedImg.x, y: state.uploadedImg.y, scale: state.uploadedImg.scale, rotation: state.uploadedImg.rotation }) : null;
      uploadedImg.onload = draw;
      editableObjects = state.editableObjects.map(obj => {
        if (obj.type === 'text') return obj;
        if (obj.type === 'image') {
          const newImg = new Image();
          newImg.src = obj.src;
          obj.img = newImg;
          return obj;
        }
      });
      selectedObject = null;
      draw();
      updateButtonStates();
    }
    
    function updateButtonStates() {
        document.getElementById('undoBtn').disabled = historyIndex <= 0;
        document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
        const hasSelection = !!selectedObject;
        document.getElementById('duplicateBtn').disabled = !hasSelection;
        document.getElementById('deleteBtn').disabled = !hasSelection;
        document.getElementById('bringFrontBtn').disabled = !hasSelection || (hasSelection && editableObjects.indexOf(selectedObject) === editableObjects.length - 1);
        document.getElementById('sendBackBtn').disabled = !hasSelection || (hasSelection && editableObjects.indexOf(selectedObject) === 0);
    }
    
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.imageSmoothingEnabled = true;

      if (uploadedImg) {
        ctx.save();
        ctx.translate(uploadedImg.x, uploadedImg.y);
        ctx.rotate(uploadedImg.rotation);
        ctx.scale(uploadedImg.scale, uploadedImg.scale);
        ctx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
        ctx.restore();
      }

      editableObjects.forEach(obj => {
        ctx.save();
        ctx.translate(obj.x, obj.y);
        ctx.rotate(obj.rotation);
        ctx.scale(obj.scale, obj.scale);

        if (obj.type === 'text') {
          ctx.font = `${obj.fontSize}px ${obj.font}`;
          ctx.fillStyle = obj.color;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(obj.text, 0, 0);
        } else if (obj.type === 'image') {
          if (obj.img && obj.img.complete) {
            ctx.drawImage(obj.img, -obj.width / 2, -obj.height / 2, obj.width, obj.height);
          }
        }
        ctx.restore();
      });

      if (templateImg.complete) {
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
      }

      if (selectedObject) {
        drawSelectionHandles(selectedObject);
      }
    }

    function drawSelectionHandles(obj) {
      ctx.save();
      ctx.translate(obj.x, obj.y);
      ctx.rotate(obj.rotation);
      const w = obj.width * obj.scale;
      const h = obj.height * obj.scale;

      ctx.strokeStyle = '#2196f3';
      ctx.lineWidth = 4;
      ctx.setLineDash([10, 10]);
      ctx.strokeRect(-w / 2, -h / 2, w, h);
      ctx.setLineDash([]);

      const handles = [
        { x: -w / 2, y: -h / 2, cursor: 'nw-resize' },
        { x: w / 2, y: -h / 2, cursor: 'ne-resize' },
        { x: w / 2, y: h / 2, cursor: 'se-resize' },
        { x: -w / 2, y: h / 2, cursor: 'sw-resize' },
      ];
      ctx.fillStyle = '#2196f3';
      handles.forEach(h => {
        ctx.beginPath();
        ctx.arc(h.x, h.y, selectionHandleSize / 2, 0, 2 * Math.PI);
        ctx.fill();
        h.cursor = 'nwse-resize';
      });

      ctx.beginPath();
      ctx.arc(0, -h/2 - rotationHandleSize, rotationHandleSize/2, 0, 2 * Math.PI);
      ctx.fillStyle = '#f44336';
      ctx.fill();
      ctx.restore();
    }
    
    function addTextToOverlay() {
      const text = document.getElementById('customText').value;
      if (!text) return;
      const font = document.getElementById('fontPicker').value;
      const color = document.getElementById('colorPicker').value;
      const obj = {
        type: 'text',
        text: text,
        font: font,
        color: color,
        x: canvas.width / 2,
        y: canvas.height / 2,
        scale: 1,
        rotation: 0,
        width: 300,
        height: 100,
        fontSize: 100,
      };
      editableObjects.push(obj);
      selectedObject = obj;
      saveState();
      draw();
    }
    
    function addStamp(content, isImage = false) {
      let obj;
      if (isImage) {
        const img = new Image();
        img.src = content;
        img.onload = () => {
          obj = {
            type: 'image',
            src: content,
            img: img,
            x: canvas.width / 2,
            y: canvas.height / 2,
            scale: 1,
            rotation: 0,
            width: img.naturalWidth,
            height: img.naturalHeight,
          };
          editableObjects.push(obj);
          selectedObject = obj;
          saveState();
          draw();
        };
      } else {
        obj = {
          type: 'text',
          text: content,
          font: 'Arial',
          color: 'black',
          x: canvas.width / 2,
          y: canvas.height / 2,
          scale: 1,
          rotation: 0,
          width: 100,
          height: 100,
          fontSize: 150,
        };
        editableObjects.push(obj);
        selectedObject = obj;
        saveState();
        draw();
      }
    }

    document.getElementById('addTextBtn').addEventListener('click', addTextToOverlay);
    document.getElementById('undoBtn').addEventListener('click', undo);
    document.getElementById('redoBtn').addEventListener('click', redo);
    document.getElementById('duplicateBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const newObj = JSON.parse(JSON.stringify(selectedObject));
      newObj.x += 50;
      newObj.y += 50;
      if (newObj.type === 'image') {
        const img = new Image();
        img.src = newObj.src;
        newObj.img = img;
      }
      editableObjects.push(newObj);
      selectedObject = newObj;
      saveState();
      draw();
    });
    document.getElementById('deleteBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const index = editableObjects.indexOf(selectedObject);
      if (index > -1) {
        editableObjects.splice(index, 1);
        selectedObject = null;
        saveState();
        draw();
      }
    });
    document.getElementById('bringFrontBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const index = editableObjects.indexOf(selectedObject);
      if (index > -1 && index < editableObjects.length - 1) {
        const obj = editableObjects.splice(index, 1)[0];
        editableObjects.push(obj);
        saveState();
        draw();
      }
    });
    document.getElementById('sendBackBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const index = editableObjects.indexOf(selectedObject);
      if (index > 0) {
        const obj = editableObjects.splice(index, 1)[0];
        editableObjects.unshift(obj);
        saveState();
        draw();
      }
    });
    document.getElementById('fontPicker').addEventListener('change', (e) => {
        if (selectedObject && selectedObject.type === 'text') {
            selectedObject.font = e.target.value;
            draw();
            saveState();
        }
    });
    document.getElementById('colorPicker').addEventListener('input', (e) => {
        if (selectedObject && selectedObject.type === 'text') {
            selectedObject.color = e.target.value;
            draw();
            saveState();
        }
    });
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ä¿®æ­£
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);
    canvas.addEventListener('mouseleave', handleMouseUp);
    canvas.addEventListener('wheel', handleMouseWheel);
    canvas.addEventListener('touchstart', handleTouchStart);
    canvas.addEventListener('touchmove', handleTouchMove);
    canvas.addEventListener('touchend', handleTouchEnd);
    canvas.addEventListener('touchcancel', handleTouchEnd);
    
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
      };
    }
    
    function hitTest(obj, x, y) {
      const p = { x, y };
      const cos = Math.cos(-obj.rotation);
      const sin = Math.sin(-obj.rotation);
      const translatedX = p.x - obj.x;
      const translatedY = p.y - obj.y;
      const rotatedX = translatedX * cos - translatedY * sin;
      const rotatedY = translatedX * sin + translatedY * cos;
      const halfWidth = (obj.width * obj.scale) / 2;
      const halfHeight = (obj.height * obj.scale) / 2;
      return rotatedX >= -halfWidth && rotatedX <= halfWidth && rotatedY >= -halfHeight && rotatedY <= halfHeight;
    }

    function getHandleHit(obj, x, y) {
        if (!obj) return null;
        const p = { x, y };
        const cos = Math.cos(-obj.rotation);
        const sin = Math.sin(-obj.rotation);
        const translatedX = p.x - obj.x;
        const translatedY = p.y - obj.y;
        const rotatedX = translatedX * cos - translatedY * sin;
        const rotatedY = translatedX * sin + translatedY * cos;
        const w = obj.width * obj.scale;
        const h = obj.height * obj.scale;
        
        const handles = [
            { x: -w / 2, y: -h / 2, name: 'resize' },
            { x: w / 2, y: -h / 2, name: 'resize' },
            { x: w / 2, y: h / 2, name: 'resize' },
            { x: -w / 2, y: h / 2, name: 'resize' },
        ];
        for (let i = 0; i < handles.length; i++) {
            if (Math.hypot(rotatedX - handles[i].x, rotatedY - handles[i].y) < selectionHandleSize) {
                return 'resize';
            }
        }
        if (Math.hypot(rotatedX, rotatedY + h / 2 + rotationHandleSize) < rotationHandleSize) {
            return 'rotate';
        }
        return null;
    }
    
    function handleMouseDown(e) {
      e.preventDefault();
      const pos = getMousePos(e);
      let hit = false;
      for (let i = editableObjects.length - 1; i >= 0; i--) {
        const obj = editableObjects[i];
        if (hitTest(obj, pos.x, pos.y)) {
          selectedObject = obj;
          const handleType = getHandleHit(selectedObject, pos.x, pos.y);
          if (handleType) {
              dragMode = handleType;
          } else {
              dragMode = 'move';
          }
          hit = true;
          startPoint = { x: pos.x, y: pos.y };
          startObjectState = { x: selectedObject.x, y: selectedObject.y, scale: selectedObject.scale, rotation: selectedObject.rotation };
          break;
        }
      }
      if (uploadedImg && !hit && hitTest(uploadedImg, pos.x, pos.y)) {
          selectedObject = null;
          dragMode = 'move_photo';
          startPoint = { x: pos.x, y: pos.y };
          startObjectState = { x: uploadedImg.x, y: uploadedImg.y, scale: uploadedImg.scale, rotation: uploadedImg.rotation };
      } else if (!hit && !uploadedImg) {
          selectedObject = null;
          dragMode = null;
      }
      if (!hit && uploadedImg) selectedObject = null;
      draw();
      updateButtonStates();
    }
    
    function handleMouseMove(e) {
      e.preventDefault();
      const pos = getMousePos(e);
      if (!dragMode) {
          const handleType = getHandleHit(selectedObject, pos.x, pos.y);
          canvas.style.cursor = handleType ? (handleType === 'resize' ? 'pointer' : 'crosshair') : 'default';
          return;
      }
      const dx = pos.x - startPoint.x;
      const dy = pos.y - startPoint.y;

      if (dragMode === 'move') {
        selectedObject.x = startObjectState.x + dx;
        selectedObject.y = startObjectState.y + dy;
      } else if (dragMode === 'move_photo') {
        uploadedImg.x = startObjectState.x + dx;
        uploadedImg.y = startObjectState.y + dy;
      } else if (dragMode === 'resize') {
        const startDist = Math.hypot(startPoint.x - startObjectState.x, startPoint.y - startObjectState.y);
        const currentDist = Math.hypot(pos.x - selectedObject.x, pos.y - selectedObject.y);
        selectedObject.scale = startObjectState.scale * (currentDist / startDist);
      } else if (dragMode === 'rotate') {
        const angleStart = Math.atan2(startPoint.y - selectedObject.y, startPoint.x - selectedObject.x);
        const angleCurrent = Math.atan2(pos.y - selectedObject.y, pos.x - selectedObject.x);
        selectedObject.rotation = startObjectState.rotation + (angleCurrent - angleStart);
      }
      draw();
    }
    
    function handleMouseUp(e) {
      if (dragMode) saveState();
      dragMode = null;
      canvas.style.cursor = 'default';
    }

    function handleMouseWheel(e) {
      if (!uploadedImg) return;
      e.preventDefault();
      uploadedImg.scale += e.deltaY * -0.001;
      uploadedImg.scale = Math.max(0.1, Math.min(5, uploadedImg.scale));
      draw();
      saveState();
    }

    let lastTouch = null;
    function handleTouchStart(e) {
      e.preventDefault();
      const touches = e.touches;
      if (touches.length === 1) {
        const pos = getMousePos(touches[0]);
        handleMouseDown({ preventDefault: () => {}, clientX: pos.x, clientY: pos.y, button: 0 });
      } else if (touches.length === 2) {
        selectedObject = null;
        dragMode = null;
        lastTouch = touches;
        updateButtonStates();
      }
    }

    function handleTouchMove(e) {
      e.preventDefault();
      const touches = e.touches;
      if (touches.length === 1 && dragMode) {
        const pos = getMousePos(touches[0]);
        handleMouseMove({ preventDefault: () => {}, clientX: pos.x, clientY: pos.y });
      } else if (touches.length === 2 && lastTouch) {
        const p1 = getMousePos(touches[0]);
        const p2 = getMousePos(touches[1]);
        const startP1 = getMousePos(lastTouch[0]);
        const startP2 = getMousePos(lastTouch[1]);
        const dist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
        const startDist = Math.hypot(startP2.x - startP1.x, startP2.y - startP1.y);
        const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
        const startAngle = Math.atan2(startP2.y - startP1.y, startP2.x - startP1.x);

        if (uploadedImg) {
            uploadedImg.scale *= dist / startDist;
            uploadedImg.rotation += angle - startAngle;
        }
        draw();
        lastTouch = touches;
      }
    }
    
    function handleTouchEnd(e) {
      if (dragMode) saveState();
      dragMode = null;
      lastTouch = null;
    }
    
    document.getElementById('saveBtn').addEventListener('click', () => {
      const noticeEl = document.getElementById('notice');
      if (!uploadedImg) {
        noticeEl.textContent = saveWarningTexts[currentLang] || saveWarningTexts['ja'];
        noticeEl.style.color = 'red';
        noticeEl.style.display = 'block';
        setTimeout(() => { noticeEl.textContent = ''; noticeEl.style.display = 'none'; }, 3000);
        return;
      }
      
      const combinedCanvas = document.createElement('canvas');
      combinedCanvas.width = canvas.width;
      combinedCanvas.height = canvas.height;
      const combinedCtx = combinedCanvas.getContext('2d');
      combinedCtx.imageSmoothingEnabled = true;

      if (uploadedImg) {
        combinedCtx.save();
        combinedCtx.translate(uploadedImg.x, uploadedImg.y);
        combinedCtx.rotate(uploadedImg.rotation);
        combinedCtx.scale(uploadedImg.scale, uploadedImg.scale);
        combinedCtx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
        combinedCtx.restore();
      }
      
      editableObjects.forEach(obj => {
        combinedCtx.save();
        combinedCtx.translate(obj.x, obj.y);
        combinedCtx.rotate(obj.rotation);
        combinedCtx.scale(obj.scale, obj.scale);
        if (obj.type === 'text') {
          combinedCtx.font = `${obj.fontSize}px ${obj.font}`;
          combinedCtx.fillStyle = obj.color;
          combinedCtx.textAlign = 'center';
          combinedCtx.textBaseline = 'middle';
          combinedCtx.fillText(obj.text, 0, 0);
        } else if (obj.type === 'image') {
          if (obj.img && obj.img.complete) {
            combinedCtx.drawImage(obj.img, -obj.width / 2, -obj.height / 2, obj.width, obj.height);
          }
        }
        combinedCtx.restore();
      });

      if (templateImg.complete) {
        combinedCtx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
      }
      
      combinedCanvas.toBlob(blob => {
        const errorTexts = {
          ja: 'ç”»åƒä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
          en: 'Failed to create image. Please try again.',
          zh: 'ç”Ÿæˆå›¾åƒå¤±è´¥ã€‚è¯·å†è¯•ä¸€æ¬¡ã€‚',
          ko: 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
          vi: 'Táº¡o hÃ¬nh áº£nh tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.'
        };
        if (!blob) {
          noticeEl.textContent = errorTexts[currentLang] || errorTexts['ja'];
          noticeEl.style.color = 'red';
          return;
        }
        if (window._lastPreviewURL) {
          try { URL.revokeObjectURL(window._lastPreviewURL); } catch (e) {}
          window._lastPreviewURL = null;
        }
        const url = URL.createObjectURL(blob);
        window._lastPreviewURL = url;
        const previewWrapper = document.getElementById('previewWrapper');
        const previewImg = document.getElementById('previewImage');
        previewImg.src = url;
        previewWrapper.style.display = 'block';
        const previewNotice = document.getElementById('previewNotice');
        const previewNoticeTexts = {
          ja: `iPhoneï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œâ€œå†™çœŸâ€ã«è¿½åŠ ã€ã‚’é¸ã‚“ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br><br>Androidï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><br>ä¿å­˜ã§ããŸã‚‰ä¸‹ã®ã€Œæ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç”³è¾¼ã¸ãŠé€²ã¿ãã ã•ã„ã€‚`,
          en: `iPhone: Press and hold ğŸ‘† the image, then select "Add to Photos" to save.<br><br>Android: Press and hold ğŸ‘† the image, then select "Save Image".<br><br>After saving, proceed to the order form below.`,
          zh: `iPhoneï¼šé•¿æŒ‰ğŸ‘†å›¾ç‰‡ï¼Œç„¶åé€‰æ‹©â€œæ·»åŠ åˆ°ç…§ç‰‡â€è¿›è¡Œä¿å­˜ã€‚<br><br>Androidï¼šé•¿æŒ‰ğŸ‘†å›¾ç‰‡ï¼Œç„¶åé€‰æ‹©â€œä¿å­˜å›¾ç‰‡â€ã€‚<br><br>ä¿å­˜åï¼Œè¯·ç‚¹å‡»ä¸‹é¢çš„â€œå‰å¾€è®¢å•è¡¨å•â€ã€‚`,
          ko: `iPhone: ì´ë¯¸ì§€ë¥¼ ğŸ‘† ê¸¸ê²Œ ëˆŒëŸ¬ "ì‚¬ì§„ì— ì¶”ê°€"ë¥¼ ì„ íƒí•˜ì„¸ìš”.<br><br>Android: ì´ë¯¸ì§€ë¥¼ ğŸ‘† ê¸¸ê²Œ ëˆŒëŸ¬ "ì´ë¯¸ì§€ ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”.<br><br>ì €ì¥ í›„ ì•„ë˜ì˜ "ì£¼ë¬¸ ì–‘ì‹ìœ¼ë¡œ ì´ë™" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”.`,
          vi: `iPhone: Nháº¥n vÃ  giá»¯ ğŸ‘† hÃ¬nh, chá»n "ThÃªm vÃ o áº¢nh" Ä‘á»ƒ lÆ°u.<br><br>Android: Nháº¥n vÃ  giá»¯ ğŸ‘† hÃ¬nh, chá»n "LÆ°u hÃ¬nh áº£nh".<br><br>Sau khi lÆ°u, hÃ£y báº¥m nÃºt "Äi tá»›i Form Ä‘áº·t hÃ ng" bÃªn dÆ°á»›i.`
        };
        previewNotice.innerHTML = previewNoticeTexts[currentLang] || previewNoticeTexts['ja'];
        previewWrapper.scrollIntoView({ behavior: 'smooth' });
      }, 'image/png');
    });

    function setLanguage(lang) {
      currentLang = lang;
      document.querySelectorAll('[data-ja]').forEach(el => {
        if (el.dataset[lang]) {
          if (el.tagName === "OPTION" || el.tagName === "BUTTON" || el.tagName === "LABEL") {
            el.textContent = el.dataset[lang];
          } else {
            el.innerHTML = el.dataset[lang];
          }
        }
      });
    }

    document.getElementById('go-to-form').addEventListener('click', function () {
        window.location.href = "https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform";
        setTimeout(() => { document.getElementById('manual-link').style.display = 'block'; }, 5000);
    });
    
    window.addEventListener('load', () => {
      const userLang = navigator.language || navigator.userLanguage;
      if (userLang.startsWith('en')) setLanguage('en');
      else if (userLang.startsWith('zh')) setLanguage('zh');
      else if (userLang.startsWith('ko')) setLanguage('ko');
      else if (userLang.startsWith('vi')) setLanguage('vi');
      else setLanguage('ja');
      saveState();
    });

    document.getElementById('howToBtn').addEventListener('click', () => {
      document.getElementById('howToModal').style.display = 'flex';
    });
  </script>
  <script src="https://www.line-website.com/social-plugins/js/thirdparty/loader.min.js"></script>
</body>
</html>