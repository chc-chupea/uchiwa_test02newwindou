<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Myã†ã¡ã‚ - ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <!-- æ¨ã—æ´»ã«ã´ã£ãŸã‚Šãªãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
  <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=DotGothic16&family=Kaisei+Tokumin&family=Train+One&family=M+PLUS+Rounded+1c:wght@800&family=Kosugi+Maru&family=M+PLUS+1p:wght@800&family=Reggae+One&family=RocknRoll+One&family=Yomogi&family=Hachi+Maru+Pop&display=swap" rel="stylesheet">

  <style>
    /* å…¨ä½“çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      font-family: 'Arial', sans-serif; /* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
      text-align: center;
      background: linear-gradient(135deg, #f0f7ff, #eaf6ff); /* èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      margin: 0;
      padding: 10px;
      color: #333;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #1565c0;
    }
    .area {
      background: #fff; /* ç™½ã„èƒŒæ™¯ã®ã‚«ãƒ¼ãƒ‰ */
      border-radius: 20px; /* è§’ä¸¸ */
      padding: 16px;
      margin-bottom: 16px; /* é–“éš”ã‚’å°‘ã—è©°ã‚ã‚‹ */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* å½± */
    }
    .area h2 {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 12px;
      color: #1565c0;
    }

    /* ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
    #editorWrapper {
      position: relative;
      width: 100%;
      max-width: 900px; /* æœ€å¤§å¹… */
      aspect-ratio: 4 / 3; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š */
      margin: 0 auto;
      background-color: #f9f9f9;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    /* ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚­ãƒ£ãƒ³ãƒã‚¹ */
    #mainCanvas, #overlayCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      touch-action: none; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’ç„¡åŠ¹åŒ– */
    }
    /* ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒï¼ˆä½è§£åƒåº¦ç‰ˆï¼‰ */
    #templateOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€é */
      object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ã¤ã¤è¦ç´ å†…ã«åã‚ã‚‹ */
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    select, input[type="text"], input[type="color"], button, label {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      background: #fff;
      box-sizing: border-box;
    }
    /* ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    button {
      background: #4cafef;
      color: white;
      font-size: 16px;
      padding: 12px 24px;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s, background 0.3s; /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    }
    button:hover {
      background: #2196f3;
      transform: translateY(-2px);
    }
    /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    #customFileLabel {
      background: linear-gradient(135deg, #4cafef, #2196f3);
      color: #fff;
      border-radius: 30px;
      padding: 14px 26px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
      display: inline-block; /* ãƒœã‚¿ãƒ³ã®ã‚ˆã†ã«è¡¨ç¤º */
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
    }
    #customFileLabel:hover {
      background: linear-gradient(135deg, #42a5f5, #1e88e5);
      transform: scale(1.05);
    }
    /* ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .form-button {
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
      padding: 12px 24px;
      margin-top: 20px;
      text-decoration: none;
      font-weight: bold;
      font-size: 18px;
      border-radius: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      display: block;
      width: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ã¦å¹…ã‚’èª¿æ•´ */
      margin-left: auto;
      margin-right: auto;
    }
    .form-button:hover {
      background: linear-gradient(135deg, #1976d2, #0d47a1);
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #previewWrapper img {
      max-width: 100%;
      border: 6px solid #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin-top: 12px;
    }
    /* é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ ç·š */
    .active-object-outline {
      outline: 2px dashed #42a5f5; /* ç‚¹ç·šã§è¡¨ç¤º */
      outline-offset: 5px; /* è¦ç´ ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ */
    }
    /* ã‚¨ãƒ‡ã‚£ã‚¿ã®åˆæœŸèƒŒæ™¯ï¼ˆã†ã¡ã‚ã®å½¢çŠ¶ï¼‰*/
    #editorWrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url(fan1-lowres.png) no-repeat center center / contain; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã†ã¡ã‚ã®å½¢ */
      pointer-events: none;
      opacity: 0.5; /* åŠé€æ˜ */
    }

    /* ã‚¹ã‚¿ãƒ³ãƒ—ãƒœã‚¿ãƒ³å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .stamp-buttons-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px; /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ã‚’å‡ä¸€ã« */
      justify-content: center;
      margin-top: 8px; /* ã‚¹ã‚¿ãƒ³ãƒ—ã‚¨ãƒªã‚¢ã®ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
      margin-bottom: 8px; /* ã‚¹ã‚¿ãƒ³ãƒ—ã‚¨ãƒªã‚¢ã®ä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
    }
    .stamp-buttons-container .stamp-button {
      width: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ã¦å¹…ã‚’èª¿æ•´ */
      min-width: 45px; /* æœ€ä½å¹…ã‚’ç¢ºä¿ã—ã€ã‚¿ãƒƒãƒã—ã‚„ã™ãã™ã‚‹ */
      padding: 8px 12px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
      font-size: 24px; /* çµµæ–‡å­—ã®ã‚µã‚¤ã‚ºã‚’å¤§ãã */
      display: inline-flex; /* flexã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦è¡¨ç¤ºã—ã€ä¸­å¤®æƒãˆ */
      align-items: center;
      justify-content: center;
      height: 45px; /* ãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’å›ºå®š */
      margin: 0; /* flex containerã§gapã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã€å€‹åˆ¥ã®marginã‚’ãƒªã‚»ãƒƒãƒˆ */
      box-shadow: 0 2px 4px rgba(0,0,0,0.15); /* å½±ã‚’å°‘ã—æ§ãˆã‚ã« */
    }

    .stamp-buttons-container .stamp-button img {
        height: 30px; /* ç”»åƒã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
        vertical-align: middle; /* å‚ç›´æ–¹å‘ä¸­å¤®æƒãˆ */
    }

    /* ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼ç”¨ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®èƒŒæ™¯è‰² */
    #backgroundColorPicker {
        background-color: #ffe6f2; /* è–„ã„ãƒ”ãƒ³ã‚¯è‰² */
    }

    /* è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆç”¨ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®èƒŒæ™¯è‰² */
    #colorPicker {
        background-color: #ffe6f2; /* è–„ã„ãƒ”ãƒ³ã‚¯è‰² */
    }

    /* ç·¨é›†ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
    .edit-tools-container {
      display: flex;
      flex-wrap: wrap;
      gap: 3px; /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ã‚’ã•ã‚‰ã«è©°ã‚ã‚‹ */
      justify-content: center;
      margin-top: 8px; /* ç·¨é›†ãƒ„ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’ç¶­æŒ */
    }
    .edit-tools-container button {
        flex: 0 0 auto; /* å›ºå®šå¹…ã«ã›ãšã€å†…å®¹ã«åˆã‚ã›ã¦ä¼¸ç¸® */
        padding: 6px 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«å°ã•ã */
        font-size: 13px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ã•ã‚‰ã«å°ã•ã */
        margin: 0; /* flex containerã§gapã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã€å€‹åˆ¥ã®marginã‚’ãƒªã‚»ãƒƒãƒˆ */
        min-width: 60px; /* æœ€ä½å¹…ã‚’èª¿æ•´ */
    }

    /* è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢å†…ã®è¦ç´ ã®é–“éš”èª¿æ•´ */
    #customText {
      margin-bottom: 8px; /* è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®ä¸‹ãƒãƒ¼ã‚¸ãƒ³ */
      padding: 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚‚å°‘ã—å°ã•ã */
    }
    #area-decorations > h3:nth-of-type(1) + input[type="text"] + div { /* è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆã®ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã¨ãƒ•ã‚©ãƒ³ãƒˆãƒ”ãƒƒã‚«ãƒ¼ã‚’å«ã‚€div */
      margin-top: 8px;
      margin-bottom: 8px;
    }
    #area-decorations button[onclick="addTextToOverlay()"] {
      margin-top: 8px; /* ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ã®ä¸Šãƒãƒ¼ã‚¸ãƒ³ */
      margin-bottom: 16px; /* æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ãƒãƒ¼ã‚¸ãƒ³ */
    }

    /* ã†ã¡ã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³é¸æŠãƒ©ãƒ™ãƒ«ã‹ã‚‰ç¸ã®ç·šã‚’ãªãã™ */
    #templateLabel {
        border: none;
        outline: none;
    }

    /* --- ãƒ•ã‚©ãƒ³ãƒˆé¸æŠãƒœã‚¿ãƒ³ç”¨ã®è¦‹ãŸç›® --- */
    .font-picker-wrap { position: relative; flex: 1; }

    #fontPickerBtn {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: #fff;
      font-size: 16px;
      cursor: pointer;
      text-align: left;
      color: #000;  /* â† ã“ã‚Œã‚’è¿½åŠ  */
    }

    #fontDropdown {
      position: absolute;
      z-index: 9999;
      left: 0;
      right: 0;
      top: calc(100% + 6px);
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      max-height: 260px;
      overflow: auto;
      padding: 6px;
    }

    .font-option {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #f0f0f0;
      margin-bottom: 6px;
      cursor: pointer;
    }

    .font-option:hover { background: #f7fbff; }

    .font-sample { font-size: 20px; line-height: 1.2; }
    .font-name   { font-size: 12px; color: #666; margin-top: 2px; }

    .native-font-select {
      position: absolute !important;
      left: -9999px !important; /* ç”»é¢ã‹ã‚‰ã‚ˆã‘ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å€¤ã¯æ®‹ã™ï¼‰ */
    }

    /* === CapCuté¢¨ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ === */
    .cc-toolbar {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 8px 6px;
      margin: 8px -6px 10px;   /* ç«¯ã¾ã§åºƒããƒ‰ãƒ©ãƒƒã‚°ã§ãã‚‹ã‚ˆã†ã«å°‘ã—ã¯ã¿å‡ºã•ã›ã‚‹ */
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
      scroll-snap-type: x proximity;
    }
    .cc-toolbar::-webkit-scrollbar { display: none; } /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™ï¼ˆã‚¹ãƒãƒ›å‘ã‘ï¼‰ */

    .cc-item {
      flex: 0 0 auto;          /* æ¨ªã«ä¸¦ã¶ï¼ˆæŠ˜ã‚Šè¿”ã•ãªã„ï¼‰ */
      width: 84px;             /* æŒ‡ã§æŠ¼ã—ã‚„ã™ã„å¹… */
      scroll-snap-align: center;
      border: 1px solid #ddd;
      border-radius: 14px;
      background: #fff;
      padding: 8px 6px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.06);
    }
    .cc-item .icon { font-size: 20px; display: block; line-height: 1.2; }
    .cc-item .label { font-size: 12px; color: #333; display: block; margin-top: 4px; }

    .cc-item.active {
      background: linear-gradient(135deg, #e3f2fd, #ffffff);
      border-color: #90caf9;
      box-shadow: 0 3px 10px rgba(33,150,243,.15);
    }

    /* ãƒ‘ãƒãƒ«ï¼ˆãƒ„ãƒ¼ãƒ«ã®ä¸­èº«ï¼‰ */
    .cc-panels { margin-top: 8px; }
    .cc-panel[hidden] { display: none; }

    /* æ—¢å­˜ã®ãƒœã‚¿ãƒ³ç¾¤ãŒãã‚…ã†ãã‚…ã†ã«ãªã‚‰ãªã„ã‚ˆã†ã«å°‘ã—èª¿æ•´ */
    .cc-panel button { margin: 4px 2px; }

  </style>
</head>
<body>

  <h1 id="title">Myã†ã¡ã‚</h1>

  <div class="area" id="area-select">
    <h2 id="section1-title">1) èƒŒæ™¯ã‚’æ±ºã‚ã‚‹</h2>
    <label id="templateLabel">ã†ã¡ã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é¸ã‚“ã§ã­ğŸ‘‡</label>
    <select id="templateSelector">
      <option value="fan1-highres.png" data-lowres="fan1-lowres.png">ç„¡åœ°</option>
      <option value="fan2-highres.png" data-lowres="fan2-lowres.png">å¤ç¥­ã‚Šâ‘ </option>
      <option value="fan3-highres.png" data-lowres="fan3-lowres.png">å¤ç¥­ã‚Šâ‘¡</option>
    </select>
    <label for="imageLoader" id="customFileLabel">å†™çœŸã§èƒŒæ™¯ã‚’ä½œã‚‹</label>
    <input type="file" id="imageLoader" accept="image/*" style="display:none;" />
    <p id="reuploadNotice" style="font-size: 12px; color: #666;">â€» ç”»åƒã¯ä½•åº¦ã§ã‚‚é¸ã³ç›´ã›ã¾ã™ã€‚</p>

    <h3 style="margin-top: 20px;">ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼ã§èƒŒæ™¯ã‚’ä½œã‚‹</h3>
    <input type="color" id="backgroundColorPicker" value="#ff8fff" title="èƒŒæ™¯è‰²é¸æŠ" />
  </div>

  <div class="area" id="area-canvas">
    <h2 id="section2-title">2) ãƒ‡ã‚¶ã‚¤ãƒ³ç·¨é›†ã‚¹ãƒšãƒ¼ã‚¹</h2>
    <div id="editorWrapper">
      <canvas id="mainCanvas" width="3508" height="2480"></canvas>
      <img id="templateOverlay" src="fan1-lowres.png" alt="ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ">
    </div>
    <p id="editNotice" style="font-size: 12px; color: #666; margin-top: 10px;">
      â€» ç”»åƒã¯1æœ¬ã®æŒ‡ã§ä½ç½®ã‚’å‹•ã‹ã›ã¾ã™ã€‚2æœ¬ã®æŒ‡ã§å¤§ãã•ã‚„å‘ãã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
    </p>
    <button id="confirmPhotoBtn" style="margin-top: 10px;">å†™çœŸã®é…ç½®ã‚’ç¢ºå®š</button>
    <button id="reEditPhotoBtn" style="margin-top: 10px; display: none;">å†™çœŸã®å†ç·¨é›†</button>
  </div>

  <div class="area" id="area-decorations" style="display: none;">
    <h2 id="section3-title">3) ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
    <!-- <p id="decorationNotice" style="font-size: 12px; color: #666;">
      â€» ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨é¸æŠã•ã‚Œã€ç§»å‹•ãƒ»ã‚µã‚¤ã‚ºå¤‰æ›´ãƒ»å›è»¢ã§ãã¾ã™ã€‚
    </p> -->

    <!-- â–¼â–¼ ã“ã“ã‹ã‚‰ â€œæ¨ªã‚¹ãƒ©ã‚¤ãƒ‰ ãƒ¡ãƒ‹ãƒ¥ãƒ¼â€ ã‚’è¿½åŠ  â–¼â–¼ -->
    <div class="cc-toolbar" role="tablist">
      <button class="cc-item active" data-target="panel-text">
        <!-- <span class="icon">T</span> --><span class="label">ãƒ†ã‚­ã‚¹ãƒˆ</span>
      </button>
      <button class="cc-item" data-target="panel-stamp">
        <!-- <span class="icon">ğŸŒŸ</span> --><span class="label">ã‚¹ã‚¿ãƒ³ãƒ—</span>
      </button>
      <button class="cc-item" data-target="panel-arrange">
        <!-- <span class="icon">ğŸ“‹</span> --><span class="label">è¤‡è£½ï¼å‰Šé™¤</span>
      </button>
      <button class="cc-item" data-target="panel-history">
        <!-- <span class="icon">â†© â†ª</span> --><span class="label">â†© â†ª</span>
      </button>
      <button class="cc-item" data-target="panel-layer">
        <!-- <span class="icon">â¬†ï¸â¬‡ï¸</span> --><span class="label">ãƒ¬ã‚¤ãƒ¤ãƒ¼</span>
      </button>
    </div>

    <div class="cc-panels">
      <!-- ãƒ†ã‚­ã‚¹ãƒˆ -->
      <section id="panel-text" class="cc-panel">
        <input type="text" id="customText" placeholder="æ¨ã—ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â™¡" />
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
          <input type="color" id="colorPicker" value="#ff69b4" title="æ–‡å­—è‰²é¸æŠ" style="width: 50px;" />
          <select id="fontPicker" class="native-font-select">
            <option value="Arial, sans-serif">Arial</option>
            <option value="'DotGothic16', sans-serif">ãƒ‰ãƒƒãƒˆã‚´ã‚·ãƒƒã‚¯</option>
            <option value="'Train One', cursive">Train One</option>
            <option value="'Cherry Bomb One', cursive">æ‰‹æ›¸ãé¢¨</option>
            <option value="'Kaisei Tokumin', serif">ä¸¸æ–‡å­—</option>
            <option value="'M PLUS Rounded 1c', sans-serif">M PLUS Rounded å¤ªå­—</option>
            <option value="'M PLUS 1p', sans-serif">M PLUS 1p å¤ªå­—</option>
            <option value="'Kosugi Maru', sans-serif">Kosugi Maru</option>
            <option value="'Reggae One', cursive">Reggae One</option>
            <option value="'RocknRoll One', sans-serif">RocknRoll One</option>
            <option value="'Yomogi', cursive">Yomogi</option>
            <option value="'Hachi Maru Pop', cursive">Hachi Maru Pop</option>
          </select>
          <div class="font-picker-wrap">
            <button id="fontPickerBtn" type="button">ãƒ•ã‚©ãƒ³ãƒˆã‚’é¸ã¶</button>
            <div id="fontDropdown" hidden></div>
          </div>
        </div>

        <!-- â–¼ ç¸å–ã‚Šè¨­å®šï¼ˆã“ã“ã‹ã‚‰è¿½åŠ ï¼‰ -->
          <div id="outlineControls" class="control-row" style="margin-bottom: 10px;">
            <label>
              <input type="checkbox" id="outlineToggle" checked>
              ç¸å–ã‚ŠON/OFF
            </label>

            <label style="margin-left:8px;">
              è‰²ï¼š
              <input type="color" id="outlineColorPicker" value="#ffffff" title="ç¸å–ã‚Šè‰²" style="width: 50px;" />
            </label>

            <label style="margin-left:8px;">
              å¤ªã•ï¼š
              <input type="range" id="outlineWidthPercent" min="0" max="30" value="12" step="1">
              <span id="outlineWidthValue">12%</span>
            </label>
          </div>
          <!-- â–² ç¸å–ã‚Šè¨­å®šï¼ˆã“ã“ã¾ã§è¿½åŠ ï¼‰ -->


        <button onclick="addTextToOverlay()">ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>
      </section>

      <!-- ã‚¹ã‚¿ãƒ³ãƒ— -->
      <section id="panel-stamp" class="cc-panel" hidden>
        <h3 style="margin:6px 0 8px;">ã‚¹ã‚¿ãƒ³ãƒ—</h3>
        <div class="stamp-buttons-container">
          <button class="stamp-button" onclick="addStamp('â¤ï¸')">â¤ï¸</button>
          <button class="stamp-button" onclick="addStamp('â­')">â­</button>
          <button class="stamp-button" onclick="addStamp('ğŸ¶')">ğŸ¶</button>
          <button class="stamp-button" onclick="addStamp('01loveu.png')"><img src="01loveu.png" alt="Love You"></button>
          <button class="stamp-button" onclick="addStamp('02ntwithFace.png')"><img src="02ntwithFace.png" alt="NT with Face"></button>
          <button class="stamp-button" onclick="addStamp('03eyestome.png')"><img src="03eyestome.png" alt="Eyes to me"></button>
          <button class="stamp-button" onclick="addStamp('04getmyheart.png')"><img src="04getmyheart.png" alt="Get my heart"></button>
          <button class="stamp-button" onclick="addStamp('05angel.png')"><img src="05angel.png" alt="Angel"></button>
          <button class="stamp-button" onclick="addStamp('06god.png')"><img src="06god.png" alt="God"></button>
          <button class="stamp-button" onclick="addStamp('07precious.png')"><img src="07precious.png" alt="Precious"></button>
          <button class="stamp-button" onclick="addStamp('08osi_pink.png')"><img src="08osi_pink.png" alt="Precious"></button>
          <button class="stamp-button" onclick="addStamp('09osi_yellow.png')"><img src="09osi_yellow.png" alt="Precious"></button>
          <button class="stamp-button" onclick="addStamp('10osi_lightblue.png')"><img src="10osi_lightblue.png" alt="Precious"></button>
          <button class="stamp-button" onclick="addStamp('11osi_green.png')"><img src="11osi_green.png" alt="Precious"></button>
        </div>
      </section>

      <!-- ä¸¦ã¹æ›¿ãˆï¼ˆè¤‡è£½ãƒ»å‰Šé™¤ï¼‰ -->
      <section id="panel-arrange" class="cc-panel" hidden>
        <button id="duplicateBtn">è¤‡è£½</button>
        <button id="deleteBtn" style="background:#f44336;">å‰Šé™¤</button>
      </section>

      <!-- å±¥æ­´ï¼ˆæˆ»ã‚‹ãƒ»ã‚„ã‚Šç›´ã—ï¼‰ -->
      <section id="panel-history" class="cc-panel" hidden>
        <button id="undoBtn">æˆ»ã‚‹</button>
        <button id="redoBtn">ã‚„ã‚Šç›´ã—</button>
      </section>

      <!-- ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå‰é¢/èƒŒé¢ï¼‰ -->
      <section id="panel-layer" class="cc-panel" hidden>
        <button id="sendBackwardBtn">èƒŒé¢ã¸</button>
        <button id="bringForwardBtn">å‰é¢ã¸</button>
      </section>
    </div>
    <!-- â–²â–² ã“ã“ã¾ã§ â€œæ¨ªã‚¹ãƒ©ã‚¤ãƒ‰ ãƒ¡ãƒ‹ãƒ¥ãƒ¼â€ â–²â–² -->

    <!-- ã€Œæ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢å†…ã«ç§»å‹• -->
    <button id="generateBtn" class="form-button" style="margin-top: 20px;">æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
  </div>

  <div class="area" id="area-result" style="display: none;">
    <h2 id="section4-title">4) å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸</h2>
    <div id="previewWrapper">
      <img id="previewImage" alt="åˆæˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />
    </div>
    <div id="previewNotice" style="font-size:14px; color:black; margin-top:10px;"></div>
    <!-- ã€Œæ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ã¯ã“ã“ã«æ®‹ã—ã€JavaScriptã§è¡¨ç¤ºåˆ¶å¾¡ -->
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform?usp=dialog"
       target="_blank"
       class="form-button"
       id="goToOrderFormBtn"
       style="display: none;">ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€</a>
  </div>

  <footer style="font-size: 6px; color: #888; margin-top: 20px;">
    Â© 2025 Chugoku Shimbun Hanbai Center. Web application developed by Hitomi Sasaki. All rights reserved.<br />
    ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ ªå¼ä¼šç¤¾ä¸­å›½æ–°èè²©å£²ã‚»ãƒ³ã‚¿ãƒ¼ã®å¾“æ¥­å“¡ã«ã‚ˆã‚‹åœ°åŸŸã‚¤ãƒ™ãƒ³ãƒˆå‘ã‘ã®è‡ªä¸»é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚<br />
    â€»æœ¬ã‚¢ãƒ—ãƒªã¯å…¬å¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¥­å‹™ã¨ã®è¦ªå’Œæ€§ã‚’è€ƒæ…®ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
  </footer>

  <!-- Hammer.jsã‚’èª­ã¿è¾¼ã¿ï¼šã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚’ã‚ˆã‚Šã‚¹ãƒ ãƒ¼ã‚ºã«ã™ã‚‹ãŸã‚ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <script>

    // â† ã“ã“ã«è¿½åŠ ï¼
      window.addEventListener('DOMContentLoaded', () => {
        // åˆæœŸå€¤ã‚’ãƒ”ãƒ³ã‚¯ã«çµ±ä¸€
        colorPicker.value = "#ff69b4";
        outlineColorPicker.value = "#ffc9d2";

        // è¦‹ãŸç›®ï¼ˆèƒŒæ™¯è‰²ï¼‰ã‚‚æ›´æ–°
        colorPicker.style.backgroundColor = "#ff69b4";
        outlineColorPicker.style.backgroundColor = "#ffc9d2";
      });

    // DOMè¦ç´ ã®å–å¾—
    const mainCanvas = document.getElementById('mainCanvas');
    const ctx = mainCanvas.getContext('2d');
    const templateOverlay = document.getElementById('templateOverlay');
    const imageLoader = document.getElementById('imageLoader');
    const templateSelector = document.getElementById('templateSelector');
    const confirmPhotoBtn = document.getElementById('confirmPhotoBtn');
    const reEditPhotoBtn = document.getElementById('reEditPhotoBtn');
    const generateBtn = document.getElementById('generateBtn');
    const goToOrderFormBtn = document.getElementById('goToOrderFormBtn');
    const customText = document.getElementById('customText');
    const colorPicker = document.getElementById('colorPicker');

    // --- ç¸å–ã‚Šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å‚ç…§ã™ã‚‹ ---
    const outlineToggle = document.getElementById('outlineToggle');
    const outlineColorPicker = document.getElementById('outlineColorPicker');
    const outlineWidthPercent = document.getElementById('outlineWidthPercent');
    const outlineWidthValue = document.getElementById('outlineWidthValue');

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ•°å­—ã‚’è¡¨ç¤ºã«åæ˜ 
    outlineWidthPercent.addEventListener('input', () => {
      outlineWidthValue.textContent = outlineWidthPercent.value + '%';
    });
    const fontPicker = document.getElementById('fontPicker');

    const fontPickerBtn = document.getElementById('fontPickerBtn');
    const fontDropdown  = document.getElementById('fontDropdown');


    // === CapCuté¢¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®è¡¨ç¤ºåˆ‡æ›¿ ===
    const ccToolbar = document.querySelector('.cc-toolbar');
    const ccItems   = document.querySelectorAll('.cc-item');
    const ccPanels  = document.querySelectorAll('.cc-panel');

    function showPanel(id) {
      // ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤º
      ccPanels.forEach(p => p.hidden = (p.id !== id));
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤º
      ccItems.forEach(b => b.classList.toggle('active', b.dataset.target === id));
      // æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã‚’ä¸­å¤®ã¸å¯„ã›ã‚‹ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒã‚¹ãƒƒã¨å‹•ãï¼‰
      const btn = document.querySelector(`.cc-item[data-target="${id}"]`);
      if (btn) btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    ccToolbar.addEventListener('click', (e) => {
      const btn = e.target.closest('.cc-item');
      if (!btn) return;
      showPanel(btn.dataset.target);
    });

    // åˆæœŸè¡¨ç¤ºã¯ã€Œãƒ†ã‚­ã‚¹ãƒˆã€ãƒ‘ãƒãƒ«
    showPanel('panel-text');





    // ã“ã®é…åˆ—ã®é †åºï¼å†…å®¹ã¯ <select id="fontPicker"> ã¨æƒãˆã¦ã„ã¾ã™
    const FONT_CANDIDATES = [
      { name: 'Arial',          value: 'Arial, sans-serif' },
      { name: 'ãƒ‰ãƒƒãƒˆã‚´ã‚·ãƒƒã‚¯',   value: "'DotGothic16', sans-serif" },
      { name: 'Train One',      value: "'Train One', cursive" },
      { name: 'æ‰‹æ›¸ãé¢¨',        value: "'Cherry Bomb One', cursive" },
      { name: 'ä¸¸æ–‡å­—',          value: "'Kaisei Tokumin', serif" },
      { name: 'M PLUS Rounded', value: "'M PLUS Rounded 1c', sans-serif" },
      { name: 'M PLUS 1p', value: "'M PLUS 1p', sans-serif" },
      { name: 'Kosugi Maru', value: "'Kosugi Maru', sans-serif" },
      { name: 'Reggae One', value: "'Reggae One', cursive" },
      { name: 'RocknRoll One', value: "'RocknRoll One', sans-serif" },
      { name: 'Yomogi', value: "'Yomogi', cursive" },
      { name: 'Hachi Maru Pop', value: "'Hachi Maru Pop', cursive" },
    ];

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ä¸­èº«ã‚’ä½œã‚‹
    function buildFontDropdown() {
      fontDropdown.innerHTML = '';
      FONT_CANDIDATES.forEach(f => {
        const item = document.createElement('div');
        item.className = 'font-option';

        const sample = document.createElement('div');
        sample.className = 'font-sample';
        sample.textContent = 'Aaã‚ã‚¢æ„›';
        sample.style.fontFamily = f.value;

        const name = document.createElement('div');
        name.className = 'font-name';
        name.textContent = f.name;

        item.appendChild(sample);
        item.appendChild(name);

        item.addEventListener('click', () => {
          setFont(f.value, f.name);
          fontDropdown.hidden = true;
        });

        fontDropdown.appendChild(item);
      });
    }

    // å®Ÿéš›ã«ãƒ•ã‚©ãƒ³ãƒˆã‚’é¸ã‚“ã ã¨ãã®å‡¦ç†
    function setFont(value, label) {
      // 1) å…ƒã®<select>ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
      fontPicker.value = value;

      // 2) æ—¢å­˜ã®ã€Œchangeã€å‡¦ç†ã‚’ãã®ã¾ã¾å‹•ã‹ã™
      fontPicker.dispatchEvent(new Event('change', { bubbles: true }));

      // 3) ãƒœã‚¿ãƒ³è‡ªä½“ã‚‚é¸ã‚“ã ãƒ•ã‚©ãƒ³ãƒˆã§è¡¨ç¤º
      fontPickerBtn.style.fontFamily = value;
      fontPickerBtn.textContent = 'Aa ã‚ã‚¢æ„› â€“ ' + label;
    }

    // ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ï¼ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
    fontPickerBtn.addEventListener('click', () => {
      fontDropdown.hidden = !fontDropdown.hidden;
    });

    // å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
      const wrap = document.querySelector('.font-picker-wrap');
      if (wrap && !wrap.contains(e.target)) fontDropdown.hidden = true;
    });

    // åˆæœŸåŒ–ï¼šãƒªã‚¹ãƒˆã‚’çµ„ã¿ç«‹ã¦ã¦ã€æœ€åˆã¯ã€Œãƒ•ã‚©ãƒ³ãƒˆã‚’é¸ã¶ã€ã¨è¡¨ç¤ºã ã‘ã™ã‚‹
    buildFontDropdown();
    (() => {
      fontPickerBtn.textContent = 'ãƒ•ã‚©ãƒ³ãƒˆã‚’é¸ã¶';
      fontPickerBtn.style.fontFamily = 'Arial, sans-serif'; // â† ãƒ•ã‚©ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ãŠãã¨è¦‹ã‚„ã™ã„ï¼
    })();




    const previewWrapper = document.getElementById('previewWrapper');
    const previewImage = document.getElementById('previewImage');
    const previewNotice = document.getElementById('previewNotice');
    const areaDecorations = document.getElementById('area-decorations');
    const areaResult = document.getElementById('area-result');
    // è¿½åŠ : èƒŒæ™¯è‰²ãƒ”ãƒƒã‚«ãƒ¼ã®å–å¾—
    const backgroundColorPicker = document.getElementById('backgroundColorPicker');

    // çŠ¶æ…‹å¤‰æ•°
    let uploadedImg = null;
    let photoObject = null;
    let isPhotoLocked = false;
    let decorationObjects = [];
    let selectedObject = null;
    let history = [];
    let historyIndex = -1;
    // è¿½åŠ : èƒŒæ™¯è‰²ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    let backgroundColor = '#ffffff'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç™½

    // ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é–‹å§‹æ™‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹ã¨ã‚¿ãƒƒãƒä¸­å¿ƒ
    var initialObjX, initialObjY, initialObjScale, initialObjRotation;
    var initialTouchCenterX, initialTouchCenterY;
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‹ã‚‰ã‚¿ãƒƒãƒä¸­å¿ƒã¸ã®åˆæœŸãƒ™ã‚¯ãƒˆãƒ«ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»ï¼‰
    var initialVecOffsetX, initialVecOffsetY; 

    // --- å±¥æ­´ç®¡ç†æ©Ÿèƒ½ ---
    /**
     * ç¾åœ¨ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¾ã™ã€‚
     */
    function saveState() {
      // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»¥é™ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã€æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ 
      if (historyIndex < history.length - 1) {
        history = history.slice(0, historyIndex + 1);
      }

      // decorationObjects ã‚’ã€ŒJSONã«ã§ãã‚‹å½¢ã€ã«å¤‰æ›ã™ã‚‹ï¼ˆimg ã¯ src ã«ç½®ãæ›ãˆã‚‹ï¼‰
      const snapshot = decorationObjects.map(obj => {
        if (obj.type === 'image') {
          return {
            id: obj.id,
            type: 'image',
            src: obj.src || (obj.img && obj.img.src) || '',
            x: obj.x,
            y: obj.y,
            scale: obj.scale,
            rotation: obj.rotation,
            width: obj.width,
            height: obj.height
          };
        } else {
          // text ç­‰
          return {
            id: obj.id,
            type: obj.type,
            content: obj.content,
            x: obj.x,
            y: obj.y,
            scale: obj.scale,
            rotation: obj.rotation,
            color: obj.color,
            fontFamily: obj.fontFamily,
            fontSize: obj.fontSize
          };
        }
      });

      history.push(JSON.stringify(snapshot));
      historyIndex++;
    }


    function restoreDecorationsFromSnapshot(snapshotStr) {
      if (!snapshotStr) {
        decorationObjects = [];
        selectedObject = null;
        drawAll();
        return;
      }
      const arr = JSON.parse(snapshotStr);
      decorationObjects = arr.map(item => {
        if (item.type === 'image') {
          // äº‹å‰èª­ã¿è¾¼ã¿æ¸ˆã¿ã® stampImages ãŒã‚ã‚Œã°ä½¿ã„ã€ãªã‘ã‚Œã°æ–°ã—ã„ Image ã‚’ä½œã‚‹
          let img = (typeof stampImages !== 'undefined' && stampImages[item.src]) ? stampImages[item.src] : new Image();
          // stampImages ã«ãªã„å ´åˆã¯ src ã‚’ã‚»ãƒƒãƒˆã—ã¦èª­ã¿è¾¼ã¿é–‹å§‹
          if (!stampImages || !stampImages[item.src]) {
            img.src = item.src;
          }
          // ç”»åƒãŒã¾ã èª­ã¿è¾¼ã¿ä¸­ã§ã‚‚ã€èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å†æç”»ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
          if (!img.complete) {
            img.onload = () => { drawAll(); };
          }
          return {
            id: item.id,
            type: 'image',
            src: item.src,
            img: img,
            x: item.x,
            y: item.y,
            scale: item.scale,
            rotation: item.rotation,
            width: item.width,
            height: item.height
          };
        } else {
          // text ç­‰ã¯ãã®ã¾ã¾æˆ»ã™
          return {
            id: item.id,
            type: item.type,
            content: item.content,
            x: item.x,
            y: item.y,
            scale: item.scale,
            rotation: item.rotation,
            color: item.color,
            fontFamily: item.fontFamily,
            fontSize: item.fontSize
          };
        }
      });

      selectedObject = null;
      drawAll();
    }

    /**
     * ä¸€ã¤å‰ã®ç·¨é›†çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ï¼ˆã‚¢ãƒ³ãƒ‰ã‚¥ï¼‰ã€‚
     */
    function undo() {
      if (historyIndex > 0) {
    historyIndex--;
        restoreDecorationsFromSnapshot(history[historyIndex]);
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        restoreDecorationsFromSnapshot(history[historyIndex]);
      }
    }

    // --- æç”»æ©Ÿèƒ½ ---
    /**
     * å†™çœŸã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã—ã¾ã™ã€‚
     */
    function drawImage() {
      if (!photoObject || !uploadedImg) return;

      ctx.save(); // ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã®çŠ¶æ…‹ã‚’ä¿å­˜
      // å†™çœŸã®ä¸­å¿ƒã‚’åŸºæº–ã«ç§»å‹•ã€å›è»¢ã€æ‹¡å¤§ç¸®å°
      ctx.translate(photoObject.x, photoObject.y);
      ctx.rotate(photoObject.rotation);
      ctx.scale(photoObject.scale, photoObject.scale);
      // ç”»åƒã‚’æç”»ï¼ˆä¸­å¿ƒåº§æ¨™ãŒ0,0ã«ãªã‚‹ã‚ˆã†ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
      ctx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
      ctx.restore(); // ä¿å­˜ã—ãŸçŠ¶æ…‹ã«æˆ»ã™
    }

    /**
     * ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã€ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã—ã¾ã™ã€‚
     */
    function drawDecorations() {
      decorationObjects.forEach(obj => {
        ctx.save();
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‚’åŸºæº–ã«ç§»å‹•ã€å›è»¢ã€æ‹¡å¤§ç¸®å°
        ctx.translate(obj.x, obj.y);
        ctx.rotate(obj.rotation);
        ctx.scale(obj.scale, obj.scale);

        if (obj.type === 'text') {
          ctx.fillStyle = obj.color;

          // â† ç›¸æ®ºã‚’ã‚„ã‚ã‚‹ï¼šãã®ã¾ã¾ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã§æã
          ctx.font = `${obj.fontSize}px ${obj.fontFamily}`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          // --- ç¸å–ã‚Šï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ï¼‰ ---
          if (obj.outlineEnabled) {
            const ratio = obj.outlineWidthRatio || 0.12;
            ctx.lineWidth = Math.max(1, obj.fontSize * ratio);
            ctx.strokeStyle = obj.outlineColor || '#ffffff';
            ctx.lineJoin = 'round';   // è§’ã‚’ä¸¸ãã™ã‚‹
            ctx.miterLimit = 2;
            ctx.strokeText(obj.content, 0, 0);
          }

          // --- æœ¬ä½“ï¼ˆå¡—ã‚Šã¤ã¶ã—ï¼‰ ---
          ctx.fillStyle = obj.color;
          ctx.fillText(obj.content, 0, 0);


        } else if (obj.type === 'image') {
          // ç”»åƒã‚’æç”»ï¼ˆä¸­å¿ƒåº§æ¨™ãŒ0,0ã«ãªã‚‹ã‚ˆã†ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
          ctx.drawImage(obj.img, -obj.width / 2, -obj.height / 2, obj.width, obj.height);
        }

        // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ ç·šã‚’è¡¨ç¤º
        if (obj === selectedObject) {
          ctx.strokeStyle = '#42a5f5';
          ctx.lineWidth = 10 / obj.scale; // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«åˆã‚ã›ã¦ç·šå¹…ã‚’èª¿æ•´
          ctx.setLineDash([20 / obj.scale, 10 / obj.scale]); // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«åˆã‚ã›ã¦ç‚¹ç·šã®é–“éš”ã‚’èª¿æ•´
          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æç”»ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã€æ ç·šã‚’æç”»
          const rectWidth  = obj.type === 'text' ? ctx.measureText(obj.content).width : obj.width;
          const rectHeight = obj.type === 'text' ? obj.fontSize * 1.2 : obj.height;
          ctx.strokeRect(-rectWidth / 2, -rectHeight / 2, rectWidth, rectHeight);
          ctx.setLineDash([]); // ç‚¹ç·šãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        }

        ctx.restore();
      });
    }

    /**
     * ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’ã‚¯ãƒªã‚¢ã—ã€å†™çœŸã¨ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†æç”»ã—ã¾ã™ã€‚
     */
    function drawAll() {
      // 1. ã¾ãšèƒŒæ™¯è‰²ã§å…¨ä½“ã‚’å¡—ã‚Šã¤ã¶ã™
      ctx.fillStyle = backgroundColor;
      ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
      // 2. å†™çœŸã‚’æç”»
      drawImage();
      // 3. ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
      drawDecorations();
    }

    /**
     * ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåº§æ¨™ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã®è«–ç†åº§æ¨™ã«å¤‰æ›ã—ã¾ã™ã€‚
     * @param {number} clientX - ã‚¤ãƒ™ãƒ³ãƒˆã®clientXåº§æ¨™
     * @param {number} clientY - ã‚¤ãƒ™ãƒ³ãƒˆã®clientYåº§æ¨™
     * @returns {{x: number, y: number}} ã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã®åº§æ¨™
     */
    function getCanvasCoords(clientX, clientY) {
      const rect = mainCanvas.getBoundingClientRect(); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç”»é¢ä¸Šã§ã®ä½ç½®ã¨ã‚µã‚¤ã‚º
      const x = (clientX - rect.left) * (mainCanvas.width / rect.width);
      const y = (clientY - rect.top) * (mainCanvas.height / rect.height);
      return { x, y };
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸç‚¹ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¢ƒç•Œå†…ã«ã‚ã‚‹ã‹åˆ¤å®šã—ã¾ã™ã€‚
     * @param {{x: number, y: number}} p - åˆ¤å®šã—ãŸã„ç‚¹ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ï¼‰
     * @param {object} obj - åˆ¤å®šå¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {boolean} ç‚¹ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã«ã‚ã‚‹ã‹
     */
    function isPointInObject(p, obj) {
      // 1. ç‚¹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ã«å¤‰æ›ã™ã‚‹ (é€†å¤‰æ›)
      // ã¾ãšã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‚’åŸç‚¹ã«ç§»å‹•
      const translatedX = p.x - obj.x;
      const translatedY = p.y - obj.y;

      // å›è»¢ã‚’å…ƒã«æˆ»ã™
      const cos = Math.cos(-obj.rotation);
      const sin = Math.sin(-obj.rotation);
      const rotatedX = translatedX * cos - translatedY * sin;
      const rotatedY = translatedX * sin + translatedY * cos;

      // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å…ƒã«æˆ»ã™
      const scaledX = rotatedX / obj.scale;
      const scaledY = rotatedY / obj.scale;

      // 2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ã§ã®å¹…ã¨é«˜ã•ã‚’è¨ˆç®—
      let objWidth, objHeight;
      if (obj.type === 'text') {
        // ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã€ç¾åœ¨ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã§ãƒ†ã‚­ã‚¹ãƒˆã®å®Ÿéš›ã®å¹…ã‚’æ¸¬å®š
        ctx.save();
        ctx.font = `${obj.fontSize}px ${obj.fontFamily}`; // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã§æ¸¬å®š
        objWidth = ctx.measureText(obj.content).width;
        objHeight = obj.fontSize * 1.2; // ãƒ†ã‚­ã‚¹ãƒˆã®é«˜ã•ã¯è¡Œé«˜ã‚’è€ƒæ…®
        ctx.restore();
      } else if (obj.type === 'image') {
        objWidth = obj.width;
        objHeight = obj.height;
      } else {
          return false; // æœªçŸ¥ã®ã‚¿ã‚¤ãƒ—
      }

      const halfObjWidth = objWidth / 2;
      const halfObjHeight = objHeight / 2;

      // 3. å¤‰æ›ã•ã‚ŒãŸç‚¹ãŒã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹å†…ã«ã‚ã‚‹ã‹åˆ¤å®š
      return scaledX >= -halfObjWidth && scaledX <= halfObjWidth &&
             scaledY >= -halfObjHeight && scaledY <= halfObjHeight;
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    /**
     * ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å‡¦ç†
     */
    imageLoader.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        uploadedImg = new Image();
        uploadedImg.onload = () => {
          // å†™çœŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸä½ç½®ã€ã‚¹ã‚±ãƒ¼ãƒ«ã€å›è»¢ã‚’è¨­å®š
          photoObject = {
            x: mainCanvas.width / 2, // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®
            y: mainCanvas.height / 2, // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®
            scale: 1,
            rotation: 0
          };

          // ====> ã“ã“ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ <====
      
          // å†™çœŸãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰èƒŒæ™¯è‰²ã‚’ç™½ã«ãƒªã‚»ãƒƒãƒˆ
                backgroundColor = '#ffffff'; 
                
          // ====> ã“ã“ã¾ã§ <====


          isPhotoLocked = false; // å†™çœŸç·¨é›†ã‚’å¯èƒ½ã«ã™ã‚‹
          reEditPhotoBtn.style.display = 'none'; // å†ç·¨é›†ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤º
          confirmPhotoBtn.style.display = 'block'; // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          areaDecorations.style.display = 'none'; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
          areaResult.style.display = 'none'; // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚‚éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
          drawAll(); // å…¨ä½“ã‚’å†æç”»
        };
        uploadedImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    /**
     * ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é¸æŠå¤‰æ›´å‡¦ç†
     */
    templateSelector.addEventListener('change', e => {
      // ä½è§£åƒåº¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦è¡¨ç¤º
      templateOverlay.src = e.target.selectedOptions[0].dataset.lowres;
    });
    
    // ====> ã“ã®è¡Œã®ç›´å¾Œã«è¿½åŠ  <====

    // æ–°è¦è¿½åŠ : èƒŒæ™¯è‰²ãƒ”ãƒƒã‚«ãƒ¼ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    backgroundColorPicker.addEventListener('input', (e) => {
        backgroundColor = e.target.value; 
        // ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®èƒŒæ™¯è‰²ã‚’ã€é¸æŠã•ã‚ŒãŸè‰²ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°
        e.target.style.backgroundColor = e.target.value; 
        uploadedImg = null; 
        photoObject = null;
        isPhotoLocked = true;
        areaDecorations.style.display = 'block'; 
        reEditPhotoBtn.style.display = 'none';
        confirmPhotoBtn.style.display = 'none';
        drawAll(); 
    });

    // ====> ã“ã“ã¾ã§ <====



    /**
     * å†™çœŸã®é…ç½®ç¢ºå®šãƒœã‚¿ãƒ³ã®å‡¦ç†
     */
    confirmPhotoBtn.addEventListener('click', () => {
      if (!uploadedImg) return; // å†™çœŸãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
      isPhotoLocked = true; // å†™çœŸã‚’ãƒ­ãƒƒã‚¯
      confirmPhotoBtn.style.display = 'none'; // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      reEditPhotoBtn.style.display = 'block'; // å†ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      areaDecorations.style.display = 'block'; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
      document.getElementById('area-decorations').scrollIntoView({ behavior: 'smooth' }); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      saveState(); // æœ€åˆã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜
    });

    /**
     * å†™çœŸã®å†ç·¨é›†ãƒœã‚¿ãƒ³ã®å‡¦ç†
     */
    reEditPhotoBtn.addEventListener('click', () => {
      isPhotoLocked = false; // å†™çœŸã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
      reEditPhotoBtn.style.display = 'none'; // å†ç·¨é›†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      confirmPhotoBtn.style.display = 'block'; // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      areaDecorations.style.display = 'none'; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
      selectedObject = null; // é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£é™¤
      areaResult.style.display = 'none'; // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚‚éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
      drawAll(); // å…¨ä½“ã‚’å†æç”»
    });

    /**
     * æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®å‡¦ç†
     */
    generateBtn.addEventListener('click', () => {
      // ... æ—¢å­˜ã®ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ ...

      // é«˜è§£åƒåº¦ã§ã®æœ€çµ‚ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = mainCanvas.width;
      tempCanvas.height = mainCanvas.height;
      const tempCtx = tempCanvas.getContext('2d');

      // 1. ã¾ãšèƒŒæ™¯è‰²ã§å…¨ä½“ã‚’å¡—ã‚Šã¤ã¶ã™
      tempCtx.fillStyle = backgroundColor;
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

      // 2. å†™çœŸã‚’æç”»ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if (uploadedImg) {
        tempCtx.save();
        tempCtx.translate(photoObject.x, photoObject.y);
        tempCtx.rotate(photoObject.rotation);
        tempCtx.scale(photoObject.scale, photoObject.scale);
        tempCtx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
        tempCtx.restore();
      }

      // 3. ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
      decorationObjects.forEach(obj => {
        tempCtx.save();
        tempCtx.translate(obj.x, obj.y);
        tempCtx.rotate(obj.rotation);
        tempCtx.scale(obj.scale, obj.scale);

        if (obj.type === 'text') {
          tempCtx.font = `${obj.fontSize}px ${obj.fontFamily}`;
          tempCtx.textAlign = 'center';
          tempCtx.textBaseline = 'middle';

          // --- ç¸å–ã‚Šï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ï¼‰ ---
          if (obj.outlineEnabled) {
            const ratio = obj.outlineWidthRatio || 0.12;
            tempCtx.lineWidth = Math.max(1, obj.fontSize * ratio);
            tempCtx.strokeStyle = obj.outlineColor || '#ffffff';
            tempCtx.lineJoin = 'round'; // è§’ã‚’ä¸¸ãã™ã‚‹
            tempCtx.miterLimit = 2;
            tempCtx.strokeText(obj.content, 0, 0);
          }

          // --- æœ¬ä½“ï¼ˆå¡—ã‚Šã¤ã¶ã—ï¼‰ ---
          tempCtx.fillStyle = obj.color;
          tempCtx.fillText(obj.content, 0, 0);

        } else if (obj.type === 'image') {
          tempCtx.drawImage(obj.img, -obj.width / 2, -obj.height / 2, obj.width, obj.height);
        }

        tempCtx.restore();
      });

      // 4. é«˜è§£åƒåº¦ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é‡ã­ã‚‹
      const templateHighRes = new Image();
      templateHighRes.onload = () => {
        tempCtx.drawImage(templateHighRes, 0, 0, tempCanvas.width, tempCanvas.height);
        previewImage.src = tempCanvas.toDataURL('image/png'); // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’DataURLã¨ã—ã¦è¨­å®š

        areaResult.style.display = 'block'; // â˜… å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢å…¨ä½“ã‚’è¡¨ç¤º
        previewWrapper.style.display = 'block'; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        goToOrderFormBtn.style.display = 'block'; // æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º

        // ä¿å­˜æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        previewNotice.innerHTML = `iPhoneï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œâ€œå†™çœŸâ€ã«è¿½åŠ ã€ã‚’é¸ã‚“ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br>Androidï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`;
        areaResult.scrollIntoView({ behavior: 'smooth' }); // å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      };
      templateHighRes.src = templateSelector.value; // é¸æŠã•ã‚ŒãŸé«˜è§£åƒåº¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€
    });

    // --- ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ æ©Ÿèƒ½ ---
    /**
     * è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚
     */
    function addTextToOverlay() {
      const text = customText.value.trim();
      if (!text) return; // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
      const newText = {
        id: Date.now(), // ä¸€æ„ãªID
        type: 'text',
        content: text,
        x: mainCanvas.width / 2, // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®ã«é…ç½®
        y: mainCanvas.height / 2,
        scale: 1,
        rotation: 0,
        color: colorPicker.value,
        fontFamily: fontPicker.value,
        fontSize: 500, // åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º

        outlineEnabled: outlineToggle.checked,
        outlineColor: outlineColorPicker.value,
        outlineWidthRatio: parseInt(outlineWidthPercent.value, 10) / 100,
      };

      decorationObjects.push(newText); // é…åˆ—ã«è¿½åŠ 
      selectedObject = newText; // è¿½åŠ ã—ãŸã‚‚ã®ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      drawAll(); // å…¨ä½“ã‚’å†æç”»
      saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
    }

    // PNGã‚¹ãƒ†ãƒƒã‚«ãƒ¼ç”»åƒã‚’äº‹å‰ã«èª­ã¿è¾¼ã‚€
    const stampImages = {};
    const pngStickers = ['01loveu.png', '02ntwithFace.png', '03eyestome.png', '04getmyheart.png',  '05angel.png', '06god.png', '07precious.png'];
    pngStickers.forEach(src => {
      const img = new Image();
      img.src = src;
      img.onload = () => {
        stampImages[src] = img; // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ ¼ç´
      };
    });

    /**
     * ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆçµµæ–‡å­—ã¾ãŸã¯PNGç”»åƒï¼‰ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚
     * @param {string} content - çµµæ–‡å­—æ–‡å­—åˆ—ã¾ãŸã¯PNGç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å
     */
    function addStamp(content) { 
      if (content.endsWith('.png')) {
        // ç”»åƒã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã®å ´åˆ
        const img = new Image();
        img.src = content;

        const newStamp = {
          id: Date.now(),
          type: 'image',
          src: content,
          img: img,
          x: mainCanvas.width / 2,
          y: mainCanvas.height / 2,
          scale: 1,
          rotation: 0,
          width: 200,  // ä»®ã®ã‚µã‚¤ã‚ºï¼ˆèª­ã¿è¾¼ã¿å‰ï¼‰
          height: 200
        };

        img.onload = () => {
          // æœ¬å½“ã®ã‚µã‚¤ã‚ºã‚’ã‚»ãƒƒãƒˆ
          newStamp.width = img.naturalWidth;
          newStamp.height = img.naturalHeight;

          // å¤§ãã™ãã‚‹å ´åˆã¯ãƒªã‚µã‚¤ã‚º
          const maxDim = Math.max(newStamp.width, newStamp.height);
          const targetSize = 400; // åˆæœŸè¡¨ç¤ºã‚µã‚¤ã‚ºã®ç›®æ¨™
          if (maxDim > targetSize) {
            const scaleFactor = targetSize / maxDim;
            newStamp.width *= scaleFactor;
            newStamp.height *= scaleFactor;
          }

          // é…åˆ—ã«è¿½åŠ ãƒ»é¸æŠãƒ»æç”»
          decorationObjects.push(newStamp);
          selectedObject = newStamp;
          drawAll();
          saveState();
        };

      } else {
        // ãƒ†ã‚­ã‚¹ãƒˆã‚„çµµæ–‡å­—ã®å ´åˆ
        const newStamp = {
          id: Date.now(),
          type: 'text',
          content: content,
          x: mainCanvas.width / 2,
          y: mainCanvas.height / 2,
          scale: 1,
          rotation: 0,
          color: 'black',
          fontFamily: 'sans-serif',
          fontSize: 500
        };

        decorationObjects.push(newStamp);
        selectedObject = newStamp;
        drawAll();
        saveState();
      }
    }


    // --- ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç·¨é›†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ---
    /**
     * ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é¸æŠã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
     */
    const _selectBtn = document.getElementById('selectBtn'); // â˜…è¿½åŠ â‘ ï¼šãƒœã‚¿ãƒ³ã‚’å¤‰æ•°ã«å…¥ã‚Œã‚‹
    if (_selectBtn) {                                        // â˜…è¿½åŠ â‘¡ï¼šãƒœã‚¿ãƒ³ãŒã‚ã‚‹æ™‚ã ã‘ä¸­ã‚’å®Ÿè¡Œ
      _selectBtn.addEventListener('click', () => {           // â† å…ƒã®è¡Œã‚’ _selectBtn ã«å·®ã—æ›¿ãˆã¦ä¸­ã¸ç§»å‹•
        if (decorationObjects.length === 0) return;
        const currentIndex = decorationObjects.indexOf(selectedObject);
        const nextIndex = (currentIndex + 1) % decorationObjects.length;
        selectedObject = decorationObjects[nextIndex];
        drawAll();
      });
    } // â† if ã®é–‰ã˜ã‚«ãƒƒã‚³ï¼ˆæ–°è¦ã§ã¯ãªã„ã‘ã©ã€â‘¡ã‚’é–‹ã„ãŸã®ã§ã“ã“ã§é–‰ã˜ã¾ã™ï¼‰

    document.getElementById('undoBtn').addEventListener('click', undo); // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    document.getElementById('redoBtn').addEventListener('click', redo); // ã‚„ã‚Šç›´ã—ãƒœã‚¿ãƒ³

    /**
     * é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚
     */
    document.getElementById('deleteBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      decorationObjects = decorationObjects.filter(obj => obj !== selectedObject); // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é™¤å¤–
      selectedObject = null; // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
      drawAll(); // å…¨ä½“ã‚’å†æç”»
      saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
    });

    /**
     * é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¤‡è£½ã—ã¾ã™ã€‚
     */
    document.getElementById('duplicateBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      // é¸æŠã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸€åº¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã‹ã‚‰æˆ»ã™ï¼ˆimg ã¯æ¶ˆãˆã‚‹ãŒã€å¾Œã§ src ã‹ã‚‰å†ä½œæˆï¼‰
      const plain = JSON.parse(JSON.stringify(selectedObject));
      const newObj = Object.assign({}, plain);
      newObj.id = Date.now();
      newObj.x += 20;
      newObj.y += 20;

      if (newObj.type === 'image') {
        // ç”»åƒã®å ´åˆã¯ src ã‹ã‚‰ Image ã‚’ä½œã‚‹/ä½¿ã†
        const img = (typeof stampImages !== 'undefined' && stampImages[newObj.src]) ? stampImages[newObj.src] : new Image();
        img.src = newObj.src;
        newObj.img = img;
      }

      decorationObjects.push(newObj);
      selectedObject = newObj;
      drawAll();
      saveState();
    });

    /**
     * é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’èƒŒé¢ã¸ç§»å‹•ã—ã¾ã™ã€‚
     */
    document.getElementById('sendBackwardBtn').addEventListener('click', () => {
      const index = decorationObjects.indexOf(selectedObject);
      if (index > 0) { // æœ€å‰é¢ã§ãªã‘ã‚Œã°
        const obj = decorationObjects.splice(index, 1)[0]; // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã‹ã‚‰å–ã‚Šå‡ºã™
        decorationObjects.splice(index - 1, 0, obj); // ä¸€ã¤å‰ã®ä½ç½®ã«æŒ¿å…¥
        drawAll(); // å…¨ä½“ã‚’å†æç”»
        saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
      }
    });

    /**
     * é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚
     */
    document.getElementById('bringForwardBtn').addEventListener('click', () => {
      const index = decorationObjects.indexOf(selectedObject);
      if (index < decorationObjects.length - 1) { // æœ€èƒŒé¢ã§ãªã‘ã‚Œã°
        const obj = decorationObjects.splice(index, 1)[0]; // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã‹ã‚‰å–ã‚Šå‡ºã™
        decorationObjects.splice(index + 1, 0, obj); // ä¸€ã¤å¾Œã®ä½ç½®ã«æŒ¿å…¥
        drawAll(); // å…¨ä½“ã‚’å†æç”»
        saveState(); // çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
      }
    });

    // --- ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° ---
    customText.addEventListener('input', () => {
      if (selectedObject && selectedObject.type === 'text') {
        selectedObject.content = customText.value; // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’æ›´æ–°
        drawAll(); // å…¨ä½“ã‚’å†æç”»
      }
    });

    colorPicker.addEventListener('input', (e) => {
      // è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆç”¨ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®èƒŒæ™¯è‰²ã‚’ã€é¸æŠã•ã‚ŒãŸè‰²ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°
      e.target.style.backgroundColor = e.target.value;

      if (selectedObject && selectedObject.type === 'text') {
        selectedObject.color = colorPicker.value; // è‰²ã‚’æ›´æ–°
        drawAll(); // å…¨ä½“ã‚’å†æç”»
      }
    });

    fontPicker.addEventListener('change', () => {
      if (selectedObject && selectedObject.type === 'text') {
        selectedObject.fontFamily = fontPicker.value; // ãƒ•ã‚©ãƒ³ãƒˆã‚’æ›´æ–°
        drawAll(); // å…¨ä½“ã‚’å†æç”»
      }
    });

    // â† ã“ã®ä¸‹ã«è¿½åŠ ï¼
    outlineColorPicker.addEventListener('input', (e) => {
      // ç¸å–ã‚Šã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®è¦‹ãŸç›®ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°
      e.target.style.backgroundColor = e.target.value;

      if (selectedObject && selectedObject.type === 'text') {
        selectedObject.outlineColor = outlineColorPicker.value;
        drawAll();
      }
    });

    function updateSelectedTextOutline(updater) {
      if (selectedObject && selectedObject.type === 'text') {
        updater(selectedObject);
        drawAll(); // å†æç”»ï¼ˆã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã§ã¯ drawDecorations() ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰
      }
    }

    outlineToggle.addEventListener('change', () => {
      updateSelectedTextOutline(obj => obj.outlineEnabled = outlineToggle.checked);
    });
    outlineColorPicker.addEventListener('input', () => {
      updateSelectedTextOutline(obj => obj.outlineColor = outlineColorPicker.value);
    });
    outlineWidthPercent.addEventListener('input', () => {
      outlineWidthValue.textContent = outlineWidthPercent.value + '%';
      updateSelectedTextOutline(obj => obj.outlineWidthRatio = parseInt(outlineWidthPercent.value, 10) / 100);
    });


    // --- Hammer.js ã«ã‚ˆã‚‹ã‚¿ãƒƒãƒ/ãƒã‚¦ã‚¹ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ---
    const hammertime = new Hammer(mainCanvas);
    hammertime.get('pinch').set({ enable: true });
    hammertime.get('rotate').set({ enable: true });

    // æ“ä½œå¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getActiveObject() {
        if (!isPhotoLocked) {
            return photoObject; // å†™çœŸç·¨é›†ä¸­ã¯å†™çœŸãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
        } else if (selectedObject) {
            return selectedObject; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†ä¸­ã¯é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
        }
        return null; // ä½•ã‚‚æ“ä½œå¯¾è±¡ãŒãªã„å ´åˆ
    }

    // ã‚¿ãƒƒãƒ—ã§ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
    hammertime.on('tap', function(e) {
      if (isPhotoLocked) { // å†™çœŸãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
        const p = getCanvasCoords(e.srcEvent.clientX, e.srcEvent.clientY); // ã‚¿ãƒƒãƒä½ç½®ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«å¤‰æ›
        let found = false;
        // Zã‚ªãƒ¼ãƒ€ãƒ¼ã‚’è€ƒæ…®ã—ã€é…åˆ—ã®æœ€å¾Œï¼ˆæœ€ã‚‚æ‰‹å‰ï¼‰ã‹ã‚‰é€†é †ã«åˆ¤å®š
        for (let i = decorationObjects.length - 1; i >= 0; i--) {
          const obj = decorationObjects[i];
          if (isPointInObject(p, obj)) {
            selectedObject = obj; // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            drawAll(); // å…¨ä½“ã‚’å†æç”»
            found = true;
            break;
          }
        }
        if (!found) { // ã©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚é¸æŠã•ã‚Œãªã‹ã£ãŸå ´åˆ
          selectedObject = null; // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
          drawAll(); // å…¨ä½“ã‚’å†æç”»
        }
      }
    });

    // ãƒ‘ãƒ³ï¼ˆç§»å‹•ï¼‰ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
    hammertime.on('panstart', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            initialObjX = activeObj.x;
            initialObjY = activeObj.y;
            // ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é–‹å§‹æ™‚ã®ã‚¿ãƒƒãƒä¸­å¿ƒç‚¹ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã§è¨˜éŒ²
            const touchCenter = getCanvasCoords(e.center.x, e.center.y);
            initialTouchCenterX = touchCenter.x;
            initialTouchCenterY = touchCenter.y;
        }
    });
    hammertime.on('pan', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            // ç¾åœ¨ã®ã‚¿ãƒƒãƒä¸­å¿ƒç‚¹ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã§å–å¾—
            const currentTouchCenter = getCanvasCoords(e.center.x, e.center.y);
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ–°ã—ã„ä½ç½®ã¯ã€é–‹å§‹æ™‚ã®ä½ç½®ã«ã‚¿ãƒƒãƒä¸­å¿ƒç‚¹ã®ç§»å‹•é‡ã‚’åŠ ç®—
            activeObj.x = initialObjX + (currentTouchCenter.x - initialTouchCenterX);
            activeObj.y = initialObjY + (currentTouchCenter.y - initialTouchCenterY);
            drawAll();
        }
    });
    hammertime.on('panend', function() {
        if(isPhotoLocked) saveState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç§»å‹•å¾Œã«å±¥æ­´ä¿å­˜
    });

    // ãƒ”ãƒ³ãƒï¼ˆæ‹¡å¤§ç¸®å°ï¼‰ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
    hammertime.on('pinchstart', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            initialObjX = activeObj.x;
            initialObjY = activeObj.y;
            initialObjScale = activeObj.scale;
            initialObjRotation = activeObj.rotation; // å›è»¢ã‚‚è€ƒæ…®
            const touchCenter = getCanvasCoords(e.center.x, e.center.y);
            initialTouchCenterX = touchCenter.x;
            initialTouchCenterY = touchCenter.y;

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‹ã‚‰ã‚¿ãƒƒãƒä¸­å¿ƒã¸ã®åˆæœŸãƒ™ã‚¯ãƒˆãƒ« (ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»)
            initialVecOffsetX = initialTouchCenterX - initialObjX;
            initialVecOffsetY = initialTouchCenterY - initialObjY;
        }
    });
    
    // --- ã“ã“ã«è¿½åŠ ã™ã‚‹ ---
    // ã‚¹ã‚±ãƒ¼ãƒ«ã®ç¯„å›²ã‚’åˆ¶é™ã™ã‚‹é–¢æ•°
    function clampScale(s) {
      const MIN = 0.1;   // æœ€å° 10%
      const MAX = 10;    // æœ€å¤§ 10å€
      return Math.min(MAX, Math.max(MIN, s));
    }
    // --- ã“ã“ã¾ã§è¿½åŠ  ---

    hammertime.on('pinch', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            const currentTouchCenter = getCanvasCoords(e.center.x, e.center.y);
            const newScale = initialObjScale * e.scale;
            // newRotationã¯pinchã‚¤ãƒ™ãƒ³ãƒˆã«ã‚‚e.rotationãŒã‚ã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’ä½¿ã†ã‹initialObjRotationã‚’ä½¿ç”¨
            // Hammer.jsã®e.rotationã¯ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é–‹å§‹æ™‚ã‹ã‚‰ã®ç›¸å¯¾å€¤ãªã®ã§ã€ãã®ã¾ã¾åˆ©ç”¨ã™ã‚‹
            const currentRotationDelta = e.rotation * Math.PI / 180; // Hammer.jsã¯åº¦æ•°æ³•ãªã®ã§ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›

            // åˆæœŸãƒ™ã‚¯ãƒˆãƒ«ã‚’ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«å€ç‡ã§ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            const scaledOffsetX = initialVecOffsetX * (newScale / initialObjScale);
            const scaledOffsetY = initialVecOffsetY * (newScale / initialObjScale);

            // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ™ã‚¯ãƒˆãƒ«ã‚’å›è»¢é‡ã®å·®åˆ†ã§å›è»¢
            const cos_rot_delta = Math.cos(currentRotationDelta);
            const sin_rot_delta = Math.sin(currentRotationDelta);

            const transformedOffsetX = scaledOffsetX * cos_rot_delta - scaledOffsetY * sin_rot_delta;
            const transformedOffsetY = scaledOffsetX * sin_rot_delta + scaledOffsetY * cos_rot_delta;

            // æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒ = ç¾åœ¨ã®ã‚¿ãƒƒãƒä¸­å¿ƒ - (ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¿ãƒƒãƒã¸ã®å¤‰æ›æ¸ˆã¿ãƒ™ã‚¯ãƒˆãƒ«)
            activeObj.x = currentTouchCenter.x - transformedOffsetX;
            activeObj.y = currentTouchCenter.y - transformedOffsetY;
            
            activeObj.scale = newScale; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’æ›´æ–°
            activeObj.rotation = initialObjRotation + currentRotationDelta; // å›è»¢ã‚’æ›´æ–° (åˆæœŸå›è»¢ + ãƒ‡ãƒ«ã‚¿)
            drawAll();
        }
    });
    hammertime.on('pinchend', function() {
        if(isPhotoLocked) saveState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‹¡å¤§ç¸®å°å¾Œã«å±¥æ­´ä¿å­˜
    });

    // å›è»¢ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
    hammertime.on('rotatestart', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            initialObjX = activeObj.x;
            initialObjY = activeObj.y;
            initialObjScale = activeObj.scale; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚è€ƒæ…®
            initialObjRotation = activeObj.rotation;
            const touchCenter = getCanvasCoords(e.center.x, e.center.y);
            initialTouchCenterX = touchCenter.x;
            initialTouchCenterY = touchCenter.y;

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‹ã‚‰ã‚¿ãƒƒãƒä¸­å¿ƒã¸ã®åˆæœŸãƒ™ã‚¯ãƒˆãƒ«ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»ï¼‰
            initialVecOffsetX = initialTouchCenterX - initialObjX;
            initialVecOffsetY = initialTouchCenterY - initialObjY;
        }
    });
    hammertime.on('rotate', function(e) {
        const activeObj = getActiveObject();
        if (activeObj) {
            const currentTouchCenter = getCanvasCoords(e.center.x, e.center.y);
            const newRotation = initialObjRotation + e.rotation * Math.PI / 180; // æ–°ã—ã„å›è»¢è§’åº¦ (ãƒ©ã‚¸ã‚¢ãƒ³)
            // scaleã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯rotateã‚¤ãƒ™ãƒ³ãƒˆã«ã‚‚å«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã‹initialObjScaleã‚’ä½¿ç”¨
            const currentScale = initialObjScale * (e.scale || 1); // Hammer.jsã®e.scaleã¯ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é–‹å§‹æ™‚ã‹ã‚‰ã®ç›¸å¯¾å€¤

            // åˆæœŸãƒ™ã‚¯ãƒˆãƒ«ã‚’ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«å€ç‡ã§ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            const scaledOffsetX = initialVecOffsetX * (currentScale / initialObjScale);
            const scaledOffsetY = initialVecOffsetY * (currentScale / initialObjScale);

            // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ™ã‚¯ãƒˆãƒ«ã‚’å›è»¢é‡ã®å·®åˆ†ã§å›è»¢
            const rotationDelta = e.rotation * Math.PI / 180; // Hammer.jsã®e.rotationã¯ãƒ‡ãƒ«ã‚¿
            const cos_rot_delta = Math.cos(rotationDelta);
            const sin_rot_delta = Math.sin(rotationDelta);

            const transformedOffsetX = scaledOffsetX * cos_rot_delta - scaledOffsetY * sin_rot_delta;
            const transformedOffsetY = scaledOffsetX * sin_rot_delta + scaledOffsetY * cos_rot_delta;

            // æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒ = ç¾åœ¨ã®ã‚¿ãƒƒãƒä¸­å¿ƒ - (ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¿ãƒƒãƒã¸ã®å¤‰æ›æ¸ˆã¿ãƒ™ã‚¯ãƒˆãƒ«)
            activeObj.x = currentTouchCenter.x - transformedOffsetX;
            activeObj.y = currentTouchCenter.y - transformedOffsetY;
            
            activeObj.rotation = newRotation; // å›è»¢ã‚’æ›´æ–°
            activeObj.scale = currentScale; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚æ›´æ–°
            drawAll();
        }
    });
    hammertime.on('rotateend', function() {
        if(isPhotoLocked) saveState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›è»¢å¾Œã«å±¥æ­´ä¿å­˜
    });


    // --- PCå‘ã‘ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ---
    let isDragging = false; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
    let lastPos = { x: 0, y: 0 }; // å‰å›ã®ãƒã‚¦ã‚¹ä½ç½® (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåº§æ¨™)
    let dragTarget = null; // 'photo', 'decoration', 'rotate-photo', 'rotate-decoration'

    mainCanvas.addEventListener('mousedown', function(e) {
      const p = getCanvasCoords(e.clientX, e.clientY); // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«å¤‰æ›
      isDragging = true;
      lastPos = { x: e.clientX, y: e.clientY }; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåº§æ¨™ã‚’ä¿å­˜

      if (e.button === 0) { // å·¦ã‚¯ãƒªãƒƒã‚¯ï¼ˆç§»å‹•ï¼‰
        if (!isPhotoLocked) {
          dragTarget = 'photo';
        } else {
          selectedObject = null; // ã¾ãšé¸æŠã‚’è§£é™¤
          // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€†é †ã§æ¢ã—ã€ä¸€ç•ªæ‰‹å‰ã®ã‚‚ã®ã‚’é¸æŠ
          for (let i = decorationObjects.length - 1; i >= 0; i--) {
            const obj = decorationObjects[i];
            if (isPointInObject(p, obj)) {
              selectedObject = obj;
              dragTarget = 'decoration';
              break;
            }
          }
        }
      } else if (e.button === 2) { // å³ã‚¯ãƒªãƒƒã‚¯ï¼ˆå›è»¢ï¼‰
        if (!isPhotoLocked) {
          dragTarget = 'rotate-photo';
        } else if (selectedObject) {
          dragTarget = 'rotate-decoration';
        }
      }
      drawAll();
    });

    mainCanvas.addEventListener('mousemove', function(e) {
      if (!isDragging || !dragTarget) return;

      // ç§»å‹•é‡ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è«–ç†ãƒ”ã‚¯ã‚»ãƒ«ã«å¤‰æ›
      const dx_canvas = (e.clientX - lastPos.x) * (mainCanvas.width / mainCanvas.getBoundingClientRect().width);
      const dy_canvas = (e.clientY - lastPos.y) * (mainCanvas.height / mainCanvas.getBoundingClientRect().height);

      if (dragTarget === 'photo') {
        photoObject.x += dx_canvas;
        photoObject.y += dy_canvas;
      } else if (dragTarget === 'decoration' && selectedObject) {
        selectedObject.x += dx_canvas;
        selectedObject.y += dy_canvas;
      } else if (dragTarget === 'rotate-photo') {
        photoObject.rotation += dx_canvas * 0.0005; // ãƒã‚¦ã‚¹ã®æ¨ªç§»å‹•é‡ã«å¿œã˜ã¦å›è»¢ï¼ˆèª¿æ•´æ¸ˆã¿ï¼‰
      } else if (dragTarget === 'rotate-decoration' && selectedObject) {
        selectedObject.rotation += dx_canvas * 0.0005; // ãƒã‚¦ã‚¹ã®æ¨ªç§»å‹•é‡ã«å¿œã˜ã¦å›è»¢ï¼ˆèª¿æ•´æ¸ˆã¿ï¼‰
      }

      lastPos = { x: e.clientX, y: e.clientY };
      drawAll();
    });

    mainCanvas.addEventListener('mouseup', function(e) {
      isDragging = false;
      dragTarget = null;
      if(isPhotoLocked) saveState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ“ä½œå¾Œã«å±¥æ­´ä¿å­˜
    });

    mainCanvas.addEventListener('mouseleave', function() {
      isDragging = false;
      dragTarget = null;
    });

    // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ–
    mainCanvas.addEventListener('contextmenu', e => e.preventDefault());

    // åˆæœŸæç”»
    drawAll();
  </script>
</body>
</html>