<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Myã†ã¡ã‚ - ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <!-- æ¨ã—æ´»ã«ã´ã£ãŸã‚Šãªãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
  <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=DotGothic16&family=Kaisei+Tokumin&family=Train+One&display=swap" rel="stylesheet">
  <style>
    /* å…¨ä½“çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      font-family: 'Arial', sans-serif; /* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
      text-align: center;
      background: linear-gradient(135deg, #f0f7ff, #eaf6ff); /* èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      margin: 0;
      padding: 10px;
      color: #333;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #1565c0;
    }
    .area {
      background: #fff; /* ç™½ã„èƒŒæ™¯ã®ã‚«ãƒ¼ãƒ‰ */
      border-radius: 20px;
      padding: 20px;
      margin: 10px auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      font-family: 'Cherry Bomb One', cursive; /* æ¨ã—æ´»ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
      font-size: 24px;
      color: #d81b60;
      margin-top: 0;
      border-bottom: 2px solid #ffcdd2;
      padding-bottom: 10px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    canvas {
      border: 3px solid #ff80ab;
      border-radius: 50%;
      background: #fdf0f4;
      box-shadow: 0 0 20px rgba(255, 105, 180, 0.3);
      cursor: grab;
      touch-action: none;
      width: 100%;
      max-width: 400px;
    }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    select, button, input[type="file"] + label, input[type="color"] {
      font-size: 16px;
      padding: 12px 20px;
      border-radius: 10px;
      border: 2px solid #ff80ab;
      background: #fff;
      color: #ff80ab;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    button:hover, input[type="file"] + label:hover {
      background: #ff80ab;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.2);
    }
    button:active, input[type="file"] + label:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #customFileLabel {
      display: inline-block;
    }

    /* ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #decorationButtons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    #decorationButtons img {
      width: 50px;
      height: 50px;
      cursor: pointer;
      padding: 5px;
      border: 2px solid transparent;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    #decorationButtons img:hover {
      border-color: #ff80ab;
      transform: scale(1.1);
    }
    
    /* ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #textInputArea input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin: 5px;
    }
    #textInputArea button {
      margin-left: 10px;
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
    #previewWrapper {
      border: 3px solid #ff80ab;
      border-radius: 20px;
      padding: 10px;
      background: #fff;
      margin: 20px auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 450px;
      display: none;
    }
    #previewImage {
      width: 100%;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* ãƒœã‚¿ãƒ³ã®èª¿æ•´ */
    .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .button-group button {
      flex: 1 1 auto;
      min-width: 150px;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—/ã‚¬ã‚¤ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    /* ãƒ›ãƒãƒ¼ã§ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º */
    canvas:hover .tooltip {
      opacity: 1;
    }
    
    /* é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ ç·š */
    .decoration-selected {
      border-color: #ff1493 !important; /* å¼·èª¿è¡¨ç¤º */
      border-style: dashed !important;
    }
  </style>
</head>
<body>

<h1>Myã†ã¡ã‚</h1>

<div class="area" id="area-select">
    <h2 id="section1-title">1) èƒŒæ™¯ã‚’é¸ã¶</h2>
    
    <!-- è¿½åŠ : èƒŒæ™¯è‰²é¸æŠã‚¨ãƒªã‚¢ -->
    <div style="margin-bottom: 10px;">
      <label for="backgroundColorPicker" style="display: block; margin-bottom: 5px;">æ¨ã—ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ©ãƒ¼ã‚’é¸ã‚“ã§ã­ğŸ‘‡</label>
      <input type="color" id="backgroundColorPicker" value="#ff69b4" style="width: 100px; padding: 5px; height: 40px; border-radius: 8px; cursor: pointer;">
    </div>
    <button id="setBackgroundColorBtn" style="margin-bottom: 15px;">èƒŒæ™¯ã«è¨­å®šã™ã‚‹</button>

    <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">

    <label id="templateLabel" style="margin-top: 20px;">ã†ã¡ã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã‚“ã§ã­ğŸ‘‡</label>
    <select id="templateSelector">
      <option value="https://i.ibb.co/L63vF1m/fan1-highres.png" data-lowres="https://i.ibb.co/3s3B46J/fan1-lowres.png">ç„¡åœ°</option>
      <option value="https://i.ibb.co/q7776fH/fan2-highres.png" data-lowres="https://i.ibb.co/p33sFzG/fan2-lowres.png">å¤ç¥­ã‚Šâ‘ </option>
      <option value="https://i.ibb.co/Jz5T155/fan3-highres.png" data-lowres="https://i.ibb.co/6P6XgC5/fan3-lowres.png">å¤ç¥­ã‚Šâ‘¡</option>
    </select>

    <label for="imageLoader" id="customFileLabel">å†™çœŸã‚’æ’®ã‚‹ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶</label>
    <input type="file" id="imageLoader" accept="image/*" style="display:none;" />
    <p id="reuploadNotice" style="font-size: 12px; color: #666;">â€» èƒŒæ™¯ã¯ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ã€‚</p>
</div>

<div class="area">
  <canvas id="mainCanvas" width="800" height="800"></canvas>
  <img id="templateOverlay" src="" style="display:none;"/>
  <div class="button-group">
    <button id="confirmPhotoBtn">å†™çœŸ/èƒŒæ™¯ã‚’ç¢ºå®š</button>
    <button id="reEditPhotoBtn" style="display:none;">å†™çœŸ/èƒŒæ™¯ã‚’ç·¨é›†ã—ç›´ã™</button>
  </div>
</div>

<div class="area" id="area-decorations" style="display:none;">
    <h2>2) ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹</h2>
    <div id="textInputArea" style="margin-bottom: 10px;">
        <input type="text" id="customText" placeholder="å¥½ããªæ–‡å­—ã‚’å…¥åŠ›ï¼" maxlength="15" style="width: 60%;"/>
        <button id="addTextBtn">æ–‡å­—ã‚’è¿½åŠ </button>
    </div>
    <div style="margin-bottom: 10px;">
        <label for="fontPicker">ãƒ•ã‚©ãƒ³ãƒˆ:</label>
        <select id="fontPicker">
          <option value="Kaisei Tokumin, serif">æ˜æœä½“</option>
          <option value="Cherry Bomb One, cursive">æ‰‹æ›¸ãé¢¨</option>
          <option value="DotGothic16, sans-serif">ãƒ‰ãƒƒãƒˆçµµ</option>
          <option value="Train One, cursive">ãƒãƒƒãƒ—</option>
        </select>
        <label for="colorPicker">è‰²:</label>
        <input type="color" id="colorPicker" value="#ff69b4">
    </div>

    <hr style="border: 0; border-top: 1px solid #f2f2f2; margin: 15px 0;">

    <h3>ã‚¹ã‚¿ãƒ³ãƒ—</h3>
    <div id="decorationButtons">
      <img src="https://i.ibb.co/wJv06kF/heart.png" alt="heart" />
      <img src="https://i.ibb.co/S7qM4yP/star.png" alt="star" />
      <img src="https://i.ibb.co/y410t1p/ribbon.png" alt="ribbon" />
      <img src="https://i.ibb.co/YyY1q6b/crown.png" alt="crown" />
      <img src="https://i.ibb.co/R2t9g8y/cherry.png" alt="cherry" />
      <img src="https://i.ibb.co/tBf3w1t/flower.png" alt="flower" />
      <img src="https://i.ibb.co/y4v397C/mic.png" alt="mic" />
      <img src="https://i.ibb.co/LNxQf82/musicnote.png" alt="music note" />
      <img src="https://i.ibb.co/tH8yv5X/lightstick.png" alt="lightstick" />
      <img src="https://i.ibb.co/xL38t1t/bear.png" alt="bear" />
    </div>
    
    <div class="button-group">
      <button id="undoBtn">æˆ»ã‚‹</button>
      <button id="deleteBtn" style="display:none;">é¸æŠä¸­ã®ãƒ‡ã‚³ã‚’å‰Šé™¤</button>
    </div>
</div>

<div class="area" id="area-result" style="display:none;">
    <h2>3) å®Œæˆï¼</h2>
    <div id="previewWrapper">
      <img id="previewImage" src="" alt="ã†ã¡ã‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />
      <p id="previewNotice" style="font-size:14px; color:#555; text-align: left;"></p>
    </div>
    <button id="generateBtn">æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    <button id="goToOrderFormBtn" style="display:none;">è³¼å…¥ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€</button>
</div>

<script>
    window.onload = function() {
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
      const mainCanvas = document.getElementById('mainCanvas');
      const ctx = mainCanvas.getContext('2d');
      const templateOverlay = document.getElementById('templateOverlay');
      const imageLoader = document.getElementById('imageLoader');
      const templateSelector = document.getElementById('templateSelector');
      const confirmPhotoBtn = document.getElementById('confirmPhotoBtn');
      const reEditPhotoBtn = document.getElementById('reEditPhotoBtn');
      const generateBtn = document.getElementById('generateBtn');
      const goToOrderFormBtn = document.getElementById('goToOrderFormBtn');
      const customText = document.getElementById('customText');
      const colorPicker = document.getElementById('colorPicker');
      const fontPicker = document.getElementById('fontPicker');
      const previewWrapper = document.getElementById('previewWrapper');
      const previewImage = document.getElementById('previewImage');
      const previewNotice = document.getElementById('previewNotice');
      const areaDecorations = document.getElementById('area-decorations');
      const areaResult = document.getElementById('area-result');
      
      // è¿½åŠ : èƒŒæ™¯è‰²é–¢é€£ã®DOMè¦ç´ ã¨çŠ¶æ…‹å¤‰æ•°
      const backgroundColorPicker = document.getElementById('backgroundColorPicker');
      const setBackgroundColorBtn = document.getElementById('setBackgroundColorBtn');
      let backgroundColor = null; // èƒŒæ™¯è‰²ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°

      // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®DOMè¦ç´ 
      const decorationButtons = document.getElementById('decorationButtons');
      const addTextBtn = document.getElementById('addTextBtn');
      const undoBtn = document.getElementById('undoBtn');
      const deleteBtn = document.getElementById('deleteBtn');

      // çŠ¶æ…‹å¤‰æ•°
      let uploadedImg = null; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸ
      let photoObject = null; // å†™çœŸã®åº§æ¨™ã€ã‚¹ã‚±ãƒ¼ãƒ«ã€å›è»¢ã‚’ç®¡ç†
      let isPhotoLocked = false; // å†™çœŸã®ç·¨é›†çŠ¶æ…‹
      let decorationObjects = []; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
      let selectedObject = null; // ç¾åœ¨é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
      let isDragging = false; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‹ã©ã†ã‹
      let dragTarget = null; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å¯¾è±¡ ('photo', 'decoration', 'rotate-photo', 'rotate-decoration')
      let lastPos = { x: 0, y: 0 }; // æœ€å¾Œã«ãƒã‚¦ã‚¹ãŒã‚ã£ãŸåº§æ¨™
      let history = []; // å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯
      let historyIndex = -1; // ç¾åœ¨ã®å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã«èª¿æ•´
      const fanRatio = 1; // æ‰‡ã®ç¸¦æ¨ªæ¯”
      function resizeCanvas() {
        const parentWidth = mainCanvas.parentElement.clientWidth;
        const size = Math.min(parentWidth, 400); // æœ€å¤§å¹…400px
        mainCanvas.style.width = size + 'px';
        mainCanvas.style.height = (size * fanRatio) + 'px';
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      /**
       * æç”»ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
       */
      function drawAll() {
        // é«˜è§£åƒåº¦ã§ã®æç”»ã‚’è€ƒæ…®
        ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢

        // è¿½åŠ : èƒŒæ™¯è‰²ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ã€ãã‚Œã‚’å¡—ã‚Šã¤ã¶ã™
        if (backgroundColor) {
          ctx.fillStyle = backgroundColor;
          ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
        }
        
        drawImage(); // å†™çœŸã‚’æç”»
        drawDecorations(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
      }

      /**
       * å†™çœŸã‚’æç”»ã—ã¾ã™ã€‚
       */
      function drawImage() {
        if (!uploadedImg || !photoObject) return;

        // å†™çœŸã‚’ä¸­å¤®ã«é…ç½®ã—ã€å›è»¢ã¨ã‚¹ã‚±ãƒ¼ãƒ«ã‚’é©ç”¨
        ctx.save();
        ctx.translate(photoObject.x, photoObject.y);
        ctx.rotate(photoObject.rotation);
        ctx.scale(photoObject.scale, photoObject.scale);
        ctx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
        ctx.restore();

        if (!isPhotoLocked) {
          // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€å†™çœŸã®å‘¨ã‚Šã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’æç”»
          ctx.strokeStyle = '#ff69b4';
          ctx.lineWidth = 4;
          ctx.setLineDash([10, 10]);
          const rectWidth = uploadedImg.width * photoObject.scale;
          const rectHeight = uploadedImg.height * photoObject.scale;
          ctx.strokeRect(photoObject.x - rectWidth / 2, photoObject.y - rectHeight / 2, rectWidth, rectHeight);
          ctx.setLineDash([]);
        }
      }

      /**
       * ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»ã—ã¾ã™ã€‚
       */
      function drawDecorations() {
        decorationObjects.forEach(obj => {
          ctx.save();
          ctx.translate(obj.x, obj.y);
          ctx.rotate(obj.rotation);
          ctx.scale(obj.scale, obj.scale);

          if (obj.type === 'text') {
            ctx.font = `${obj.fontSize}px "${obj.fontFamily}"`;
            ctx.fillStyle = obj.color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(obj.text, 0, 0);
          } else if (obj.type === 'image') {
            // ç”»åƒã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
            ctx.drawImage(obj.image, -obj.size / 2, -obj.size / 2, obj.size, obj.size);
          }

          ctx.restore();

          // é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ ç·šã‚’æç”»
          if (selectedObject && selectedObject.id === obj.id) {
            ctx.strokeStyle = '#ff1493';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            const size = obj.size * obj.scale;
            ctx.strokeRect(obj.x - size / 2, obj.y - size / 2, size, size);
            ctx.setLineDash([]);
          }
        });
      }

      /**
       * å±¥æ­´ã‚’ä¿å­˜ã—ã¾ã™ã€‚
       */
      function saveState() {
        // ç¾åœ¨ã®å±¥æ­´ä»¥é™ã‚’ã‚¯ãƒªã‚¢
        history = history.slice(0, historyIndex + 1);
        history.push(JSON.stringify({
          decorationObjects: decorationObjects,
          isPhotoLocked: isPhotoLocked
        }));
        historyIndex++;
        updateUndoRedoButtons();
      }

      /**
       * å±¥æ­´ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™ã€‚
       */
      function updateUndoRedoButtons() {
        undoBtn.disabled = historyIndex <= 0;
      }

      /**
       * åº§æ¨™ã‹ã‚‰ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç‰¹å®šã—ã¾ã™ã€‚
       */
      function getDecorationAtPosition(x, y) {
        for (let i = decorationObjects.length - 1; i >= 0; i--) {
          const obj = decorationObjects[i];
          const size = (obj.type === 'text' ? 150 : obj.size) * obj.scale;
          const dist = Math.sqrt(Math.pow(x - obj.x, 2) + Math.pow(y - obj.y, 2));
          if (dist < size / 2) {
            return obj;
          }
        }
        return null;
      }

      // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

      // ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ
      templateSelector.addEventListener('change', () => {
        // ç¾åœ¨ã®é«˜è§£åƒåº¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ‘ã‚¹ã‚’ä¿å­˜
        const templatePath = templateSelector.value;
        // ä½è§£åƒåº¦ç‰ˆã«åˆ‡ã‚Šæ›¿ãˆ
        const lowResPath = templateSelector.options[templateSelector.selectedIndex].dataset.lowres;
        templateOverlay.src = lowResPath;
        drawAll(); // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å¤‰æ›´ã‚’åæ˜ 
      });

      // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      imageLoader.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
          uploadedImg = new Image();
          uploadedImg.onload = () => {
            // å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‰èƒŒæ™¯è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
            backgroundColor = null;
            photoObject = {
              x: mainCanvas.width / 2, 
              y: mainCanvas.height / 2, 
              scale: 1,
              rotation: 0
            };
            isPhotoLocked = false; 
            reEditPhotoBtn.style.display = 'none'; 
            confirmPhotoBtn.style.display = 'block'; 
            areaDecorations.style.display = 'none'; 
            areaResult.style.display = 'none';
            drawAll();
          };
          uploadedImg.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      // è¿½åŠ : èƒŒæ™¯è‰²è¨­å®šãƒœã‚¿ãƒ³ã®å‡¦ç†
      setBackgroundColorBtn.addEventListener('click', () => {
        uploadedImg = null; // å†™çœŸã‚’ãƒªã‚»ãƒƒãƒˆ
        photoObject = null; // å†™çœŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆ
        backgroundColor = backgroundColorPicker.value; // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®å€¤ã§èƒŒæ™¯è‰²ã‚’è¨­å®š
        isPhotoLocked = true; // èƒŒæ™¯è‰²ã¯ç·¨é›†ä¸è¦ãªã®ã§ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†ã¸ç§»è¡Œ
        confirmPhotoBtn.style.display = 'none'; 
        reEditPhotoBtn.style.display = 'block';
        areaDecorations.style.display = 'block'; 
        areaResult.style.display = 'none';
        document.getElementById('area-decorations').scrollIntoView({ behavior: 'smooth' }); 
        saveState();
        drawAll(); // å†æç”»
      });

      // å†™çœŸ/èƒŒæ™¯ã‚’ç¢ºå®š
      confirmPhotoBtn.addEventListener('click', () => {
        // å†™çœŸã‹èƒŒæ™¯è‰²ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (!uploadedImg && !backgroundColor) {
          alert('âš ï¸ ã¾ãšå†™çœŸã¾ãŸã¯èƒŒæ™¯è‰²ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        isPhotoLocked = true;
        confirmPhotoBtn.style.display = 'none';
        reEditPhotoBtn.style.display = 'block';
        areaDecorations.style.display = 'block';
        document.getElementById('area-decorations').scrollIntoView({ behavior: 'smooth' });
        saveState();
      });

      // å†™çœŸ/èƒŒæ™¯ã‚’ç·¨é›†ã—ç›´ã™
      reEditPhotoBtn.addEventListener('click', () => {
        isPhotoLocked = false;
        reEditPhotoBtn.style.display = 'none';
        confirmPhotoBtn.style.display = 'block';
        areaDecorations.style.display = 'none';
        selectedObject = null;
        deleteBtn.style.display = 'none';
        areaResult.style.display = 'none';
        if (backgroundColor) {
          backgroundColor = null; // èƒŒæ™¯è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
        }
        drawAll();
      });

      // æ–‡å­—è¿½åŠ 
      addTextBtn.addEventListener('click', () => {
        const text = customText.value;
        if (text.trim() === '') return;

        const newText = {
          id: Date.now(),
          type: 'text',
          text: text,
          x: mainCanvas.width / 2,
          y: mainCanvas.height / 2,
          color: colorPicker.value,
          fontFamily: fontPicker.value,
          fontSize: 60,
          rotation: 0,
          scale: 1,
          size: 150 // ãƒ€ãƒŸãƒ¼ã‚µã‚¤ã‚º
        };
        decorationObjects.push(newText);
        selectedObject = newText;
        deleteBtn.style.display = 'block';
        customText.value = '';
        saveState();
        drawAll();
      });

      // ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
      decorationButtons.addEventListener('click', (e) => {
        if (e.target.tagName !== 'IMG') return;

        const newImage = new Image();
        newImage.onload = () => {
          const newStamp = {
            id: Date.now(),
            type: 'image',
            image: newImage,
            x: mainCanvas.width / 2,
            y: mainCanvas.height / 2,
            size: 100,
            rotation: 0,
            scale: 1
          };
          decorationObjects.push(newStamp);
          selectedObject = newStamp;
          deleteBtn.style.display = 'block';
          saveState();
          drawAll();
        };
        newImage.src = e.target.src;
      });

      // æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      generateBtn.addEventListener('click', () => {
        // å†™çœŸã‚‚èƒŒæ™¯è‰²ã‚‚è¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°è­¦å‘Š
        if (!uploadedImg && !backgroundColor) {
          alert('âš ï¸ ã¾ãšå†™çœŸã¾ãŸã¯èƒŒæ™¯è‰²ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        
        if (!isPhotoLocked) {
          alert('âš ï¸ å†™çœŸã¾ãŸã¯èƒŒæ™¯è‰²ã®è¨­å®šã‚’ç¢ºå®šã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        // é«˜è§£åƒåº¦ã§ã®æœ€çµ‚ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 800; // å…ƒã®è§£åƒåº¦
        tempCanvas.height = 800;
        const tempCtx = tempCanvas.getContext('2d');

        // 1. èƒŒæ™¯è‰²ã¾ãŸã¯å†™çœŸã‚’æç”»
        if (backgroundColor) {
          tempCtx.fillStyle = backgroundColor;
          tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        } else if (uploadedImg) {
          tempCtx.save();
          tempCtx.translate(photoObject.x, photoObject.y);
          tempCtx.rotate(photoObject.rotation);
          tempCtx.scale(photoObject.scale, photoObject.scale);
          tempCtx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
          tempCtx.restore();
        }

        // 2. ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
        decorationObjects.forEach(obj => {
          tempCtx.save();
          tempCtx.translate(obj.x, obj.y);
          tempCtx.rotate(obj.rotation);
          tempCtx.scale(obj.scale, obj.scale);
          if (obj.type === 'text') {
            tempCtx.font = `${obj.fontSize}px "${obj.fontFamily}"`;
            tempCtx.fillStyle = obj.color;
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'middle';
            tempCtx.fillText(obj.text, 0, 0);
          } else if (obj.type === 'image') {
            tempCtx.drawImage(obj.image, -obj.size / 2, -obj.size / 2, obj.size, obj.size);
          }
          tempCtx.restore();
        });

        // 3. é«˜è§£åƒåº¦ã†ã¡ã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é‡ã­ã‚‹
        const templateHighRes = new Image();
        templateHighRes.onload = () => {
          tempCtx.drawImage(templateHighRes, 0, 0, tempCanvas.width, tempCanvas.height);
          previewImage.src = tempCanvas.toDataURL('image/png');
          areaResult.style.display = 'block';
          previewWrapper.style.display = 'block';
          goToOrderFormBtn.style.display = 'block';
          previewNotice.innerHTML = `ğŸŒŸå®Œæˆï¼<br>
          ã“ã®ã†ã¡ã‚ç”»åƒã‚’é•·æŠ¼ã—ï¼ˆPCã¯å³ã‚¯ãƒªãƒƒã‚¯ï¼‰ã§ä¿å­˜ã§ãã¾ã™ã€‚<br>
          <br>
          â€» ã“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã¯ã‚ãã¾ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚å°åˆ·æ™‚ã®ä»•ä¸ŠãŒã‚Šã¯ã€ã”åˆ©ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™ã€‚`;
          areaResult.scrollIntoView({ behavior: 'smooth' });
        };
        templateHighRes.src = templateSelector.value;
      });

      // æˆ»ã‚‹ãƒœã‚¿ãƒ³
      undoBtn.addEventListener('click', () => {
        if (historyIndex > 0) {
          historyIndex--;
          const prevState = JSON.parse(history[historyIndex]);
          decorationObjects = prevState.decorationObjects;
          isPhotoLocked = prevState.isPhotoLocked;
          // ç”»åƒãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯å†åº¦èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹
          decorationObjects.forEach(obj => {
            if (obj.type === 'image') {
              const newImage = new Image();
              newImage.src = obj.image.src;
              obj.image = newImage;
            }
          });
          selectedObject = null;
          deleteBtn.style.display = 'none';
          drawAll();
          updateUndoRedoButtons();
        }
      });

      // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤
      deleteBtn.addEventListener('click', () => {
        if (selectedObject) {
          decorationObjects = decorationObjects.filter(obj => obj.id !== selectedObject.id);
          selectedObject = null;
          deleteBtn.style.display = 'none';
          saveState();
          drawAll();
        }
      });

      // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£ ---
      mainCanvas.addEventListener('mousedown', function(e) {
        if (isPhotoLocked) {
          // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ“ä½œ
          const rect = mainCanvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (mainCanvas.width / rect.width);
          const y = (e.clientY - rect.top) * (mainCanvas.height / rect.height);
          
          selectedObject = getDecorationAtPosition(x, y);
          if (selectedObject) {
            isDragging = true;
            dragTarget = 'decoration';
            lastPos = { x: e.clientX, y: e.clientY };
            deleteBtn.style.display = 'block';
          } else {
            // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯é¸æŠã‚’è§£é™¤
            selectedObject = null;
            deleteBtn.style.display = 'none';
          }
        } else if (photoObject && uploadedImg) {
          // å†™çœŸã®æ“ä½œ
          const rect = mainCanvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (mainCanvas.width / rect.width);
          const y = (e.clientY - rect.top) * (mainCanvas.height / rect.height);
          
          const rectWidth = uploadedImg.width * photoObject.scale;
          const rectHeight = uploadedImg.height * photoObject.scale;
          
          // å†™çœŸã®ç¯„å›²å†…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‹åˆ¤å®š
          if (x > photoObject.x - rectWidth / 2 && x < photoObject.x + rectWidth / 2 &&
              y > photoObject.y - rectHeight / 2 && y < photoObject.y + rectHeight / 2) {
            isDragging = true;
            dragTarget = 'photo';
            lastPos = { x: e.clientX, y: e.clientY };
          }
        }
        drawAll();
      });

      mainCanvas.addEventListener('mousemove', function(e) {
        if (!isDragging || !dragTarget) return;

        // ç§»å‹•é‡ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è«–ç†ãƒ”ã‚¯ã‚»ãƒ«ã«å¤‰æ›
        const dx_canvas = (e.clientX - lastPos.x) * (mainCanvas.width / mainCanvas.getBoundingClientRect().width);
        const dy_canvas = (e.clientY - lastPos.y) * (mainCanvas.height / mainCanvas.getBoundingClientRect().height);

        if (dragTarget === 'photo') {
          photoObject.x += dx_canvas;
          photoObject.y += dy_canvas;
        } else if (dragTarget === 'decoration' && selectedObject) {
          selectedObject.x += dx_canvas;
          selectedObject.y += dy_canvas;
        }

        lastPos = { x: e.clientX, y: e.clientY };
        drawAll();
      });

      mainCanvas.addEventListener('mouseup', function(e) {
        if (isDragging) {
          if (dragTarget === 'decoration' || dragTarget === 'photo') {
            saveState(); // æ“ä½œå®Œäº†æ™‚ã«å±¥æ­´ã‚’ä¿å­˜
          }
        }
        isDragging = false;
        dragTarget = null;
      });

      // ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´ï¼ˆãƒ”ãƒ³ãƒã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆï¼‰
      mainCanvas.addEventListener('wheel', function(e) {
        if (isPhotoLocked) {
          // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´
          if (selectedObject) {
            e.preventDefault();
            const scaleFactor = 1 + e.deltaY * -0.001; // ãƒ›ã‚¤ãƒ¼ãƒ«ã®é‡ã«å¿œã˜ã¦èª¿æ•´
            selectedObject.scale *= scaleFactor;
            saveState();
            drawAll();
          }
        } else if (photoObject) {
          // å†™çœŸã®ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´
          e.preventDefault();
          const scaleFactor = 1 + e.deltaY * -0.001; // ãƒ›ã‚¤ãƒ¼ãƒ«ã®é‡ã«å¿œã˜ã¦èª¿æ•´
          photoObject.scale *= scaleFactor;
          drawAll();
        }
      });
    }
</script>

</body>
</html>