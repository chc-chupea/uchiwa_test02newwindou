<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Myうちわ - デコレーション</title>
  <!-- 推し活にぴったりなフォントを読み込み -->
  <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=DotGothic16&family=Kaisei+Tokumin&family=Train+One&display=swap" rel="stylesheet">
  <style>
    /* 全体的なスタイル */
    body {
      font-family: 'Arial', sans-serif; /* 基本フォント設定 */
      text-align: center;
      background: linear-gradient(135deg, #f0f7ff, #eaf6ff); /* 背景グラデーション */
      margin: 0;
      padding: 10px;
      color: #333;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #1565c0;
    }
    .area {
      background: #fff; /* 白い背景のカード */
      border-radius: 20px;
      padding: 20px;
      margin: 10px auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      font-family: 'Cherry Bomb One', cursive; /* 推し活フォントを適用 */
      font-size: 24px;
      color: #d81b60;
      margin-top: 0;
      border-bottom: 2px solid #ffcdd2;
      padding-bottom: 10px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    canvas {
      border: 3px solid #ff80ab;
      border-radius: 50%;
      background: #fdf0f4;
      box-shadow: 0 0 20px rgba(255, 105, 180, 0.3);
      cursor: grab;
      touch-action: none;
      width: 100%;
      max-width: 400px;
    }
    
    /* フォーム要素のスタイル */
    select, button, input[type="file"] + label, input[type="color"] {
      font-size: 16px;
      padding: 12px 20px;
      border-radius: 10px;
      border: 2px solid #ff80ab;
      background: #fff;
      color: #ff80ab;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    button:hover, input[type="file"] + label:hover {
      background: #ff80ab;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.2);
    }
    button:active, input[type="file"] + label:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #customFileLabel {
      display: inline-block;
    }

    /* デコレーションエリアのスタイル */
    #decorationButtons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    #decorationButtons img {
      width: 50px;
      height: 50px;
      cursor: pointer;
      padding: 5px;
      border: 2px solid transparent;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    #decorationButtons img:hover {
      border-color: #ff80ab;
      transform: scale(1.1);
    }
    
    /* テキスト入力関連のスタイル */
    #textInputArea input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin: 5px;
    }
    #textInputArea button {
      margin-left: 10px;
    }

    /* プレビューエリア */
    #previewWrapper {
      border: 3px solid #ff80ab;
      border-radius: 20px;
      padding: 10px;
      background: #fff;
      margin: 20px auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 450px;
      display: none;
    }
    #previewImage {
      width: 100%;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* ボタンの調整 */
    .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .button-group button {
      flex: 1 1 auto;
      min-width: 150px;
    }

    /* ツールチップ/ガイドのスタイル */
    .tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    /* ホバーでツールチップ表示 */
    canvas:hover .tooltip {
      opacity: 1;
    }
    
    /* 選択中のデコレーションの枠線 */
    .decoration-selected {
      border-color: #ff1493 !important; /* 強調表示 */
      border-style: dashed !important;
    }
  </style>
</head>
<body>

<h1>Myうちわ</h1>

<div class="area" id="area-select">
    <h2 id="section1-title">1) 背景を選ぶ</h2>
    
    <!-- 追加: 背景色選択エリア -->
    <div style="margin-bottom: 10px;">
      <label for="backgroundColorPicker" style="display: block; margin-bottom: 5px;">推しのメンバーカラーを選んでね👇</label>
      <input type="color" id="backgroundColorPicker" value="#ff69b4" style="width: 100px; padding: 5px; height: 40px; border-radius: 8px; cursor: pointer;">
    </div>
    <button id="setBackgroundColorBtn" style="margin-bottom: 15px;">背景に設定する</button>

    <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">

    <label id="templateLabel" style="margin-top: 20px;">うちわのデザインを選んでね👇</label>
    <select id="templateSelector">
      <option value="https://i.ibb.co/L63vF1m/fan1-highres.png" data-lowres="https://i.ibb.co/3s3B46J/fan1-lowres.png">無地</option>
      <option value="https://i.ibb.co/q7776fH/fan2-highres.png" data-lowres="https://i.ibb.co/p33sFzG/fan2-lowres.png">夏祭り①</option>
      <option value="https://i.ibb.co/Jz5T155/fan3-highres.png" data-lowres="https://i.ibb.co/6P6XgC5/fan3-lowres.png">夏祭り②</option>
    </select>

    <label for="imageLoader" id="customFileLabel">写真を撮る／ライブラリから選ぶ</label>
    <input type="file" id="imageLoader" accept="image/*" style="display:none;" />
    <p id="reuploadNotice" style="font-size: 12px; color: #666;">※ 背景はいつでも変更できます。</p>
</div>

<div class="area">
  <canvas id="mainCanvas" width="800" height="800"></canvas>
  <img id="templateOverlay" src="" style="display:none;"/>
  <div class="button-group">
    <button id="confirmPhotoBtn">写真/背景を確定</button>
    <button id="reEditPhotoBtn" style="display:none;">写真/背景を編集し直す</button>
  </div>
</div>

<div class="area" id="area-decorations" style="display:none;">
    <h2>2) デコレーションする</h2>
    <div id="textInputArea" style="margin-bottom: 10px;">
        <input type="text" id="customText" placeholder="好きな文字を入力！" maxlength="15" style="width: 60%;"/>
        <button id="addTextBtn">文字を追加</button>
    </div>
    <div style="margin-bottom: 10px;">
        <label for="fontPicker">フォント:</label>
        <select id="fontPicker">
          <option value="Kaisei Tokumin, serif">明朝体</option>
          <option value="Cherry Bomb One, cursive">手書き風</option>
          <option value="DotGothic16, sans-serif">ドット絵</option>
          <option value="Train One, cursive">ポップ</option>
        </select>
        <label for="colorPicker">色:</label>
        <input type="color" id="colorPicker" value="#ff69b4">
    </div>

    <hr style="border: 0; border-top: 1px solid #f2f2f2; margin: 15px 0;">

    <h3>スタンプ</h3>
    <div id="decorationButtons">
      <img src="https://i.ibb.co/wJv06kF/heart.png" alt="heart" />
      <img src="https://i.ibb.co/S7qM4yP/star.png" alt="star" />
      <img src="https://i.ibb.co/y410t1p/ribbon.png" alt="ribbon" />
      <img src="https://i.ibb.co/YyY1q6b/crown.png" alt="crown" />
      <img src="https://i.ibb.co/R2t9g8y/cherry.png" alt="cherry" />
      <img src="https://i.ibb.co/tBf3w1t/flower.png" alt="flower" />
      <img src="https://i.ibb.co/y4v397C/mic.png" alt="mic" />
      <img src="https://i.ibb.co/LNxQf82/musicnote.png" alt="music note" />
      <img src="https://i.ibb.co/tH8yv5X/lightstick.png" alt="lightstick" />
      <img src="https://i.ibb.co/xL38t1t/bear.png" alt="bear" />
    </div>
    
    <div class="button-group">
      <button id="undoBtn">戻る</button>
      <button id="deleteBtn" style="display:none;">選択中のデコを削除</button>
    </div>
</div>

<div class="area" id="area-result" style="display:none;">
    <h2>3) 完成！</h2>
    <div id="previewWrapper">
      <img id="previewImage" src="" alt="うちわプレビュー" />
      <p id="previewNotice" style="font-size:14px; color:#555; text-align: left;"></p>
    </div>
    <button id="generateBtn">決定 → プレビュー</button>
    <button id="goToOrderFormBtn" style="display:none;">購入フォームへ進む</button>
</div>

<script>
    window.onload = function() {
      // キャンバスとコンテキストの取得
      const mainCanvas = document.getElementById('mainCanvas');
      const ctx = mainCanvas.getContext('2d');
      const templateOverlay = document.getElementById('templateOverlay');
      const imageLoader = document.getElementById('imageLoader');
      const templateSelector = document.getElementById('templateSelector');
      const confirmPhotoBtn = document.getElementById('confirmPhotoBtn');
      const reEditPhotoBtn = document.getElementById('reEditPhotoBtn');
      const generateBtn = document.getElementById('generateBtn');
      const goToOrderFormBtn = document.getElementById('goToOrderFormBtn');
      const customText = document.getElementById('customText');
      const colorPicker = document.getElementById('colorPicker');
      const fontPicker = document.getElementById('fontPicker');
      const previewWrapper = document.getElementById('previewWrapper');
      const previewImage = document.getElementById('previewImage');
      const previewNotice = document.getElementById('previewNotice');
      const areaDecorations = document.getElementById('area-decorations');
      const areaResult = document.getElementById('area-result');
      
      // 追加: 背景色関連のDOM要素と状態変数
      const backgroundColorPicker = document.getElementById('backgroundColorPicker');
      const setBackgroundColorBtn = document.getElementById('setBackgroundColorBtn');
      let backgroundColor = null; // 背景色を保存する変数

      // デコレーションのDOM要素
      const decorationButtons = document.getElementById('decorationButtons');
      const addTextBtn = document.getElementById('addTextBtn');
      const undoBtn = document.getElementById('undoBtn');
      const deleteBtn = document.getElementById('deleteBtn');

      // 状態変数
      let uploadedImg = null; // アップロードされた写真
      let photoObject = null; // 写真の座標、スケール、回転を管理
      let isPhotoLocked = false; // 写真の編集状態
      let decorationObjects = []; // デコレーションオブジェクトの配列
      let selectedObject = null; // 現在選択中のデコレーション
      let isDragging = false; // ドラッグ中かどうか
      let dragTarget = null; // ドラッグ中の対象 ('photo', 'decoration', 'rotate-photo', 'rotate-decoration')
      let lastPos = { x: 0, y: 0 }; // 最後にマウスがあった座標
      let history = []; // 履歴スタック
      let historyIndex = -1; // 現在の履歴インデックス

      // キャンバスのサイズをレスポンシブに調整
      const fanRatio = 1; // 扇の縦横比
      function resizeCanvas() {
        const parentWidth = mainCanvas.parentElement.clientWidth;
        const size = Math.min(parentWidth, 400); // 最大幅400px
        mainCanvas.style.width = size + 'px';
        mainCanvas.style.height = (size * fanRatio) + 'px';
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      /**
       * 描画のメインループ
       */
      function drawAll() {
        // 高解像度での描画を考慮
        ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height); // キャンバスをクリア

        // 追加: 背景色が設定されていれば、それを塗りつぶす
        if (backgroundColor) {
          ctx.fillStyle = backgroundColor;
          ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
        }
        
        drawImage(); // 写真を描画
        drawDecorations(); // デコレーションを描画
      }

      /**
       * 写真を描画します。
       */
      function drawImage() {
        if (!uploadedImg || !photoObject) return;

        // 写真を中央に配置し、回転とスケールを適用
        ctx.save();
        ctx.translate(photoObject.x, photoObject.y);
        ctx.rotate(photoObject.rotation);
        ctx.scale(photoObject.scale, photoObject.scale);
        ctx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
        ctx.restore();

        if (!isPhotoLocked) {
          // 編集モードの場合、写真の周りにコントロールを描画
          ctx.strokeStyle = '#ff69b4';
          ctx.lineWidth = 4;
          ctx.setLineDash([10, 10]);
          const rectWidth = uploadedImg.width * photoObject.scale;
          const rectHeight = uploadedImg.height * photoObject.scale;
          ctx.strokeRect(photoObject.x - rectWidth / 2, photoObject.y - rectHeight / 2, rectWidth, rectHeight);
          ctx.setLineDash([]);
        }
      }

      /**
       * デコレーションを描画します。
       */
      function drawDecorations() {
        decorationObjects.forEach(obj => {
          ctx.save();
          ctx.translate(obj.x, obj.y);
          ctx.rotate(obj.rotation);
          ctx.scale(obj.scale, obj.scale);

          if (obj.type === 'text') {
            ctx.font = `${obj.fontSize}px "${obj.fontFamily}"`;
            ctx.fillStyle = obj.color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(obj.text, 0, 0);
          } else if (obj.type === 'image') {
            // 画像のデコレーションを描画
            ctx.drawImage(obj.image, -obj.size / 2, -obj.size / 2, obj.size, obj.size);
          }

          ctx.restore();

          // 選択中のデコレーションに枠線を描画
          if (selectedObject && selectedObject.id === obj.id) {
            ctx.strokeStyle = '#ff1493';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            const size = obj.size * obj.scale;
            ctx.strokeRect(obj.x - size / 2, obj.y - size / 2, size, size);
            ctx.setLineDash([]);
          }
        });
      }

      /**
       * 履歴を保存します。
       */
      function saveState() {
        // 現在の履歴以降をクリア
        history = history.slice(0, historyIndex + 1);
        history.push(JSON.stringify({
          decorationObjects: decorationObjects,
          isPhotoLocked: isPhotoLocked
        }));
        historyIndex++;
        updateUndoRedoButtons();
      }

      /**
       * 履歴ボタンの状態を更新します。
       */
      function updateUndoRedoButtons() {
        undoBtn.disabled = historyIndex <= 0;
      }

      /**
       * 座標からデコレーションオブジェクトを特定します。
       */
      function getDecorationAtPosition(x, y) {
        for (let i = decorationObjects.length - 1; i >= 0; i--) {
          const obj = decorationObjects[i];
          const size = (obj.type === 'text' ? 150 : obj.size) * obj.scale;
          const dist = Math.sqrt(Math.pow(x - obj.x, 2) + Math.pow(y - obj.y, 2));
          if (dist < size / 2) {
            return obj;
          }
        }
        return null;
      }

      // --- イベントリスナー ---

      // うちわテンプレート選択
      templateSelector.addEventListener('change', () => {
        // 現在の高解像度テンプレートのパスを保存
        const templatePath = templateSelector.value;
        // 低解像度版に切り替え
        const lowResPath = templateSelector.options[templateSelector.selectedIndex].dataset.lowres;
        templateOverlay.src = lowResPath;
        drawAll(); // テンプレートの変更を反映
      });

      // 写真アップロード
      imageLoader.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
          uploadedImg = new Image();
          uploadedImg.onload = () => {
            // 写真をアップロードしたら背景色をリセット
            backgroundColor = null;
            photoObject = {
              x: mainCanvas.width / 2, 
              y: mainCanvas.height / 2, 
              scale: 1,
              rotation: 0
            };
            isPhotoLocked = false; 
            reEditPhotoBtn.style.display = 'none'; 
            confirmPhotoBtn.style.display = 'block'; 
            areaDecorations.style.display = 'none'; 
            areaResult.style.display = 'none';
            drawAll();
          };
          uploadedImg.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      // 追加: 背景色設定ボタンの処理
      setBackgroundColorBtn.addEventListener('click', () => {
        uploadedImg = null; // 写真をリセット
        photoObject = null; // 写真オブジェクトもリセット
        backgroundColor = backgroundColorPicker.value; // カラーピッカーの値で背景色を設定
        isPhotoLocked = true; // 背景色は編集不要なので、デコレーション編集へ移行
        confirmPhotoBtn.style.display = 'none'; 
        reEditPhotoBtn.style.display = 'block';
        areaDecorations.style.display = 'block'; 
        areaResult.style.display = 'none';
        document.getElementById('area-decorations').scrollIntoView({ behavior: 'smooth' }); 
        saveState();
        drawAll(); // 再描画
      });

      // 写真/背景を確定
      confirmPhotoBtn.addEventListener('click', () => {
        // 写真か背景色が設定されているか確認
        if (!uploadedImg && !backgroundColor) {
          alert('⚠️ まず写真または背景色を設定してください。');
          return;
        }
        isPhotoLocked = true;
        confirmPhotoBtn.style.display = 'none';
        reEditPhotoBtn.style.display = 'block';
        areaDecorations.style.display = 'block';
        document.getElementById('area-decorations').scrollIntoView({ behavior: 'smooth' });
        saveState();
      });

      // 写真/背景を編集し直す
      reEditPhotoBtn.addEventListener('click', () => {
        isPhotoLocked = false;
        reEditPhotoBtn.style.display = 'none';
        confirmPhotoBtn.style.display = 'block';
        areaDecorations.style.display = 'none';
        selectedObject = null;
        deleteBtn.style.display = 'none';
        areaResult.style.display = 'none';
        if (backgroundColor) {
          backgroundColor = null; // 背景色をリセット
        }
        drawAll();
      });

      // 文字追加
      addTextBtn.addEventListener('click', () => {
        const text = customText.value;
        if (text.trim() === '') return;

        const newText = {
          id: Date.now(),
          type: 'text',
          text: text,
          x: mainCanvas.width / 2,
          y: mainCanvas.height / 2,
          color: colorPicker.value,
          fontFamily: fontPicker.value,
          fontSize: 60,
          rotation: 0,
          scale: 1,
          size: 150 // ダミーサイズ
        };
        decorationObjects.push(newText);
        selectedObject = newText;
        deleteBtn.style.display = 'block';
        customText.value = '';
        saveState();
        drawAll();
      });

      // スタンプ追加
      decorationButtons.addEventListener('click', (e) => {
        if (e.target.tagName !== 'IMG') return;

        const newImage = new Image();
        newImage.onload = () => {
          const newStamp = {
            id: Date.now(),
            type: 'image',
            image: newImage,
            x: mainCanvas.width / 2,
            y: mainCanvas.height / 2,
            size: 100,
            rotation: 0,
            scale: 1
          };
          decorationObjects.push(newStamp);
          selectedObject = newStamp;
          deleteBtn.style.display = 'block';
          saveState();
          drawAll();
        };
        newImage.src = e.target.src;
      });

      // 決定 → プレビュー
      generateBtn.addEventListener('click', () => {
        // 写真も背景色も設定されていなければ警告
        if (!uploadedImg && !backgroundColor) {
          alert('⚠️ まず写真または背景色を設定してください。');
          return;
        }
        
        if (!isPhotoLocked) {
          alert('⚠️ 写真または背景色の設定を確定してください。');
          return;
        }

        // 高解像度での最終画像を生成するためのオフスクリーンキャンバス
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 800; // 元の解像度
        tempCanvas.height = 800;
        const tempCtx = tempCanvas.getContext('2d');

        // 1. 背景色または写真を描画
        if (backgroundColor) {
          tempCtx.fillStyle = backgroundColor;
          tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        } else if (uploadedImg) {
          tempCtx.save();
          tempCtx.translate(photoObject.x, photoObject.y);
          tempCtx.rotate(photoObject.rotation);
          tempCtx.scale(photoObject.scale, photoObject.scale);
          tempCtx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
          tempCtx.restore();
        }

        // 2. デコレーションを描画
        decorationObjects.forEach(obj => {
          tempCtx.save();
          tempCtx.translate(obj.x, obj.y);
          tempCtx.rotate(obj.rotation);
          tempCtx.scale(obj.scale, obj.scale);
          if (obj.type === 'text') {
            tempCtx.font = `${obj.fontSize}px "${obj.fontFamily}"`;
            tempCtx.fillStyle = obj.color;
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'middle';
            tempCtx.fillText(obj.text, 0, 0);
          } else if (obj.type === 'image') {
            tempCtx.drawImage(obj.image, -obj.size / 2, -obj.size / 2, obj.size, obj.size);
          }
          tempCtx.restore();
        });

        // 3. 高解像度うちわテンプレートを重ねる
        const templateHighRes = new Image();
        templateHighRes.onload = () => {
          tempCtx.drawImage(templateHighRes, 0, 0, tempCanvas.width, tempCanvas.height);
          previewImage.src = tempCanvas.toDataURL('image/png');
          areaResult.style.display = 'block';
          previewWrapper.style.display = 'block';
          goToOrderFormBtn.style.display = 'block';
          previewNotice.innerHTML = `🌟完成！<br>
          このうちわ画像を長押し（PCは右クリック）で保存できます。<br>
          <br>
          ※ このプレビュー画像はあくまでイメージです。印刷時の仕上がりは、ご利用のサービスにより異なります。`;
          areaResult.scrollIntoView({ behavior: 'smooth' });
        };
        templateHighRes.src = templateSelector.value;
      });

      // 戻るボタン
      undoBtn.addEventListener('click', () => {
        if (historyIndex > 0) {
          historyIndex--;
          const prevState = JSON.parse(history[historyIndex]);
          decorationObjects = prevState.decorationObjects;
          isPhotoLocked = prevState.isPhotoLocked;
          // 画像デコレーションは再度読み込む必要がある
          decorationObjects.forEach(obj => {
            if (obj.type === 'image') {
              const newImage = new Image();
              newImage.src = obj.image.src;
              obj.image = newImage;
            }
          });
          selectedObject = null;
          deleteBtn.style.display = 'none';
          drawAll();
          updateUndoRedoButtons();
        }
      });

      // デコレーション削除
      deleteBtn.addEventListener('click', () => {
        if (selectedObject) {
          decorationObjects = decorationObjects.filter(obj => obj.id !== selectedObject.id);
          selectedObject = null;
          deleteBtn.style.display = 'none';
          saveState();
          drawAll();
        }
      });

      // --- ドラッグ＆ドロップ関連 ---
      mainCanvas.addEventListener('mousedown', function(e) {
        if (isPhotoLocked) {
          // デコレーションの操作
          const rect = mainCanvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (mainCanvas.width / rect.width);
          const y = (e.clientY - rect.top) * (mainCanvas.height / rect.height);
          
          selectedObject = getDecorationAtPosition(x, y);
          if (selectedObject) {
            isDragging = true;
            dragTarget = 'decoration';
            lastPos = { x: e.clientX, y: e.clientY };
            deleteBtn.style.display = 'block';
          } else {
            // デコレーションが選択されていない場合は選択を解除
            selectedObject = null;
            deleteBtn.style.display = 'none';
          }
        } else if (photoObject && uploadedImg) {
          // 写真の操作
          const rect = mainCanvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (mainCanvas.width / rect.width);
          const y = (e.clientY - rect.top) * (mainCanvas.height / rect.height);
          
          const rectWidth = uploadedImg.width * photoObject.scale;
          const rectHeight = uploadedImg.height * photoObject.scale;
          
          // 写真の範囲内をクリックしたか判定
          if (x > photoObject.x - rectWidth / 2 && x < photoObject.x + rectWidth / 2 &&
              y > photoObject.y - rectHeight / 2 && y < photoObject.y + rectHeight / 2) {
            isDragging = true;
            dragTarget = 'photo';
            lastPos = { x: e.clientX, y: e.clientY };
          }
        }
        drawAll();
      });

      mainCanvas.addEventListener('mousemove', function(e) {
        if (!isDragging || !dragTarget) return;

        // 移動量をキャンバスの論理ピクセルに変換
        const dx_canvas = (e.clientX - lastPos.x) * (mainCanvas.width / mainCanvas.getBoundingClientRect().width);
        const dy_canvas = (e.clientY - lastPos.y) * (mainCanvas.height / mainCanvas.getBoundingClientRect().height);

        if (dragTarget === 'photo') {
          photoObject.x += dx_canvas;
          photoObject.y += dy_canvas;
        } else if (dragTarget === 'decoration' && selectedObject) {
          selectedObject.x += dx_canvas;
          selectedObject.y += dy_canvas;
        }

        lastPos = { x: e.clientX, y: e.clientY };
        drawAll();
      });

      mainCanvas.addEventListener('mouseup', function(e) {
        if (isDragging) {
          if (dragTarget === 'decoration' || dragTarget === 'photo') {
            saveState(); // 操作完了時に履歴を保存
          }
        }
        isDragging = false;
        dragTarget = null;
      });

      // スケール変更（ピンチイン/アウト）
      mainCanvas.addEventListener('wheel', function(e) {
        if (isPhotoLocked) {
          // デコレーションのスケール変更
          if (selectedObject) {
            e.preventDefault();
            const scaleFactor = 1 + e.deltaY * -0.001; // ホイールの量に応じて調整
            selectedObject.scale *= scaleFactor;
            saveState();
            drawAll();
          }
        } else if (photoObject) {
          // 写真のスケール変更
          e.preventDefault();
          const scaleFactor = 1 + e.deltaY * -0.001; // ホイールの量に応じて調整
          photoObject.scale *= scaleFactor;
          drawAll();
        }
      });
    }
</script>

</body>
</html>