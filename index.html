<!DOCTYPE html>
<html lang="ja">
<head>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Kosugi+Maru&family=DotGothic16&family=Train+One&family=Cherry+Bomb+One&family=Kaisei+Tokumin&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <title>Myã†ã¡ã‚ - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      background: linear-gradient(135deg, #f0f7ff, #eaf6ff);
      margin: 0;
      padding: 16px;
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 22px;
      margin-bottom: 20px;
      color: #1565c0;
    }
    .area {
      background: #fff;
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .area h2 {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 12px;
      color: #1565c0;
    }
    select, input[type="file"], button, label {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      background: #fff;
      box-sizing: border-box;
    }
    button {
      background: #4cafef;
      color: white;
      font-size: 16px;
      padding: 12px 24px;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, background 0.3s;
    }
    button:hover {
      background: #2196f3;
      transform: translateY(-2px);
    }
    canvas {
      width: 100%;
      height: auto;
      background: #f9f9f9;
      border-radius: 12px;
      border: 1px solid #ddd;
    }
    #mainCanvas { touch-action: none; }
    #templateLabel {
      border: none;
      outline: none;
    }
    #previewWrapper img {
      max-width: 100%;
      border: 6px solid #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-top: 12px;
    }
    #previewNotice {
      font-size: 13px;
      margin-top: 8px;
      color: #555;
    }
    #langButtons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    #langButtons button {
      flex: 1;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      background: #fdfdfd;
      color: #333;
      border-radius: 10px;
      box-shadow: none;
    }
    #langButtons button:hover {
      background: #f0f0f0;
    }
    #customFileLabel {
      background: linear-gradient(135deg, #4cafef, #2196f3);
      color: #fff;
      border-radius: 30px;
      padding: 14px 26px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
      display: inline-block;
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    #customFileLabel:hover {
      background: linear-gradient(135deg, #42a5f5, #1e88e5);
      transform: scale(1.07);
    }
    #decoControls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    #decoControls .control-group {
      display: flex;
      gap: 5px;
      align-items: center;
      margin-bottom: 5px;
    }
    #textInputGroup, #stampGroup, #editTools {
      width: 100%;
      text-align: center;
      margin-top: 10px;
    }
    #customText {
      width: 60%;
      padding: 8px;
      font-size: 16px;
      border-radius: 8px;
    }
    #addTextBtn, #addStampBtn, .stamp-img-btn, #undoBtn, #redoBtn, #duplicateBtn, #deleteBtn, #bringFrontBtn, #sendBackBtn, #confirmPhotoBtn, #reEditPhotoBtn {
      padding: 8px 12px;
      font-size: 14px;
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: none;
      transition: none;
      width: auto;
    }
    #addTextBtn, #confirmPhotoBtn {
      background: #00bcd4;
      color: white;
    }
    #reEditPhotoBtn {
        background: #ff9800; /* ã‚ªãƒ¬ãƒ³ã‚¸è‰² */
        color: white;
    }
    .stamp-img-btn img {
      width: 40px;
      height: auto;
    }
    #editTools {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }
    #editTools button {
      flex: 1;
      min-width: 80px;
      max-width: 120px;
    }
    #decorationControlsContainer[disabled] {
        opacity: 0.5;
        pointer-events: none;
    }
    @media print {
      body *:not(.fan-print) {
        display: none !important;
      }
      #mainCanvas {
        width: 100%;
        height: auto;
      }
      canvas {
        page-break-inside: avoid;
        break-inside: avoid;
        -webkit-region-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div id="langButtons">
    <button onclick="setLanguage('ja')">ğŸ‡¯ğŸ‡µJP</button>
    <button onclick="setLanguage('en')">ï¿½ğŸ‡¸EN</button>
    <button onclick="setLanguage('zh')">ğŸ‡¨ğŸ‡³ä¸­æ–‡</button>
    <button onclick="setLanguage('ko')">ğŸ‡°ğŸ‡·KO</button>
    <button onclick="setLanguage('vi')">ğŸ‡»ğŸ‡³VIt</button>
  </div>
  <button id="howToBtn" style="margin:10px; padding:10px 20px; border-radius:20px; background:#2196f3; color:white; border:none; cursor:pointer;" data-ja="â“ ä½¿ã„æ–¹" data-en="â“ How to Use" data-zh="â“ ä½¿ç”¨æ–¹æ³•" data-ko="â“ ì‚¬ìš© ë°©ë²•" data-vi="â“ CÃ¡ch sá»­ dá»¥ng">â“ ä½¿ã„æ–¹</button>
  <div id="howToModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; max-width:600px; width:90%; padding:20px; overflow-y:auto; max-height:90%;">
      <h2 id="howToTitle" style="text-align:center; color:#1565c0;" data-ja="ğŸ“– Myã†ã¡ã‚ LAB ä½¿ã„æ–¹" data-en="ğŸ“– How to Use My Uchiwa LAB" data-zh="ğŸ“– Myå›¢æ‰‡LAB ä½¿ç”¨æ–¹æ³•" data-ko="ğŸ“– Myìš°ì¹˜ì™€ LAB ì‚¬ìš© ë°©ë²•" data-vi="ğŸ“– CÃ¡ch sá»­ dá»¥ng My Uchiwa LAB">ğŸ“– Myã†ã¡ã‚ LAB ä½¿ã„æ–¹</h2>
      <div id="howToBody" style="text-align:left; line-height:1.6; font-size:14px; color:#333;" data-ja="<ol><li><b>ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã¶ï¼š</b> ç„¡åœ°ï¼å¤â‘ ï¼å¤â‘¡ã‹ã‚‰é¸æŠ</li><li><b>å†™çœŸã‚’é¸ã¶ï¼š</b> ã€Œå†™çœŸã‚’æ’®ã‚‹ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶ã€ã§æ’®å½±ã¾ãŸã¯ç”»åƒã‚’é¸æŠ</li><li><b>ç·¨é›†ã™ã‚‹ï¼š</b> 1æœ¬æŒ‡ã§ç§»å‹•ã€ãƒ”ãƒ³ãƒã§æ‹¡å¤§ç¸®å°ã€2æœ¬æŒ‡ã§å›è»¢</li><li><b>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šï¼š</b> ã€Œæ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã‚’æŠ¼ã—ã¦å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèª</li><li><b>ä¿å­˜ï¼š</b><ul><li>iPhone â†’ ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œå†™çœŸã«è¿½åŠ ã€</li><li>Android â†’ ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€</li></ul></li><li><b>æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ï¼š</b> ä¿å­˜ã—ãŸã‚‰ã€Œæ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ã€ã‹ã‚‰ç”³è¾¼</li><li><b>LINEã§ã‚·ã‚§ã‚¢ï¼š</b> ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‹é”ã«URLã‚’é€ä¿¡</li></ol>" data-en="<ol><li><b>Choose a design:</b> Select Plain / Summer â‘  / Summer â‘¡.</li><li><b>Choose a photo:</b> Tap &quot;Take Photo / Choose from Library&quot; to take or pick an image.</li><li><b>Edit:</b> Drag with one finger to move; pinch to zoom; rotate with two fingers.</li><li><b>Preview:</b> Tap &quot;Confirm â†’ Preview&quot; to check the final image.</li><li><b>Save:</b><ul><li>iPhone â†’ Press and hold the image, then select &quot;Add to Photos&quot;.</li><li>Android â†’ Press and hold the image, then select &quot;Save Image&quot;.</li></ul></li><li><b>Order form:</b> After saving, proceed via &quot;Go to Order Form&quot;.</li><li><b>Share on LINE:</b> Use the button at the bottom to send the page URL to friends.</li></ol>" data-zh="<ol><li><b>é€‰æ‹©è®¾è®¡ï¼š</b> ä»ã€Œç´ è‰²ï¼å¤å­£â‘ ï¼å¤å­£â‘¡ã€ä¸­é€‰æ‹©ã€‚</li><li><b>é€‰æ‹©ç…§ç‰‡ï¼š</b> ç‚¹å‡»ã€Œæ‹ç…§ / ä»å›¾åº“é€‰æ‹©ã€ï¼Œæ‹æ‘„æˆ–é€‰æ‹©å›¾ç‰‡ã€‚</li><li><b>ç¼–è¾‘ï¼šï¼š</b> å•æŒ‡æ‹–åŠ¨ç§»åŠ¨ï¼›æåˆç¼©æ”¾ï¼›åŒæŒ‡æ—‹è½¬ã€‚</li><li><b>é¢„è§ˆï¼š</b> ç‚¹å‡»ã€Œç¡®è®¤ â†’ é¢„è§ˆã€æŸ¥çœ‹å®Œæˆæ•ˆæœã€‚</li><li><b>ä¿å­˜ï¼š</b><ul><li>iPhone â†’ é•¿æŒ‰å›¾ç‰‡ï¼Œé€‰æ‹©ã€Œæ·»åŠ åˆ°ç…§ç‰‡ã€ã€‚</li><li>Android â†’ é•¿æŒ‰å›¾ç‰‡ï¼Œé€‰æ‹©ã€Œä¿å­˜å›¾ç‰‡ã€ã€‚</li></ul></li><li><b>è®¢å•è¡¨å•ï¼š</b> ä¿å­˜åï¼Œç‚¹å‡»ã€Œå‰å¾€è®¢å•è¡¨å•ã€æäº¤ã€‚</li><li><b>ç”¨ LINE åˆ†äº«ï¼š</b> ä½¿ç”¨é¡µé¢åº•éƒ¨çš„æŒ‰é’®ï¼Œå°†URLå‘é€ç»™æœ‹å‹ã€‚</li></ol>" data-ko="<ol><li><b>ë””ìì¸ ì„ íƒ:</b> ë¬´ì§€ / ì—¬ë¦„â‘  / ì—¬ë¦„â‘¡ ì¤‘ì—ì„œ ì„ íƒí•©ë‹ˆë‹¤.</li><li><b>ì‚¬ì§„ ì„ íƒ:</b> &quot;ì‚¬ì§„ ì°ê¸° / ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì„ íƒ&quot;ì„ ëˆŒëŸ¬ ì´¬ì˜í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li><li><b>í¸ì§‘:</b> í•œ ì†ê°€ë½ìœ¼ë¡œ ì´ë™, í•€ì¹˜ë¡œ í™•ëŒ€/ì¶•ì†Œ, ë‘ ì†ê°€ë½ìœ¼ë¡œ íšŒì „í•©ë‹ˆë‹¤.</li><li><b>ë¯¸ë¦¬ë³´ê¸°:</b> &quot;í™•ì¸ â†’ ë¯¸ë¦¬ë³´ê¸°&quot;ë¥¼ ëˆŒëŸ¬ ì™„ì„± ì´ë¯¸ì§€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</li><li><b>ì €ì¥:</b><ul><li>iPhone â†’ ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ &quot;ì‚¬ì§„ì— ì¶”ê°€&quot;ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li><li>Android â†’ ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ &quot;ì´ë¯¸ì§€ ì €ì¥&quot;ì„ ì„ íƒí•©ë‹ˆë‹¤.</li></ul></li><li><b>ì£¼ë¬¸ ì–‘ì‹:</b> ì €ì¥ í›„ &quot;ì£¼ë¬¸ ì–‘ì‹ìœ¼ë¡œ ì´ë™&quot; ë²„íŠ¼ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.</li><li><b>LINE ê³µìœ :</b> í˜ì´ì§€ í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ì¹œêµ¬ì—ê²Œ URLì„ ì „ì†¡í•©ë‹ˆë‹¤.</li></ol>" data-vi="<ol><li><b>Chá»n thiáº¿t káº¿:</b> Chá»n TrÆ¡n / MÃ¹a hÃ¨ â‘  / MÃ¹a hÃ¨ â‘¡.</li><li><b>Chá»n áº£nh:</b> Nháº¥n &quot;Chá»¥p áº£nh / Chá»n tá»« thÆ° viá»‡n&quot; Ä‘á»ƒ chá»¥p hoáº·c chá»n áº£nh.</li><li><b>Chá»‰nh sá»­a:</b> KÃ©o báº±ng má»™t ngÃ³n tay Ä‘á»ƒ di chuyá»ƒn; chá»¥m Ä‘á»ƒ phÃ³ng to/thu nhá»; xoay báº±ng hai ngÃ³n tay.</li><li><b>Xem trÆ°á»›c:</b> Nháº¥n &quot;XÃ¡c nháº­n â†’ Xem trÆ°á»›c&quot; Ä‘á»ƒ kiá»ƒm tra hÃ¬nh hoÃ n chá»‰nh.</li><li><b>LÆ°u:</b><ul><li>iPhone â†’ Nháº¥n vÃ  giá»¯ áº£nh, chá»n &quot;ThÃªm vÃ o áº¢nh&quot;.</li><li>Android â†’ Nháº¥n vÃ  giá»¯ áº£nh, chá»n &quot;LÆ°u hÃ¬nh áº£nh&quot;.</li></ul></li><li><b>Máº«u Ä‘Æ¡n Ä‘áº·t hÃ ng:</b> Sau khi lÆ°u, báº¥m &quot;Äi tá»›i Form Ä‘áº·t hÃ ng&quot; Ä‘á»ƒ tiáº¿p tá»¥c.</li><li><b>Chia sáº» qua LINE:</b> DÃ¹ng nÃºt á»Ÿ cuá»‘i trang Ä‘á»ƒ gá»­i URL cho báº¡n bÃ¨.</li></ol>"></div>
      <div style="text-align:center; margin-top:20px;">
        <button onclick="document.getElementById('howToModal').style.display='none';" style="padding:10px 20px; border:none; border-radius:20px; background:#f44336; color:white; cursor:pointer;" data-ja="é–‰ã˜ã‚‹" data-en="Close" data-zh="å…³é—­" data-ko="ë‹«ê¸°" data-vi="ÄÃ³ng">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  <h1 id="title" data-ja="Myã†ã¡ã‚ LAB" data-en="Let's Make Our Own Fan!" data-zh="ä¸€èµ·æ¥åˆ¶ä½œæˆ‘ä»¬çš„å›¢æ‰‡ï¼" data-ko="ìš°ë¦¬ë§Œì˜ ë¶€ì±„ë¥¼ ë§Œë“¤ì–´ë³´ì!" data-vi="HÃ£y cÃ¹ng lÃ m quáº¡t giáº¥y cá»§a riÃªng mÃ¬nh!">Myã†ã¡ã‚ LAB</h1>
  <div class="area" id="area-select">
    <h2 data-ja="1)ãƒ‡ã‚¶ã‚¤ãƒ³ï¼†å†™çœŸã‚’é¸ã¶" data-en="1) Selection" data-zh="â‘  é€‰æ‹©è®¾è®¡å’Œç…§ç‰‡" data-ko="â‘  ë””ìì¸ê³¼ ì‚¬ì§„ ì„ íƒ" data-vi="â‘  Chá»n thiáº¿t káº¿ & áº£nh">1)ãƒ‡ã‚¶ã‚¤ãƒ³ï¼†å†™çœŸã‚’é¸ã¶</h2>
    <label id="templateLabel" data-ja="ã†ã¡ã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã‚“ã§ã­ğŸ‘‡" data-en="Choose a fan designğŸ‘‡" data-zh="è¯·é€‰æ‹©ä¸€ä¸ªå›¢æ‰‡è¨­è¨ˆğŸ‘‡" data-ko="ë¶€ì±„ ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ ì„ íƒí•˜ì„¸ìš”ğŸ‘‡" data-vi="Chá»n thiáº¿t káº¿ quáº¡tğŸ‘‡">ã†ã¡ã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã‚“ã§ã­ğŸ‘‡</label>
    <select id="templateSelector">
      <option value="fan1-highres.png" data-ja="ç„¡åœ°" data-en="Plain" data-zh="ç´ è‰²" data-ko="ë¬´ì§€" data-vi="TrÆ¡n">ç„¡åœ°</option>
      <option value="fan2-highres.png" data-ja="å¤â‘ " data-en="Summer â‘ " data-zh="å¤å­£â‘ " data-ko="ì—¬ë¦„â‘ " data-vi="MÃ¹a hÃ¨ â‘ ">å¤â‘ </option>
      <option value="fan3-highres.png" data-ja="å¤â‘¡" data-en="Summer â‘¡" data-zh="å¤å­£â‘¡" data-ko="ì—¬ë¦„â‘¡" data-vi="MÃ¹a hÃ¨ â‘¡">å¤â‘¡</option>
    </select>
    <br />
    <label for="imageLoader" id="customFileLabel" data-ja="å†™çœŸã‚’æ’®ã‚‹ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶" data-en="Take Photo / Choose from Library" data-zh="æ‹ç…§ / ä»å›¾åº“é€‰æ‹©" data-ko="ì‚¬ì§„ ì°ê¸° / ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì„ íƒ" data-vi="Chá»¥p áº£nh / Chá»n tá»« thÆ° viá»‡n">å†™çœŸã‚’æ’®ã‚‹ï¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸ã¶</label>
    <input type="file" id="imageLoader" accept="image/*" style="display:none;" />
    <br />
    <p id="reuploadNotice" data-ja="â€» ç”»åƒã¯ä½•åº¦ã§ã‚‚é¸ã³ç›´ã›ã¾ã™ã€‚" data-en="â€» You can re-select the image as many times as you like." data-zh="â€» æ‚¨å¯ä»¥å¤šæ¬¡é‡æ–°é€‰æ‹©å›¾ç‰‡ã€‚" data-ko="â€» ì´ë¯¸ì§€ëŠ” ì–¸ì œë“ ì§€ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ã€‚" data-vi="â€» Báº¡n cÃ³ thá»ƒ chá»n láº¡i áº£nh bao nhiÃªu láº§n cÅ©ng Ä‘Æ°á»£cã€‚" style="font-size: 12px; color: #666;"></p>
  </div>

  <div class="area" id="area-canvas">
    <h2 data-ja="2) ãƒ‡ã‚¶ã‚¤ãƒ³ç·¨é›†ã‚¹ãƒšãƒ¼ã‚¹" data-en="2) Canvas" data-zh="â‘¡ è®¾è®¡ç¼–è¾‘åŒº" data-ko="â‘¡ ë””ìì¸ í¸ì§‘ ê³µê°„" data-vi="â‘¡ Khu vá»±c chá»‰nh sá»­a thiáº¿t káº¿">2)ãƒ‡ã‚¶ã‚¤ãƒ³ç·¨é›†ã‚¹ãƒšãƒ¼ã‚¹</h2>
    <div id="canvasWrapper">
      <canvas id="mainCanvas" width="3508" height="2480"></canvas>
    </div>
    <p id="editNotice" data-ja="â€» å†™çœŸã¯1æœ¬ã®æŒ‡ã§ä½ç½®ã‚’å‹•ã‹ã›ã¾ã™ã€‚2æœ¬ã®æŒ‡ã§å¤§ãã•ã‚„å‘ãã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚" data-en="â€» Move the photo with one finger. Pinch to zoom, use two fingers to rotate." data-zh="â€» ç”¨ä¸€æ ¹æ‰‹æŒ‡ç§»åŠ¨ç…§ç‰‡ã€‚æåˆç¼©æ”¾ï¼Œç”¨ä¸¤æ ¹æ‰‹æŒ‡æ—‹è½¬ã€‚" data-ko="â€» ì†ê°€ë½ í•œ ê°œë¡œ ì‚¬ì§„ì„ ì´ë™í•©ë‹ˆë‹¤. ë‘ ì†ê°€ë½ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ ë° íšŒì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ã€‚" data-vi="â€» DÃ¹ng má»™t ngÃ³n tay Ä‘á»ƒ di chuyá»ƒn áº£nh. Chá»¥m Ä‘á»ƒ phÃ³ng to/thu nhá», hai ngÃ³n tay Ä‘á»ƒ xoayã€‚" style="font-size: 12px; color: #666; margin-bottom: 10px;"></p>
    <p id="decoEditNotice" style="font-size: 12px; color: #666;">â€» æ–‡å­—ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ãƒ»ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã¯ã‚·ãƒ³ã‚°ãƒ«ã‚¿ãƒƒãƒ—ã§é¸æŠã€ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€é¸æŠæ ã®ãƒãƒ³ãƒ‰ãƒ«ã§ã‚µã‚¤ã‚ºå¤‰æ›´ãƒ»å›è»¢ãŒã§ãã¾ã™ã€‚</p>
    <button id="confirmPhotoBtn" data-ja="å†™çœŸç¢ºå®š" data-en="Confirm Photo" data-zh="ç¡®è®¤ç…§ç‰‡" data-ko="ì‚¬ì§„ í™•ì •" data-vi="XÃ¡c nháº­n áº£nh" style="display:none;">å†™çœŸç¢ºå®š</button>
    <p id="notice" style="font-size:14px; color:red;"></p>
  </div>

  <div class="area" id="area-deco">
    <h2 data-ja="3) ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†" data-en="3) Decorations" data-zh="â‘¢ è£…é¥°ç¼–è¾‘" data-ko="â‘¢ ê¾¸ë¯¸ê¸° í¸ì§‘" data-vi="â‘¢ Chá»‰nh sá»­a trang trÃ­">3)ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†</h2>
    <button id="reEditPhotoBtn" data-ja="å†™çœŸå†ç·¨é›†" data-en="Re-edit Photo" data-zh="é‡æ–°ç¼–è¾‘ç…§ç‰‡" data-ko="ì‚¬ì§„ ì¬í¸ì§‘" data-vi="Chá»‰nh sá»­a láº¡i áº£nh" style="display:none; margin-bottom: 10px;"></button>
    <div id="decorationControlsContainer" disabled>
        <div id="decoControls">
          <div id="textInputGroup">
            <input type="text" id="customText" placeholder="æ¨ã—ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â™¡" />
            <select id="fontPicker">
              <option value="'M PLUS Rounded 1c', sans-serif" style="font-family: 'M PLUS Rounded 1c', sans-serif">é€šå¸¸</option>
              <option value="'DotGothic16', sans-serif" style="font-family: 'DotGothic16', sans-serif">ãƒ‰ãƒƒãƒˆã‚´ã‚·ãƒƒã‚¯</option>
              <option value="'Train One', cursive" style="font-family: 'Train One', cursive">Train One</option>
              <option value="'Cherry Bomb One', cursive" style="font-family: 'Cherry Bomb One', cursive">æ‰‹æ›¸ãé¢¨</option>
              <option value="'Kaisei Tokumin', serif" style="font-family: 'Kaisei Tokumin', serif">ä¸¸æ–‡å­—</option>
            </select>
            <input type="color" id="colorPicker" value="#ff69b4" title="æ–‡å­—è‰²é¸æŠ" />
            <button id="addTextBtn" data-ja="æ–‡å­—è¿½åŠ " data-en="Add Text" data-zh="æ·»åŠ æ–‡å­—" data-ko="ê¸€ì ì¶”ê°€" data-vi="ThÃªm chá»¯">æ–‡å­—è¿½åŠ </button>
          </div>
          <div id="stampGroup">
            <label>ã‚¹ã‚¿ãƒ³ãƒ—ï¼š</label>
            <button onclick="addStamp('â¤ï¸')">â¤ï¸</button>
            <button onclick="addStamp('â­')">â­</button>
            <button onclick="addStamp('ğŸ¶')">ğŸ¶</button>
            <label>ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ï¼š</label>
            <button class="stamp-img-btn" onclick="addStamp('01loveu.png', true)"><img src="01loveu.png" alt="å¤§å¥½ãã ã‚ˆã‚¹ãƒ†ãƒƒã‚«ãƒ¼" /></button>
            <button class="stamp-img-btn" onclick="addStamp('02ntwithFace.png', true)"><img src="02ntwithFace.png" alt="é¡”ãŒå¤©æ‰ã‚¹ãƒ†ãƒƒã‚«ãƒ¼" /></button>
            <button class="stamp-img-btn" onclick="addStamp('03eyestome.png', true)"><img src="03eyestome.png" alt="3ç§’è¦‹ã¤ã‚ã¦ã‚¹ãƒ†ãƒƒã‚«ãƒ¼" /></button>
            <button class="stamp-img-btn" onclick="addStamp('04getmyheart.png', true)"><img src="04getmyheart.png" alt="æ’ƒã¡æŠœã„ã¦ã‚¹ãƒ†ãƒƒã‚«ãƒ¼" /></button>
          </div>
        </div>
        <div id="editTools">
            <button id="undoBtn" data-ja="å…ƒã«æˆ»ã™" data-en="Undo" data-zh="æ’¤æ¶ˆ" data-ko="ì‹¤í–‰ ì·¨ì†Œ" data-vi="HoÃ n tÃ¡c">å…ƒã«æˆ»ã™</button>
            <button id="redoBtn" data-ja="ã‚„ã‚Šç›´ã™" data-en="Redo" data-zh="é‡åš" data-ko="ë‹¤ì‹œ ì‹¤í–‰" data-vi="LÃ m láº¡i">ã‚„ã‚Šç›´ã™</button>
            <button id="duplicateBtn" data-ja="è¤‡è£½" data-en="Duplicate" data-zh="å¤åˆ¶" data-ko="ë³µì œ" data-vi="Sao chÃ©p">è¤‡è£½</button>
            <button id="deleteBtn" data-ja="å‰Šé™¤" data-en="Delete" data-zh="åˆ é™¤" data-ko="ì‚­ì œ" data-vi="XÃ³a">å‰Šé™¤</button>
            <button id="bringFrontBtn" data-ja="å‰é¢ã¸" data-en="Bring Front" data-zh="ç½®äºé¡¶å±‚" data-ko="ì•ìœ¼ë¡œ" data-vi="LÃªn trÆ°á»›c">å‰é¢ã¸</button>
            <button id="sendBackBtn" data-ja="èƒŒé¢ã¸" data-en="Send Back" data-zh="ç½®äºåº•å±‚" data-ko="ë’¤ë¡œ" data-vi="Ra sau">èƒŒé¢ã¸</button>
        </div>
        <button id="saveBtn" data-ja="æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" data-en="Confirm â†’ Preview" data-zh="ç¡®è®¤ â†’ é¢„è§ˆ" data-ko="í™•ì¸ â†’ ë¯¸ë¦¬ë³´ê¸°" data-vi="XÃ¡c nháº­n â†’ Xem trÆ°á»›c">æ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    </div>
  </div>

  <div class="area" id="area-result">
    <h2 data-ja="4) å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸" data-en="4) Final Image" data-zh="â‘£ æœ€ç»ˆæ•ˆæœå›¾" data-ko="â‘£ ìµœì¢… ì´ë¯¸ì§€" data-vi="â‘£ HÃ¬nh hoÃ n chá»‰nh">4)å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸</h2>
    <div id="previewWrapper" style="display:none; text-align:center; margin-top:16px;">
      <img id="previewImage" alt="åˆæˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width:90%; border:1px solid #ccc; border-radius:10px;" />
    </div>
    <div id="previewNotice" style="font-size:14px; color:black; margin-top:10px;"></div>
    <br>
    <button id="go-to-form" data-ja="ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€" data-en="ğŸ“ Go to Order Form" data-zh="ğŸ“ å‰å¾€è®¢å•è¡¨å•" data-ko="ğŸ“ ì£¼ë¬¸ ì–‘ì‹ìœ¼ë¡œ ì´ë™" data-vi="ğŸ“ Äi tá»›i Form Ä‘áº·t hÃ ng">ğŸ“ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€</button>
    <div id="manual-link" style="display: none; margin-top: 10px;" data-ja='ãƒ•ã‚©ãƒ¼ãƒ ã«é€²ã‚ãªã„å ´åˆã¯ <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">ã“ã¡ã‚‰</a> ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚' data-en='If you cannot access the form, please click <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">here</a>.' data-zh='å¦‚æœæ— æ³•è¿›å…¥è¡¨å•ï¼Œè¯·ç‚¹å‡» <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">è¿™é‡Œ</a>ã€‚' data-ko='í¼ì— ì ‘ì†í•  ìˆ˜ ì—†ëŠ” ê²½ìš° <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">ì—¬ê¸°</a>ë¥¼ í´ë¦­í•˜ì„¸ìš”ã€‚' data-vi='Náº¿u khÃ´ng má»Ÿ Ä‘Æ°á»£c form, vui lÃ²ng nháº¥n <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">táº¡i Ä‘Ã¢y</a>ã€‚'>>ãƒ•ã‚©ãƒ¼ãƒ ã«é€²ã‚ãªã„å ´åˆã¯ <a href="https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform" target="_blank">ã“ã¡ã‚‰</a> ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>
    <div class="line-it-button" data-lang="ja" data-type="share-a" data-url="https://chc-chupea.github.io/my-uchiwa-studio/" style="display: inline-block; margin-top: 20px;"></div>
  </div>
  <footer id="footer-text" style="font-size: 6px; color: #888; margin-top: 20px;" data-ja="Â© 2025 Chugoku Shimbun Hanbai Center. Web application developed by Hitomi Sasaki. All rights reserved.<br>ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ ªå¼ä¼šç¤¾ä¸­å›½æ–°èè²©å£²ã‚»ãƒ³ã‚¿ãƒ¼ã®å¾“æ¥­å“¡ã«ã‚ˆã‚‹åœ°åŸŸã‚¤ãƒ™ãƒ³ãƒˆå‘ã‘ã®è‡ªä¸»é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚<br>â€»æœ¬ã‚¢ãƒ—ãƒªã¯å…¬å¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¥­å‹™ã¨ã®è¦ªå’Œæ€§ã‚’è€ƒæ…®ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚" data-en="Â© 2025 Chugoku Shimbun Hanbai Center. Web application developed by Hitomi Sasaki. All rights reserved.<br>This web application is an in-house project developed by an employee for local events.<br>*This is not an official service but is used considering compatibility with business activities." data-zh="Â© 2025 ä¸­å›½æ–°é—»é”€å”®ä¸­å¿ƒã€‚ç”±ä½ä½æœ¨ç³å¼€å‘çš„ç½‘ç»œåº”ç”¨ç¨‹åºã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚<br>è¯¥åº”ç”¨ç¨‹åºæ˜¯ä¸­å›½æ–°é—»é”€å”®ä¸­å¿ƒå‘˜å·¥ä¸ºç¤¾åŒºæ´»åŠ¨è‡ªä¸»å¼€å‘çš„é¡¹ç›®ã€‚<br>*æ­¤åº”ç”¨å¹¶éå®˜æ–¹æœåŠ¡ï¼Œä½†è€ƒè™‘åˆ°ä¸šåŠ¡éœ€è¦è€Œä½¿ç”¨ã€‚" data-ko="Â© 2025 ì£¼ê³ ì¿  ì‹ ë¬¸ íŒë§¤ ì„¼í„°. ì‚¬ì‚¬í‚¤ íˆí† ë¯¸ê°€ ê°œë°œí•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜. ëª¨ë“  ê¶Œë¦¬ ë³´ìœ .<br>ì´ ì›¹ì•±ì€ ì§€ì—­ ì´ë²¤íŠ¸ë¥¼ ìœ„í•´ ì§ì›ì´ ìì²´ ê°œë°œí•œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤ã€‚<br>*ë³¸ ì•±ì€ ê³µì‹ ì„œë¹„ìŠ¤ê°€ ì•„ë‹ˆì§€ë§Œ ì—…ë¬´ì™€ì˜ ì¹œí™”ì„±ì„ ê³ ë ¤í•˜ì—¬ ì‚¬ìš©ë©ë‹ˆë‹¤ã€‚" data-vi="Â© 2025 Trung tÃ¢m PhÃ¢n phá»‘i BÃ¡o Chugoku. á»¨ng dá»¥ng web do Hitomi Sasaki phÃ¡t triá»ƒn. Giá»¯ toÃ n quyá»n.<br>á»¨ng dá»¥ng nÃ y lÃ  dá»± Ã¡n tá»± phÃ¡t triá»ƒn cá»§a nhÃ¢n viÃªn cho sá»± kiá»‡n Ä‘á»‹a phÆ°Æ¡ngã€‚<br>*ÄÃ¢y khÃ´ng pháº£i dá»‹ch vá»¥ chÃ­nh thá»©c nhÆ°ng Ä‘Æ°á»£c dÃ¹ng do phÃ¹ há»£p vá»›i cÃ´ng viá»‡cã€‚" >Â© 2025 Chugoku Shimbun Hanbai Center. Web application developed by Hitomi Sasaki. All rights reserved.<br>ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ ªå¼ä¼šç¤¾ä¸­å›½æ–°èè²©å£²ã‚»ãƒ³ã‚¿ãƒ¼ã®å¾“æ¥­å“¡ã«ã‚ˆã‚‹åœ°åŸŸã‚¤ãƒ™ãƒ³ãƒˆå‘ã‘ã®è‡ªä¸»é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚<br>â€»æœ¬ã‚¢ãƒ—ãƒªã¯å…¬å¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¥­å‹™ã¨ã®è¦ªå’Œæ€§ã‚’è€ƒæ…®ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚</footer>
  <script>
    const saveWarningTexts = {
      ja: 'âš ï¸ ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã†ã¡ã‚ã«ä½¿ã†ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚',
      en: 'âš ï¸ No file selected yet. Please upload an image.',
      zh: 'âš ï¸ å°šæœªé€‰æ‹©æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ å›¾ç‰‡ã€‚',
      ko: 'âš ï¸ ì•„ì§ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ã€‚ì´ë¯¸ì§€ë¥¼ ì—…ãƒ­ãƒ¼ãƒ‰í•˜ì„¸ìš”ã€‚',
      vi: 'âš ï¸ ChÆ°a chá»n tá»‡p. VCari tá»‡pã€‚',
    };
    
    let currentLang = 'ja';
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    
    // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ“ä½œã®å±¥æ­´
    let decoHistory = []; 
    let decoHistoryIndex = -1;

    let uploadedImg = null; // ç¾åœ¨è¡¨ç¤ºãƒ»ç·¨é›†ä¸­ã®å†™çœŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    let finalizedPhotoState = null; // ã€Œå†™çœŸç¢ºå®šã€æ™‚ã®å†™çœŸã®çŠ¶æ…‹ã‚’ä¿å­˜

    let templateImg = new Image();
    let editableObjects = []; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã€ç”»åƒã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
    let selectedObject = null; // ç¾åœ¨é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

    let dragMode = null; // 'move', 'resize', 'rotate', 'move_photo'
    let startPoint = { x: 0, y: 0 }; // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®ãƒã‚¤ãƒ³ã‚¿ä½ç½®
    let startObjectState = null; // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹

    const selectionHandleSize = 40; // é¸æŠãƒãƒ³ãƒ‰ãƒ«ã®ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
    const rotationHandleSize = 60; // å›è»¢ãƒãƒ³ãƒ‰ãƒ«ã®ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
    const textBorderOffset = 20; // ãƒ†ã‚­ã‚¹ãƒˆã®é¸æŠæ ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼‰

    // æ–°ã—ã„çŠ¶æ…‹å¤‰æ•°ï¼šå†™çœŸãŒç¢ºå®šã•ã‚ŒãŸã‹ã©ã†ã‹
    let photoConfirmed = false; 
    const decorationControlsContainer = document.getElementById('decorationControlsContainer');
    const confirmPhotoBtn = document.getElementById('confirmPhotoBtn');
    const reEditPhotoBtn = document.getElementById('reEditPhotoBtn'); // æ–°ã—ãè¿½åŠ ã—ãŸãƒœã‚¿ãƒ³

    // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function setDecorationControlsEnabled(enabled) {
        // ã‚³ãƒ³ãƒ†ãƒŠã®disabledå±æ€§ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        decorationControlsContainer.toggleAttribute('disabled', !enabled);
        // ã‚³ãƒ³ãƒ†ãƒŠå†…ã®å…¨ã¦ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ ã‚’æœ‰åŠ¹/ç„¡åŠ¹ã«ã™ã‚‹
        decorationControlsContainer.querySelectorAll('button, input, select').forEach(el => {
            el.disabled = !enabled;
        });
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠå‡¦ç†
    const templateSelector = document.getElementById('templateSelector');
    templateImg.src = templateSelector.value;
    templateSelector.addEventListener('change', () => {
      templateImg.src = templateSelector.value;
      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ›´æ™‚ã‚‚å±¥æ­´ã«ä¿å­˜ï¼ˆå†™çœŸæœªç¢ºå®šæ™‚ï¼‰
      if (!photoConfirmed) { 
          // å†™çœŸç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ›´ã¯å†™çœŸã®çŠ¶æ…‹ã®ä¸€éƒ¨ã¨ã¿ãªã•ã‚Œã‚‹
          // ã“ã“ã§ã¯ç‰¹ã«å±¥æ­´ã«ã¯è¿½åŠ ã—ãªã„ãŒã€æç”»ã¯æ›´æ–°
          draw();
      } else {
          // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¤‰æ›´ã—ãŸå ´åˆã€ã“ã‚Œã¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å±¥æ­´ã«ã¯å«ã‚ãªã„
          draw();
      }
    });
    templateImg.onload = () => draw();

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    document.getElementById('imageLoader').addEventListener('change', function(e) {
      const reader = new FileReader();
      reader.onload = function(event) {
        uploadedImg = new Image();
        uploadedImg.onload = () => {
          // ç”»åƒã®åˆæœŸé…ç½®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ”¹å–„
          const imgAspect = uploadedImg.width / uploadedImg.height;
          const canvasAspect = canvas.width / canvas.height;
          let scale;
          const paddingRatio = 0.9; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®90%ã«åã¾ã‚‹ã‚ˆã†ã«

          if (imgAspect > canvasAspect) {
            // ç”»åƒãŒã‚­ãƒ£ãƒ³ãƒã‚¹ã‚ˆã‚Šæ¨ªé•·ã®å ´åˆã€å¹…ã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒ«
            scale = (canvas.width * paddingRatio) / uploadedImg.width;
          } else {
            // ç”»åƒãŒã‚­ãƒ£ãƒ³ãƒã‚¹ã‚ˆã‚Šç¸¦é•·ã¾ãŸã¯åŒã˜å ´åˆã€é«˜ã•ã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒ«
            scale = (canvas.height * paddingRatio) / uploadedImg.height;
          }

          uploadedImg.x = canvas.width / 2;
          uploadedImg.y = canvas.height / 2;
          uploadedImg.scale = scale; 
          uploadedImg.rotation = 0;

          photoConfirmed = false; // å†™çœŸã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå ´åˆã¯æœªç¢ºå®šçŠ¶æ…‹ã«æˆ»ã™
          confirmPhotoBtn.style.display = 'block'; // å†™çœŸç¢ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          reEditPhotoBtn.style.display = 'none'; // å†™çœŸå†ç·¨é›†ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤º
          setDecorationControlsEnabled(false); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
          editableObjects = []; // æ–°ã—ã„å†™çœŸãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚¯ãƒªã‚¢
          decoHistory = []; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢
          decoHistoryIndex = -1;
          draw();
          document.getElementById('area-canvas').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
        uploadedImg.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    // å†™çœŸç¢ºå®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    confirmPhotoBtn.addEventListener('click', () => {
        if (!uploadedImg) {
            // å†™çœŸãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            return;
        }
        // å†™çœŸã®çŠ¶æ…‹ã‚’ç¢ºå®šã—ã€ãã®çŠ¶æ…‹ã‚’ä¿å­˜
        finalizedPhotoState = { x: uploadedImg.x, y: uploadedImg.y, scale: uploadedImg.scale, rotation: uploadedImg.rotation };
        photoConfirmed = true; // å†™çœŸã‚’ç¢ºå®šçŠ¶æ…‹ã«ã™ã‚‹
        confirmPhotoBtn.style.display = 'none'; // å†™çœŸç¢ºå®šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        reEditPhotoBtn.style.display = 'block'; // å†™çœŸå†ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        setDecorationControlsEnabled(true); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–
        
        decoHistory = []; // æ–°ã—ã„ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚§ãƒ¼ã‚ºã®ãŸã‚ã«å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
        decoHistoryIndex = -1;
        saveDecoState(); // åˆæœŸï¼ˆç©ºã¾ãŸã¯æ—¢å­˜ã®ï¼‰ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
        
        selectedObject = null; // é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£é™¤
        draw();
        // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†ã‚¨ãƒªã‚¢ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        document.getElementById('area-deco').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // å†™çœŸå†ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    reEditPhotoBtn.addEventListener('click', () => {
        photoConfirmed = false; // å†™çœŸã‚’æœªç¢ºå®šçŠ¶æ…‹ã«æˆ»ã™
        confirmPhotoBtn.style.display = 'block'; // å†™çœŸç¢ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        reEditPhotoBtn.style.display = 'none'; // å†™çœŸå†ç·¨é›†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        setDecorationControlsEnabled(false); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
        
        // å†™çœŸã®çŠ¶æ…‹ã‚’ç¢ºå®šæ™‚ã®ã‚‚ã®ã«æˆ»ã™
        if (finalizedPhotoState) {
            uploadedImg.x = finalizedPhotoState.x;
            uploadedImg.y = finalizedPhotoState.y;
            uploadedImg.scale = finalizedPhotoState.scale;
            uploadedImg.rotation = finalizedPhotoState.rotation;
        }
        selectedObject = null; // é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£é™¤
        draw();
        document.getElementById('area-canvas').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // å†™çœŸç·¨é›†æ™‚ã®çŠ¶æ…‹ä¿å­˜ï¼ˆUndo/Redoå¯¾è±¡å¤–ï¼‰
    function savePhotoEditState() {
      // ç¾æ™‚ç‚¹ã§ã¯ã€å†™çœŸç·¨é›†ã®Undo/Redoã¯å®Ÿè£…ã—ãªã„ãŸã‚ã€å±¥æ­´ã«ã¯ä¿å­˜ã—ãªã„ãŒã€
      // `uploadedImg`ã®ç¾åœ¨ã®çŠ¶æ…‹ã¯`uploadedImg`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã«ä¿æŒã•ã‚Œã‚‹ã€‚
    }

    // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ“ä½œã®çŠ¶æ…‹ä¿å­˜
    function saveDecoState() {
      // å†™çœŸç¢ºå®šå¾Œã®ã¿ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’ä¿å­˜
      if (!photoConfirmed) return;

      decoHistory = decoHistory.slice(0, decoHistoryIndex + 1);
      const state = JSON.parse(JSON.stringify(editableObjects)); // editableObjectsã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
      decoHistory.push(state);
      decoHistoryIndex++;
      updateButtonStates();
    }

    // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ“ä½œã®Undo
    function undo() {
      if (photoConfirmed && decoHistoryIndex > 0) { // å†™çœŸç¢ºå®šå¾Œã‹ã¤å±¥æ­´ãŒã‚ã‚‹å ´åˆã®ã¿
        decoHistoryIndex--;
        restoreDecoState();
      }
    }

    // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ“ä½œã®Redo
    function redo() {
      if (photoConfirmed && decoHistoryIndex < decoHistory.length - 1) { // å†™çœŸç¢ºå®šå¾Œã‹ã¤ã‚„ã‚Šç›´ã—å±¥æ­´ãŒã‚ã‚‹å ´åˆã®ã¿
        decoHistoryIndex++;
        restoreDecoState();
      }
    }

    // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ“ä½œã®å±¥æ­´å¾©å…ƒ
    function restoreDecoState() {
      const state = decoHistory[decoHistoryIndex];
      editableObjects = JSON.parse(JSON.stringify(state)); // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã§å¾©å…ƒ

      // ç”»åƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯JSON.parseã§ã¯å¾©å…ƒã•ã‚Œãªã„ãŸã‚ã€å†æ§‹ç¯‰ãŒå¿…è¦
      editableObjects.forEach(obj => { 
        if (obj.type === 'image') { 
          const img = new Image(); 
          img.src = obj.src; 
          obj.img = img; 
          img.onload = draw; // ç”»åƒãƒ­ãƒ¼ãƒ‰å¾Œã«æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼
        } 
      });
      selectedObject = null;
      draw();
      updateButtonStates();
    }
    
    // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’æ›´æ–°
    function updateButtonStates() {
        // undo/redoãƒœã‚¿ãƒ³ã¯ã€å†™çœŸç¢ºå®šå¾Œã‹ã¤å±¥æ­´/ã‚„ã‚Šç›´ã—å±¥æ­´ãŒã‚ã‚‹å ´åˆã«æœ‰åŠ¹
        document.getElementById('undoBtn').disabled = !photoConfirmed || decoHistoryIndex <= 0; 
        document.getElementById('redoBtn').disabled = !photoConfirmed || decoHistoryIndex >= decoHistory.length - 1; 
        
        // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£ãƒœã‚¿ãƒ³ã¯ã€é¸æŠä¸­ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã€ã‹ã¤å†™çœŸç¢ºå®šæ¸ˆã¿ã®å ´åˆã«æœ‰åŠ¹
        const hasSelection = !!selectedObject && photoConfirmed; 
        document.getElementById('duplicateBtn').disabled = !hasSelection;
        document.getElementById('deleteBtn').disabled = !hasSelection;
        document.getElementById('bringFrontBtn').disabled = !hasSelection || (hasSelection && editableObjects.indexOf(selectedObject) === editableObjects.length - 1);
        document.getElementById('sendBackBtn').disabled = !hasSelection || (hasSelection && editableObjects.indexOf(selectedObject) === 0);
        
        // æœ€çµ‚çš„ãªã€Œæ±ºå®š â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã¯ã€å†™çœŸç¢ºå®šå¾Œã«æœ‰åŠ¹
        document.getElementById('saveBtn').disabled = !photoConfirmed; 
    }
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»é–¢æ•°
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.imageSmoothingEnabled = true;

      // å†™çœŸã‚’æç”»
      if (uploadedImg) {
        ctx.save();
        ctx.translate(uploadedImg.x, uploadedImg.y);
        ctx.rotate(uploadedImg.rotation);
        // uploadedImg.widthã¨uploadedImg.heightã¯å…ƒã®ç”»åƒã‚µã‚¤ã‚º
        // uploadedImg.scaleã¯ã€å…ƒã®ç”»åƒã‚µã‚¤ã‚ºã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã™ã‚‹éš›ã®å€ç‡
        // drawImageã®ç¬¬3,4å¼•æ•°ã§å®Ÿéš›ã®æç”»ã‚µã‚¤ã‚ºã‚’æŒ‡å®šã™ã‚‹
        ctx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2, uploadedImg.width * uploadedImg.scale, uploadedImg.height * uploadedImg.scale);
        ctx.restore();
      }

      // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æç”»
      editableObjects.forEach(obj => {
        ctx.save();
        ctx.translate(obj.x, obj.y);
        ctx.rotate(obj.rotation);
        // obj.scaleã¯obj.width/heightã«ä¹—ç®—ã•ã‚Œã‚‹ã®ã§ã€drawImageã®ã‚µã‚¤ã‚ºã¯ãã®ã¾ã¾obj.width/heightã‚’ä½¿ç”¨
        if (obj.type === 'text') {
          ctx.font = `${obj.fontSize * obj.scale}px ${obj.font}`; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã«é©ç”¨
          ctx.fillStyle = obj.color;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(obj.text, 0, 0);
        } else if (obj.type === 'image') {
          if (obj.img && obj.img.complete) {
            ctx.drawImage(obj.img, -obj.width / 2, -obj.height / 2, obj.width * obj.scale, obj.height * obj.scale);
          }
        }
        ctx.restore();
      });

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã‚’æœ€å¾Œã«æç”»ï¼ˆæœ€å‰é¢ã«è¡¨ç¤ºï¼‰
      if (templateImg.complete) {
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
      }

      // é¸æŠä¸­ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã®ã¿ãƒãƒ³ãƒ‰ãƒ«ã‚’æç”»
      // ã‹ã¤ã€å†™çœŸãŒç¢ºå®šã•ã‚Œã¦ã„ã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿
      if (selectedObject && photoConfirmed) {
        drawSelectionHandles(selectedObject);
      }
    }

    // é¸æŠãƒãƒ³ãƒ‰ãƒ«ã®æç”»
    function drawSelectionHandles(obj) {
      ctx.save();
      ctx.translate(obj.x, obj.y);
      ctx.rotate(obj.rotation);
      
      let objRenderedWidth;
      let objRenderedHeight;

      if (obj.type === 'text') {
          ctx.save();
          ctx.font = `${obj.fontSize * obj.scale}px ${obj.font}`;
          objRenderedWidth = ctx.measureText(obj.text).width;
          objRenderedHeight = obj.fontSize * obj.scale;
          ctx.restore();
          // ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯é¸æŠæ ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
          objRenderedWidth += textBorderOffset;
          objRenderedHeight += textBorderOffset;
      } else { // image
          objRenderedWidth = obj.width * obj.scale;
          objRenderedHeight = obj.height * obj.scale;
      }
      
      // é¸æŠæ 
      ctx.strokeStyle = '#2196f3'; // æ˜ã‚‹ã„é’
      ctx.lineWidth = 6; // å¤ªã„ç·š
      ctx.setLineDash([15, 10]); // ç‚¹ç·šã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚ˆã‚Šæ˜ç¢ºã«
      ctx.strokeRect(-objRenderedWidth / 2, -objRenderedHeight / 2, objRenderedWidth, objRenderedHeight);
      ctx.setLineDash([]);

      const handles = [
        { x: -objRenderedWidth / 2, y: -objRenderedHeight / 2 },
        { x: objRenderedWidth / 2, y: -objRenderedHeight / 2 },
        { x: objRenderedWidth / 2, y: objRenderedHeight / 2 },
        { x: -objRenderedWidth / 2, y: objRenderedHeight / 2 },
      ];
      ctx.fillStyle = '#2196f3';
      handles.forEach(h => {
        ctx.beginPath();
        ctx.arc(h.x, h.y, selectionHandleSize / 2, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = '#fff'; // ãƒãƒ³ãƒ‰ãƒ«ã®å¢ƒç•Œç·šã‚’ç™½ãã—ã¦è¦‹ã‚„ã™ã
        ctx.lineWidth = 2;
        ctx.stroke();
      });

      // å›è»¢ãƒãƒ³ãƒ‰ãƒ«
      ctx.beginPath();
      ctx.arc(0, -objRenderedHeight / 2 - rotationHandleSize / 2 - 10, rotationHandleSize / 2, 0, 2 * Math.PI); // ä½ç½®ã‚’èª¿æ•´
      ctx.fillStyle = '#f44336'; // èµ¤è‰²
      ctx.fill();
      ctx.strokeStyle = '#fff'; // ãƒãƒ³ãƒ‰ãƒ«ã®å¢ƒç•Œç·šã‚’ç™½ãã—ã¦è¦‹ã‚„ã™ã
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }
    
    // ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ é–¢æ•°
    function addTextToOverlay() {
      const text = document.getElementById('customText').value;
      if (!text) return;
      const font = document.getElementById('fontPicker').value;
      const color = document.getElementById('colorPicker').value;
      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¢ƒç•Œã®ãŸã‚ã«å‚ç…§ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ä½¿ç”¨
      const initialFontSize = 100; // åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
      ctx.font = `${initialFontSize}px ${font}`; 
      const textMetrics = ctx.measureText(text);
      const calculatedWidth = textMetrics.width;
      const calculatedHeight = initialFontSize; 

      const obj = {
        type: 'text',
        text: text,
        font: font,
        color: color,
        x: canvas.width / 2,
        y: canvas.height / 2,
        scale: 1, // ã“ã“ã§ã®ã‚¹ã‚±ãƒ¼ãƒ«ã¯ã€å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºã«å¯¾ã™ã‚‹å€ç‡
        rotation: 0,
        width: calculatedWidth,  // æ¸¬å®šã•ã‚ŒãŸå¹…ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ï¼‰
        height: calculatedHeight, // æ¸¬å®šã•ã‚ŒãŸé«˜ã•ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ï¼‰
        fontSize: initialFontSize, // æç”»ã®ãŸã‚ã®å®Ÿéš›ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºï¼ˆã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ï¼‰
      };
      editableObjects.push(obj);
      selectedObject = obj;
      saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
      draw();
    }
    
    // ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆçµµæ–‡å­—ãƒ»ç”»åƒï¼‰è¿½åŠ é–¢æ•°
    function addStamp(content, isImage = false) {
      let obj;
      if (isImage) {
        const img = new Image();
        img.src = content;
        img.onload = () => {
          // ç”»åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¸­å¿ƒã«é…ç½®ã—ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åã¾ã‚‹ã‚ˆã†ã«åˆæœŸã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨­å®š
          const aspectRatio = img.naturalWidth / img.naturalHeight;
          let initialWidth = canvas.width * 0.2; // ã‚­ãƒ£ãƒ³ãƒã‚¹å¹…ã®20%ã‚’åˆæœŸå¹…ã¨ã™ã‚‹
          let initialHeight = initialWidth / aspectRatio;

          if (initialHeight > canvas.height * 0.2) { // é«˜ã•ãŒã‚­ãƒ£ãƒ³ãƒã‚¹ã®20%ã‚’è¶…ãˆã‚‹å ´åˆã€é«˜ã•åŸºæº–ã§èª¿æ•´
              initialHeight = canvas.height * 0.2;
              initialWidth = initialHeight * aspectRatio;
          }

          obj = {
            type: 'image',
            src: content,
            img: img,
            x: canvas.width / 2,
            y: canvas.height / 2,
            scale: 1, // img.onloadã§èª¿æ•´ã—ãŸã‚µã‚¤ã‚ºã‚’ãã®ã¾ã¾ä½¿ã†ã®ã§ã‚¹ã‚±ãƒ¼ãƒ«ã¯1
            rotation: 0,
            width: initialWidth,  // åˆæœŸæç”»å¹…
            height: initialHeight, // åˆæœŸæç”»é«˜ã•
          };
          editableObjects.push(obj);
          selectedObject = obj;
          saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
          draw();
        };
      } else {
        const initialFontSize = 150; // çµµæ–‡å­—ã®åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
        obj = {
          type: 'text', // çµµæ–‡å­—ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚ã«ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æ‰±ã†
          text: content,
          font: 'sans-serif', // çµµæ–‡å­—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆ
          color: 'black',
          x: canvas.width / 2,
          y: canvas.height / 2,
          scale: 1,
          rotation: 0,
          width: initialFontSize, // ãŠãŠã‚ˆãã®å¹…ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ï¼‰
          height: initialFontSize, // ãŠãŠã‚ˆãã®é«˜ã•ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ï¼‰
          fontSize: initialFontSize, // æç”»ã®ãŸã‚ã®å®Ÿéš›ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºï¼ˆã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ï¼‰
        };
        editableObjects.push(obj);
        selectedObject = obj;
        saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
        draw();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    document.getElementById('addTextBtn').addEventListener('click', addTextToOverlay);
    document.getElementById('undoBtn').addEventListener('click', undo);
    document.getElementById('redoBtn').addEventListener('click', redo);
    document.getElementById('duplicateBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const newObj = JSON.parse(JSON.stringify(selectedObject));
      newObj.x += 50;
      newObj.y += 50;
      if (newObj.type === 'image') {
        const img = new Image();
        img.src = newObj.src;
        newObj.img = img;
        img.onload = draw; // æ–°ã—ã„ç”»åƒãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«å†æç”»ã‚’ä¿è¨¼
      }
      editableObjects.push(newObj);
      selectedObject = newObj;
      saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
      draw();
    });
    document.getElementById('deleteBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const index = editableObjects.indexOf(selectedObject);
      if (index > -1) {
        editableObjects.splice(index, 1);
        selectedObject = null;
        saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
        draw();
      }
    });
    document.getElementById('bringFrontBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const index = editableObjects.indexOf(selectedObject);
      if (index > -1 && index < editableObjects.length - 1) {
        const obj = editableObjects.splice(index, 1)[0];
        editableObjects.push(obj);
        saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
        draw();
      }
    });
    document.getElementById('sendBackBtn').addEventListener('click', () => {
      if (!selectedObject) return;
      const index = editableObjects.indexOf(selectedObject);
      if (index > 0) {
        const obj = editableObjects.splice(index, 1)[0];
        editableObjects.unshift(obj);
        saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
        draw();
      }
    });
    document.getElementById('fontPicker').addEventListener('change', (e) => {
        if (selectedObject && selectedObject.type === 'text') {
            selectedObject.font = e.target.value;
            draw();
            saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
        }
    });
    document.getElementById('colorPicker').addEventListener('input', (e) => {
        if (selectedObject && selectedObject.type === 'text') {
            selectedObject.color = e.target.value;
            draw();
            saveDecoState(); // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã«ä¿å­˜
        }
    });
    
    // ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);
    canvas.addEventListener('mouseleave', handleMouseUp); // ã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ã§ãƒã‚¦ã‚¹ã‚’é›¢ã—ãŸå ´åˆ
    canvas.addEventListener('wheel', handleMouseWheel); // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã®å†™çœŸã‚ºãƒ¼ãƒ ç”¨
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd);
    canvas.addEventListener('touchcancel', handleTouchEnd);
    
    // ãƒã‚¦ã‚¹åº§æ¨™ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«å¤‰æ›
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      // CSSã§è¨­å®šã•ã‚ŒãŸã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨ã€å®Ÿéš›ã®å†…éƒ¨æç”»ã‚µã‚¤ã‚ºã¨ã®æ¯”ç‡ã‚’è¨ˆç®—
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
      };
    }
    
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‹ã©ã†ã‹ï¼‰
    function hitTest(obj, x, y) {
      const p = { x, y };
      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å›è»¢ã‚’é€†ã«ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯åº§æ¨™ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ã«å¤‰æ›
      const cos = Math.cos(-obj.rotation);
      const sin = Math.sin(-obj.rotation);
      const translatedX = p.x - obj.x;
      const translatedY = p.y - obj.y;
      const rotatedX = translatedX * cos - translatedY * sin;
      const rotatedY = translatedX * sin + translatedY * cos;
      
      let objRenderedWidth;
      let objRenderedHeight;

      if (obj.type === 'text') {
          ctx.save();
          ctx.font = `${obj.fontSize * obj.scale}px ${obj.font}`;
          objRenderedWidth = ctx.measureText(obj.text).width;
          objRenderedHeight = obj.fontSize * obj.scale; // ãƒ†ã‚­ã‚¹ãƒˆã®é«˜ã•ã¯ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¨ã™ã‚‹
          ctx.restore();
          // ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯ã€é¸æŠæ ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚‚è€ƒæ…®
          return rotatedX >= -objRenderedWidth / 2 - textBorderOffset / 2 && rotatedX <= objRenderedWidth / 2 + textBorderOffset / 2 && rotatedY >= -objRenderedHeight / 2 - textBorderOffset / 2 && rotatedY <= objRenderedHeight / 2 + textBorderOffset / 2;
      } else { // image
          objRenderedWidth = obj.width * obj.scale;
          objRenderedHeight = obj.height * obj.scale;
          return rotatedX >= -objRenderedWidth / 2 && rotatedX <= objRenderedWidth / 2 && rotatedY >= -objRenderedHeight / 2 && rotatedY <= objRenderedHeight / 2;
      }
    }

    // ãƒãƒ³ãƒ‰ãƒ«ã®ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆãƒªã‚µã‚¤ã‚ºãƒ»å›è»¢ãƒãƒ³ãƒ‰ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‹ã©ã†ã‹ï¼‰
    function getHandleHit(obj, x, y) {
        if (!obj) return null;
        const p = { x, y };
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å›è»¢ã‚’é€†ã«ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯åº§æ¨™ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ã«å¤‰æ›
        const cos = Math.cos(-obj.rotation);
        const sin = Math.sin(-obj.rotation);
        const translatedX = p.x - obj.x;
        const translatedY = p.y - obj.y;
        const rotatedX = translatedX * cos - translatedY * sin;
        const rotatedY = translatedX * sin + translatedY * cos;
        
        let objRenderedWidth;
        let objRenderedHeight;
        if (obj.type === 'text') {
            ctx.save();
            ctx.font = `${obj.fontSize * obj.scale}px ${obj.font}`;
            objRenderedWidth = ctx.measureText(obj.text).width;
            objRenderedHeight = obj.fontSize * obj.scale;
            ctx.restore();
            // ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯é¸æŠæ ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚‚è€ƒæ…®
            objRenderedWidth += textBorderOffset;
            objRenderedHeight += textBorderOffset;
        } else {
            objRenderedWidth = obj.width * obj.scale;
            objRenderedHeight = obj.height * obj.scale;
        }
        
        const handles = [
            { x: -objRenderedWidth / 2, y: -objRenderedHeight / 2 }, // Top-left
            { x: objRenderedWidth / 2, y: -objRenderedHeight / 2 },  // Top-right
            { x: objRenderedWidth / 2, y: objRenderedHeight / 2 },    // Bottom-right
            { x: -objRenderedWidth / 2, y: objRenderedHeight / 2 },  // Bottom-left
        ];
        for (let i = 0; i < handles.length; i++) {
            // ãƒãƒ³ãƒ‰ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‹ã©ã†ã‹ã®è·é›¢åˆ¤å®š
            if (Math.hypot(rotatedX - handles[i].x, rotatedY - handles[i].y) < selectionHandleSize / 2) {
                return 'resize';
            }
        }
        
        // å›è»¢ãƒãƒ³ãƒ‰ãƒ«ã®ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆä½ç½®èª¿æ•´æ¸ˆã¿ï¼‰
        if (Math.hypot(rotatedX, rotatedY - (-objRenderedHeight / 2 - rotationHandleSize / 2 - 10)) < rotationHandleSize / 2) {
            return 'rotate';
        }
        return null;
    }
    
    // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    function handleMouseDown(e) {
      e.preventDefault();
      const pos = getMousePos(e);
      let hitSomething = false; // ä½•ã‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ’ãƒƒãƒˆã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

      if (photoConfirmed) { // å†™çœŸãŒç¢ºå®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ“ä½œ
          for (let i = editableObjects.length - 1; i >= 0; i--) { // å¾Œã‚ã‹ã‚‰ï¼ˆå‰é¢ã‹ã‚‰ï¼‰ãƒã‚§ãƒƒã‚¯
            const obj = editableObjects[i];
            if (hitTest(obj, pos.x, pos.y)) {
              selectedObject = obj;
              const handleType = getHandleHit(selectedObject, pos.x, pos.y);
              dragMode = handleType || 'move'; // ãƒãƒ³ãƒ‰ãƒ«ã§ãªã‘ã‚Œã°ç§»å‹•ãƒ¢ãƒ¼ãƒ‰
              hitSomething = true;
              // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æœ€å‰é¢ã«ç§»å‹•
              editableObjects.splice(i, 1);
              editableObjects.push(selectedObject);
              break;
            }
          }
          if (!hitSomething) { // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ä½•ã‚‚ãªã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯
              selectedObject = null;
              dragMode = null;
          }
      } else { // å†™çœŸãŒæœªç¢ºå®šã®å ´åˆã®ã¿ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸã‚’æ“ä½œ
          if (uploadedImg && hitTest(uploadedImg, pos.x, pos.y)) {
              selectedObject = null; // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é¸æŠã‚’è§£é™¤
              dragMode = 'move_photo';
              hitSomething = true;
              startPoint = { x: pos.x, y: pos.y };
              startObjectState = { x: uploadedImg.x, y: uploadedImg.y, scale: uploadedImg.scale, rotation: uploadedImg.rotation };
          } else { // å†™çœŸãƒ¢ãƒ¼ãƒ‰ã§ä½•ã‚‚ãªã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯
              selectedObject = null;
              dragMode = null;
          }
      }
      draw();
      updateButtonStates();
    }
    
    // ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ
    function handleMouseMove(e) {
      e.preventDefault();
      const pos = getMousePos(e);
      
      // ãƒ›ãƒãƒ¼æ™‚ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ›´æ–°
      if (!dragMode) {
          let cursor = 'default';
          if (photoConfirmed) { // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰
              for (let i = editableObjects.length - 1; i >= 0; i--) {
                  const obj = editableObjects[i];
                  if (hitTest(obj, pos.x, pos.y)) {
                      const handleType = getHandleHit(obj, pos.x, pos.y);
                      cursor = handleType === 'resize' ? 'nwse-resize' : (handleType === 'rotate' ? 'crosshair' : 'grab');
                      break;
                  }
              }
          } else { // å†™çœŸç·¨é›†ãƒ¢ãƒ¼ãƒ‰
              if (uploadedImg && hitTest(uploadedImg, pos.x, pos.y)) {
                  cursor = 'grab';
              }
          }
          canvas.style.cursor = cursor;
          return;
      }

      const dx = pos.x - startPoint.x;
      const dy = pos.y - startPoint.y;

      if (dragMode === 'move' && selectedObject) {
        selectedObject.x = startObjectState.x + dx;
        selectedObject.y = startObjectState.y + dy;
      } else if (dragMode === 'move_photo' && uploadedImg && !photoConfirmed) { // å†™çœŸãŒæœªç¢ºå®šã®å ´åˆã®ã¿ç§»å‹•
        uploadedImg.x = startObjectState.x + dx;
        uploadedImg.y = startObjectState.y + dy;
      } else if (dragMode === 'resize' && selectedObject) {
        const currentCenter = { x: selectedObject.x, y: selectedObject.y };
        const angle = selectedObject.rotation;

        // ãƒªã‚µã‚¤ã‚ºè¨ˆç®—ã®ãŸã‚ã«ãƒã‚¦ã‚¹ä½ç½®ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã«å›è»¢
        const rotatedMouseX = (pos.x - currentCenter.x) * Math.cos(-angle) - (pos.y - currentCenter.y) * Math.sin(-angle);
        const rotatedMouseY = (pos.x - currentCenter.x) * Math.sin(-angle) + (pos.y - currentCenter.y) * Math.cos(-angle);
        
        let originalObjWidth, originalObjHeight;
        if (selectedObject.type === 'text') {
            ctx.save();
            ctx.font = `${selectedObject.fontSize}px ${selectedObject.font}`;
            originalObjWidth = ctx.measureText(selectedObject.text).width;
            originalObjHeight = selectedObject.fontSize;
            ctx.restore();
            // ãƒªã‚µã‚¤ã‚ºè¨ˆç®—æ™‚ã‚‚ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è€ƒæ…®ã«å…¥ã‚Œã‚‹
            originalObjWidth += textBorderOffset;
            originalObjHeight += textBorderOffset;
        } else {
            originalObjWidth = selectedObject.width;
            originalObjHeight = selectedObject.height;
        }
        
        // ãƒªã‚µã‚¤ã‚ºã¯ä¸­å¿ƒã‹ã‚‰ã®ç›¸å¯¾è·é›¢ã§è¨ˆç®—ã—ã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¤
        // ãƒã‚¦ã‚¹ä½ç½®ã‹ã‚‰ä¸­å¿ƒã¾ã§ã®è·é›¢ã‚’è¨ˆç®—ã—ã€ãã‚Œã‚’å…ƒã®ã‚µã‚¤ã‚ºã®åŠåˆ†ã¨æ¯”è¼ƒ
        const distFromCenter = Math.hypot(rotatedMouseX, rotatedMouseY);
        const originalHalfDiagonal = Math.hypot(originalObjWidth / 2, originalObjHeight / 2);
        
        let newScale = 1;
        if (originalHalfDiagonal > 0) { // ã‚¼ãƒ­é™¤ç®—ã‚’é¿ã‘ã‚‹
            newScale = distFromCenter / originalHalfDiagonal;
        }

        // æœ€å°ãƒ»æœ€å¤§ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨­å®š
        selectedObject.scale = Math.max(0.1, Math.min(5, newScale)); 

      } else if (dragMode === 'rotate' && selectedObject) {
        const angleStart = Math.atan2(startPoint.y - selectedObject.y, startPoint.x - selectedObject.x);
        const angleCurrent = Math.atan2(pos.y - selectedObject.y, pos.x - selectedObject.x);
        selectedObject.rotation = startObjectState.rotation + (angleCurrent - angleStart);
      }
      draw();
    }
    
    // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
    function handleMouseUp(e) {
      // å†™çœŸç¢ºå®šãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚Œã°ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å±¥æ­´ã‚’ä¿å­˜
      if (photoConfirmed && (dragMode === 'move' || dragMode === 'resize' || dragMode === 'rotate')) {
          saveDecoState();
      } else if (!photoConfirmed && dragMode === 'move_photo') {
          // å†™çœŸç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å¤‰æ›´ã¯å€‹åˆ¥ã®Undo/Redoæ©Ÿèƒ½ã‚’æŒãŸãªã„ãŒã€çŠ¶æ…‹ã¯æ›´æ–°ã•ã‚Œã‚‹
          // savePhotoEditState(); // ã“ã“ã§ã¯å±¥æ­´ä¿å­˜ã¯ä¸è¦
      }
      dragMode = null;
      canvas.style.cursor = 'default';
    }

    // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå†™çœŸã®ã‚ºãƒ¼ãƒ ç”¨ï¼‰
    function handleMouseWheel(e) {
      if (!uploadedImg || photoConfirmed) return; // å†™çœŸãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã€ã‹ã¤æœªç¢ºå®šã®å ´åˆã®ã¿ã‚ºãƒ¼ãƒ 
      e.preventDefault();
      const oldScale = uploadedImg.scale;
      const zoomFactor = 1.05; // ã‚ºãƒ¼ãƒ é€Ÿåº¦ã‚’èª¿æ•´
      const newScale = e.deltaY < 0 ? oldScale * zoomFactor : oldScale / zoomFactor;
      uploadedImg.scale = Math.max(0.1, Math.min(5, newScale));

      // ã‚ºãƒ¼ãƒ ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã®ä¸­å¿ƒãŒãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´
      const mousePos = getMousePos(e);
      const scaleRatio = uploadedImg.scale / oldScale;
      uploadedImg.x = mousePos.x - ((mousePos.x - uploadedImg.x) * scaleRatio);
      uploadedImg.y = mousePos.y - ((mousePos.y - uploadedImg.y) * scaleRatio);

      draw();
    }

    let lastTouch = null;
    let touchStartStates = {}; // ãƒãƒ«ãƒã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹

    // ã‚¿ãƒƒãƒã‚¹ã‚¿ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
    function handleTouchStart(e) {
      e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ã‚ºãƒ¼ãƒ ã‚’é˜²ã
      const touches = e.touches;

      if (touches.length === 1) {
        const pos = getMousePos(touches[0]);
        let hitSomething = false;

        if (photoConfirmed) { // å†™çœŸãŒç¢ºå®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ“ä½œ
            for (let i = editableObjects.length - 1; i >= 0; i--) {
                const obj = editableObjects[i];
                if (hitTest(obj, pos.x, pos.y)) {
                    selectedObject = obj;
                    const handleType = getHandleHit(selectedObject, pos.x, pos.y);
                    dragMode = handleType || 'move';
                    hitSomething = true;
                    // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æœ€å‰é¢ã«ç§»å‹•
                    editableObjects.splice(i, 1);
                    editableObjects.push(selectedObject);
                    break;
                }
            }
            if (!hitSomething) {
                selectedObject = null;
                dragMode = null;
            }
        } else { // å†™çœŸãŒæœªç¢ºå®šã®å ´åˆã®ã¿ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸã‚’æ“ä½œ
            if (uploadedImg && hitTest(uploadedImg, pos.x, pos.y)) {
                selectedObject = null;
                dragMode = 'move_photo';
                hitSomething = true;
                startPoint = { x: pos.x, y: pos.y };
                startObjectState = { x: uploadedImg.x, y: uploadedImg.y, scale: uploadedImg.scale, rotation: uploadedImg.rotation };
            } else {
                selectedObject = null;
                dragMode = null;
            }
        }
        draw();
        updateButtonStates();

      } else if (touches.length === 2) {
        // ãƒãƒ«ãƒã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
        lastTouch = touches;
        let targetObjectForMultiTouch = null;

        if (!photoConfirmed && uploadedImg) {
            targetObjectForMultiTouch = uploadedImg;
        } else if (photoConfirmed && selectedObject) {
            targetObjectForMultiTouch = selectedObject;
        }

        if (targetObjectForMultiTouch) {
            touchStartStates = {
                scale: targetObjectForMultiTouch.scale,
                rotation: targetObjectForMultiTouch.rotation,
                x: targetObjectForMultiTouch.x,
                y: targetObjectForMultiTouch.y,
                p1: getMousePos(touches[0]),
                p2: getMousePos(touches[1]),
            };
            touchStartStates.initialMidX = (touchStartStates.p1.x + touchStartStates.p2.x) / 2;
            touchStartStates.initialMidY = (touchStartStates.p1.y + touchStartStates.p2.y) / 2;
            touchStartStates.initialDist = Math.hypot(touchStartStates.p2.x - touchStartStates.p1.x, touchStartStates.p2.y - touchStartStates.p1.y);
            touchStartStates.initialAngle = Math.atan2(touchStartStates.p2.y - touchStartStates.p1.y, touchStartStates.p2.x - touchStartStates.p1.x);
        }
      }
    }

    // ã‚¿ãƒƒãƒãƒ ãƒ¼ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ
    function handleTouchMove(e) {
      e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ã‚ºãƒ¼ãƒ ã‚’é˜²ã
      const touches = e.touches;

      if (touches.length === 1 && dragMode) {
        const pos = getMousePos(touches[0]);
        // ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨
        // touchStartStatesã®dragModeã«å¯¾å¿œã™ã‚‹åˆæœŸçŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆ
        if (!startObjectState && selectedObject && (dragMode === 'move' || dragMode === 'resize' || dragMode === 'rotate')) {
            startObjectState = { 
                x: selectedObject.x, 
                y: selectedObject.y, 
                scale: selectedObject.scale, 
                rotation: selectedObject.rotation 
            };
            startPoint = { x: pos.x, y: pos.y };
        } else if (!startObjectState && uploadedImg && dragMode === 'move_photo') {
            startObjectState = { 
                x: uploadedImg.x, 
                y: uploadedImg.y, 
                scale: uploadedImg.scale, 
                rotation: uploadedImg.rotation 
            };
            startPoint = { x: pos.x, y: pos.y };
        }
        handleMouseMove({ preventDefault: () => {}, clientX: pos.x, clientY: pos.y });

      } else if (touches.length === 2 && lastTouch) {
        const p1 = getMousePos(touches[0]);
        const p2 = getMousePos(touches[1]);
        
        const currentMidX = (p1.x + p2.x) / 2;
        const currentMidY = (p1.y + p2.y) / 2;
        const currentDist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
        const currentAngle = Math.atan2(p2.y - p1.y, p2.x - p1.x);

        let targetObject = null;
        if (!photoConfirmed && uploadedImg) {
            targetObject = uploadedImg;
        } else if (photoConfirmed && selectedObject) {
            targetObject = selectedObject;
        }

        if (targetObject && touchStartStates.initialDist !== undefined) { // touchStartStatesãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒ)
            if (touchStartStates.initialDist > 0) { // ã‚¼ãƒ­é™¤ç®—ã‚’é¿ã‘ã‚‹
                targetObject.scale = touchStartStates.scale * (currentDist / touchStartStates.initialDist);
                targetObject.scale = Math.max(0.1, Math.min(5, targetObject.scale));
            }

            // å›è»¢
            targetObject.rotation = touchStartStates.rotation + (currentAngle - touchStartStates.initialAngle);
            
            // ãƒ‘ãƒ³ï¼ˆç§»å‹•ï¼‰
            // ã‚ºãƒ¼ãƒ ã¨å›è»¢ã®ä¸­å¿ƒã‚’è€ƒæ…®ã—ãŸãƒ‘ãƒ³
            // ãƒãƒ«ãƒã‚¿ãƒƒãƒã®ä¸­å¿ƒãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­å¿ƒã‹ã‚‰ã©ã‚Œã ã‘ç§»å‹•ã—ãŸã‹ã‚’è¨ˆç®—
            const deltaMidX = currentMidX - touchStartStates.initialMidX;
            const deltaMidY = currentMidY - touchStartStates.initialMidY;
            
            targetObject.x = touchStartStates.x + deltaMidX;
            targetObject.y = touchStartStates.y + deltaMidY;
            
            draw();
            lastTouch = touches;
        }
      }
    }
    
    // ã‚¿ãƒƒãƒã‚¨ãƒ³ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
    function handleTouchEnd(e) {
      // æŒ‡ãŒé›¢ã‚ŒãŸæ™‚ã€ä½•ã‹ã—ã‚‰ã®æ“ä½œãƒ¢ãƒ¼ãƒ‰ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚ã‚Œã°å±¥æ­´ã‚’ä¿å­˜
      if (photoConfirmed && (dragMode === 'move' || dragMode === 'resize' || dragMode === 'rotate')) { // ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã®å˜ä¸€ã‚¿ãƒƒãƒæ“ä½œ
          saveDecoState();
      } else if (!photoConfirmed && dragMode === 'move_photo') { // å†™çœŸç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã®å˜ä¸€ã‚¿ãƒƒãƒæ“ä½œ
          // å†™çœŸç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å¤‰æ›´ã¯å€‹åˆ¥ã®Undo/Redoæ©Ÿèƒ½ã‚’æŒãŸãªã„
      } else if (e.touches.length === 0 && lastTouch) { // å…¨ã¦ã®æŒ‡ãŒé›¢ã‚ŒãŸå ´åˆï¼ˆãƒãƒ«ãƒã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®çµ‚äº†ï¼‰
          if (photoConfirmed && selectedObject) {
              saveDecoState();
          }
      }

      dragMode = null;
      lastTouch = null;
      touchStartStates = {}; // ãƒãƒ«ãƒã‚¿ãƒƒãƒçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      startObjectState = null; // å˜ä¸€ã‚¿ãƒƒãƒæ“ä½œã®é–‹å§‹çŠ¶æ…‹ã‚‚ã‚¯ãƒªã‚¢
      updateButtonStates();
    }
    
    // æœ€çµ‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆãƒœã‚¿ãƒ³
    document.getElementById('saveBtn').addEventListener('click', () => {
      const noticeEl = document.getElementById('notice');
      if (!uploadedImg) {
        noticeEl.textContent = saveWarningTexts[currentLang] || saveWarningTexts['ja'];
        noticeEl.style.color = 'red';
        noticeEl.style.display = 'block';
        setTimeout(() => { noticeEl.textContent = ''; noticeEl.style.display = 'none'; }, 3000);
        return;
      }
      
      const combinedCanvas = document.createElement('canvas');
      combinedCanvas.width = canvas.width;
      combinedCanvas.height = canvas.height;
      const combinedCtx = combinedCanvas.getContext('2d');
      combinedCtx.imageSmoothingEnabled = true;

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’æç”»
      if (uploadedImg) {
        combinedCtx.save();
        combinedCtx.translate(uploadedImg.x, uploadedImg.y);
        combinedCtx.rotate(uploadedImg.rotation);
        combinedCtx.scale(uploadedImg.scale, uploadedImg.scale);
        combinedCtx.drawImage(uploadedImg, -uploadedImg.width / 2, -uploadedImg.height / 2);
        combinedCtx.restore();
      }
      
      // ç·¨é›†å¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã€çµµæ–‡å­—ã€ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ï¼‰ã‚’æç”»
      editableObjects.forEach(obj => {
        combinedCtx.save();
        combinedCtx.translate(obj.x, obj.y);
        combinedCtx.rotate(obj.rotation);
        combinedCtx.scale(obj.scale, obj.scale);
        if (obj.type === 'text') {
          combinedCtx.font = `${obj.fontSize}px ${obj.font}`;
          combinedCtx.fillStyle = obj.color;
          combinedCtx.textAlign = 'center';
          combinedCtx.textBaseline = 'middle';
          combinedCtx.fillText(obj.text, 0, 0);
        } else if (obj.type === 'image') {
          if (obj.img && obj.img.complete) {
            combinedCtx.drawImage(obj.img, -obj.width / 2, -obj.height / 2, obj.width, obj.height);
          }
        }
        combinedCtx.restore();
      });

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã‚’æœ€å¾Œã«æç”»ï¼ˆæœ€å‰é¢ã«è¡¨ç¤ºï¼‰
      if (templateImg.complete) {
        combinedCtx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
      }
      
      combinedCanvas.toBlob(blob => {
        const errorTexts = {
          ja: 'ç”»åƒä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
          en: 'Failed to create image. Please try again.',
          zh: 'ç”Ÿæˆå›¾åƒå¤±è´¥ã€‚è¯·å†è¯•ä¸€æ¬¡ã€‚',
          ko: 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”ã€‚',
          vi: 'Táº¡o hÃ¬nh áº£nh tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡iã€‚'
        };
        if (!blob) {
          noticeEl.textContent = errorTexts[currentLang] || errorTexts['ja'];
          noticeEl.style.color = 'red';
          return;
        }
        if (window._lastPreviewURL) {
          try { URL.revokeObjectURL(window._lastPreviewURL); } catch (e) {}
          window._lastPreviewURL = null;
        }
        const url = URL.createObjectURL(blob);
        window._lastPreviewURL = url;
        const previewWrapper = document.getElementById('previewWrapper');
        const previewImg = document.getElementById('previewImage');
        previewImg.src = url;
        previewWrapper.style.display = 'block';
        const previewNotice = document.getElementById('previewNotice');
        const previewNoticeTexts = {
          ja: `iPhoneï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œâ€œå†™çœŸâ€ã«è¿½åŠ ã€ã‚’é¸ã‚“ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br><br>Androidï¼šç”»åƒã‚’ğŸ‘†é•·æŠ¼ã—ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><br>ä¿å­˜ã§ããŸã‚‰ä¸‹ã®ã€Œæ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç”³è¾¼ã¸ãŠé€²ã¿ãã ã•ã„ã€‚`,
          en: `iPhone: Press and hold ğŸ‘† the image, then select "Add to Photos" to save.<br><br>Android: Press and hold ğŸ‘† the image, then select "Save Image".<br><br>After saving, proceed to the order form below.`,
          zh: `iPhoneï¼šé•¿æŒ‰ğŸ‘†å›¾ç‰‡ï¼Œç„¶åé€‰æ‹©â€œæ·»åŠ åˆ°ç…§ç‰‡â€è¿›è¡Œä¿å­˜ã€‚<br><br>Androidï¼šé•¿æŒ‰ğŸ‘†å›¾ç‰‡ï¼Œç„¶åé€‰æ‹©â€œä¿å­˜å›¾ç‰‡â€ã€‚<br><br>ä¿å­˜åï¼Œè¯·ç‚¹å‡»ä¸‹é¢çš„â€œå‰å¾€è®¢å•è¡¨å•â€ã€‚`,
          ko: `iPhone: ì´ë¯¸ì§€ë¥¼ ğŸ‘† ê¸¸ê²Œ ëˆŒëŸ¬ "ì‚¬ì§„ì— ì¶”ê°€"ë¥¼ ì„ íƒí•˜ì„¸ìš”ã€‚<br><br>Android: ì´ë¯¸ì§€ë¥¼ ğŸ‘† ê¸¸ê²Œ ëˆŒëŸ¬ "ì´ë¯¸ì§€ ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”ã€‚<br><br>ì €ì¥ í›„ ì•„ë˜ì˜ "ì£¼ë¬¸ ì–‘ì‹ìœ¼ë¡œ ì´ë™" ãƒœã‚¿ãƒ³ã‚’ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”ã€‚`,
          vi: `iPhone: Nháº¥n vÃ  giá»¯ ğŸ‘† hÃ¬nh, chá»n "ThÃªm vÃ o áº¢nh" Ä‘á»ƒ lÆ°u.<br><br>Android: Nháº¥n vÃ  giá»¯ ğŸ‘† hÃ¬nh, chá»n "LÆ°u hÃ¬nh áº£nh".<br><br>Sau khi lÆ°u, hÃ£y báº¥m nÃºt "Äi tá»›i Form Ä‘áº·t hÃ ng" bÃªn dÆ°á»›iã€‚`
        };
        previewNotice.innerHTML = previewNoticeTexts[currentLang] || previewNoticeTexts['ja'];
        previewWrapper.scrollIntoView({ behavior: 'smooth' });
      }, 'image/png');
    });

    // è¨€èªè¨­å®šé–¢æ•°
    function setLanguage(lang) {
      currentLang = lang;
      document.querySelectorAll('[data-ja]').forEach(el => {
        if (el.dataset[lang]) {
          if (el.tagName === "OPTION" || el.tagName === "BUTTON" || el.tagName === "LABEL") {
            el.textContent = el.dataset[lang];
          } else {
            el.innerHTML = el.dataset[lang];
          }
        }
      });
    }

    // æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã‚€ãƒœã‚¿ãƒ³
    document.getElementById('go-to-form').addEventListener('click', function () {
        window.location.href = "https://docs.google.com/forms/d/e/1FAIpQLSf1wV724Vnag4FCcjeU1z-3vaCcfhCjAvGyU8432bu8dyciow/viewform";
        setTimeout(() => { document.getElementById('manual-link').style.display = 'block'; }, 5000);
    });
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–å‡¦ç†
    window.addEventListener('load', () => {
      const userLang = navigator.language || navigator.userLanguage;
      if (userLang.startsWith('en')) setLanguage('en');
      else if (userLang.startsWith('zh')) setLanguage('zh');
      else if (userLang.startsWith('ko')) setLanguage('ko');
      else if (userLang.startsWith('vi')) setLanguage('vi');
      else setLanguage('ja');
      
      // åˆæœŸçŠ¶æ…‹ã§ã¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–ã—ã€å†™çœŸç¢ºå®šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      setDecorationControlsEnabled(false); 
      confirmPhotoBtn.style.display = 'none'; 
      reEditPhotoBtn.style.display = 'none'; // å†™çœŸå†ç·¨é›†ãƒœã‚¿ãƒ³ã‚‚æœ€åˆã¯éè¡¨ç¤º
      
      // åˆæœŸçŠ¶æ…‹ã®å±¥æ­´ã‚’ä¿å­˜ï¼ˆå†™çœŸãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ï¼‰
      // decoHistoryã¯åˆæœŸçŠ¶æ…‹ã§ã¯ç©º
      // saveDecoState(); // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã¯å†™çœŸãŒç¢ºå®šã•ã‚Œã¦ã„ãªã„ãŸã‚å‘¼ã³å‡ºã•ãªã„
    });

    // ã€Œä½¿ã„æ–¹ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
    document.getElementById('howToBtn').addEventListener('click', () => {
      document.getElementById('howToModal').style.display = 'flex';
    });
  </script>
  <script src="https://www.line-website.com/social-plugins/js/thirdparty/loader.min.js"></script>
</body>
</html>